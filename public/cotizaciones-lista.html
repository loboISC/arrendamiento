<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LISTA DE COTIZACIONES - ANDAMIOS TORRES</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet" href="theme-dark.css">
  <script src="theme.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/cotizaciones.js"></script>
  <!-- SweetAlert2 para notificaciones visuales -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      margin: 0;
      background: #f5f7fa;
      font-family: 'Segoe UI', Arial, sans-serif;
      color: #222;
    }

    .header {
      background: #263445;
      color: #fff;
      padding: 18px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 12px #26344522;
    }

    .header h1 {
      margin: 0;
      font-size: 2rem;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header h1 i {
      font-size: 1.3em;
      color: #4fc3f7;
    }

    .back-btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 8px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: background 0.2s;
    }

    .back-btn:hover {
      background: #217dbb;
    }

    .container {
      max-width: 1200px;
      margin: 32px auto 0 auto;
      padding: 0 20px;
    }

    .filters {
      background: #fff;
      border-radius: 12px;
      padding: 28px 24px 18px 24px;
      margin-bottom: 28px;
      box-shadow: 0 2px 16px #2979ff11;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .filters h3 {
      margin: 0;
      color: #263445;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filters-row {
      display: flex;
      gap: 18px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 7px;
      min-width: 160px;
    }

    .filter-group label {
      font-weight: 600;
      font-size: 1rem;
      color: #263445;
    }

    .filter-group input,
    .filter-group select {
      padding: 10px 14px;
      border: 1.5px solid #e0e0e0;
      border-radius: 6px;
      font-size: 15px;
      background: #f8f9fa;
      transition: border 0.2s;
    }

    .filter-group input:focus,
    .filter-group select:focus {
      border: 1.5px solid #3498db;
      outline: none;
    }

    .btn-primary {
      background: #3498db;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 2px 8px #3498db22;
      transition: background 0.2s, box-shadow 0.2s;
    }

    .btn-primary:hover {
      background: #217dbb;
      box-shadow: 0 4px 16px #3498db33;
    }

    .btn-success {
      background: #27ae60;
      color: white;
      border: none;
      padding: 10px 22px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.05rem;
      font-weight: 700;
      box-shadow: 0 2px 8px #27ae6022;
      transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
      margin-top: 2px;
    }

    .btn-success:hover {
      background: #219150;
      transform: translateY(-2px) scale(1.04);
      box-shadow: 0 4px 16px #27ae6033;
    }

    .cotizaciones-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 16px #26344511;
      overflow: hidden;
      margin-top: 18px;
    }

    .cotizaciones-table thead {
      background: #f5f7fa;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .cotizaciones-table th,
    .cotizaciones-table td {
      padding: 16px 12px;
      text-align: left;
      font-size: 1.04rem;
    }

    .cotizaciones-table th {
      color: #263445;
      font-weight: 700;
      border-bottom: 2px solid #e0e0e0;
      background: #f5f7fa;
    }

    .cotizaciones-table tbody tr {
      transition: background 0.18s;
    }

    .cotizaciones-table tbody tr:hover {
      background: #e3f2fd55;
    }

    .cotizaciones-table td {
      border-bottom: 1px solid #f0f0f0;
      color: #263445;
    }

    .cotizaciones-table td:last-child {
      white-space: nowrap;
    }

    .tag {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.98rem;
      font-weight: 600;
      margin-right: 4px;
      margin-bottom: 2px;
      letter-spacing: 0.2px;
    }

    .tag-media {
      background: #ffe082;
      color: #b28900;
    }

    .tag-alta {
      background: #ffb3b3;
      color: #c0392b;
    }

    .tag-urgente {
      background: #ff5252;
      color: #fff;
    }

    .tag-baja {
      background: #b2dfdb;
      color: #00695c;
    }

    .tag-aprobada {
      background: #c8f7c5;
      color: #27ae60;
    }

    .tag-pendiente {
      background: #fff3cd;
      color: #b7950b;
    }

    .tag-rechazada {
      background: #ffd6d6;
      color: #c0392b;
    }

    .tag-enviada {
      background: #b3e5fc;
      color: #0277bd;
    }

    .tag-revisada {
      background: #e1bee7;
      color: #6a1b9a;
    }

    .tag-contrato {
      background: #d1c4e9;
      color: #512da8;
    }

    .acciones-btn {
      border: none;
      background: none;
      cursor: pointer;
      margin: 0 2px;
      font-size: 1.15rem;
      padding: 7px 9px;
      border-radius: 6px;
      transition: background 0.18s, color 0.18s, transform 0.1s;
      position: relative;
    }

    .acciones-btn:hover {
      background: #e3f2fd;
      color: #1976d2;
      transform: scale(1.13);
    }

    .acciones-btn[title]:hover:after {
      content: attr(title);
      position: absolute;
      left: 50%;
      top: -32px;
      transform: translateX(-50%);
      background: #263445;
      color: #fff;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 0.95rem;
      white-space: nowrap;
      z-index: 10;
      opacity: 0.95;
      pointer-events: none;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 10px;
      max-width: 900px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }

    .notas-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }

    .notas-section h4 {
      margin-top: 0;
      color: #2c3e50;
    }

    @media (max-width: 900px) {
      .container {
        padding: 0 6px;
      }

      .filters {
        padding: 18px 6px 10px 6px;
      }

      .cotizaciones-table th,
      .cotizaciones-table td {
        padding: 10px 6px;
        font-size: 0.98rem;
      }
    }

    @media (max-width: 600px) {
      .filters-row {
        flex-direction: column;
        gap: 10px;
      }

      .header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }

      .container {
        margin-top: 12px;
      }

      .cotizaciones-table th,
      .cotizaciones-table td {
        font-size: 0.93rem;
      }
    }
  </style>
</head>

<body>
  <div class="header">
    <h1><i class="fa fa-file-lines"></i> Cotizaciones</h1>
    <button class="back-btn" id="btn-volver" onclick="volverAlOrigen()">
      <i class="fa fa-arrow-left"></i> Volver
    </button>
  </div>

  <script>
    // Funci√≥n para volver al origen correcto
    function volverAlOrigen() {
      const urlParams = new URLSearchParams(window.location.search);
      const from = urlParams.get('from'); // P√°gina de origen
      const tipo = urlParams.get('tipo'); // Tipo de cotizaci√≥n

      console.log('[volverAlOrigen] Par√°metros:', { from, tipo });

      // Prioridad 1: Si viene con par√°metro 'from', usar ese
      if (from) {
        console.log('[volverAlOrigen] Regresando a:', from);
        window.location.href = from;
        return;
      }

      // Prioridad 2: Si es tipo VENTA, ir a ventas.html
      if (tipo && tipo.toUpperCase() === 'VENTA') {
        console.log('[volverAlOrigen] Tipo VENTA detectado, regresando a ventas.html');
        window.location.href = 'ventas.html';
        return;
      }

      // Prioridad 3: Si es tipo RENTA, ir a rentas.html (futuro)
      if (tipo && tipo.toUpperCase() === 'RENTA') {
        console.log('[volverAlOrigen] Tipo RENTA detectado, regresando a rentas.html');
        window.location.href = 'rentas.html';
        return;
      }

      // Por defecto: regresar al dashboard
      console.log('[volverAlOrigen] Sin par√°metros, regresando a dashboard.html');
      window.location.href = 'dashboard.html';
    }
  </script>

  <div class="container">
    <div class="filters">
      <h3><i class="fa fa-filter"></i> Filtros</h3>
      <div class="filters-row">
        <div class="filter-group">
          <label>Buscar</label>
          <input type="text" id="search-input" placeholder="N√∫mero, cliente...">
        </div>
        <div class="filter-group">
          <label>Estado</label>
          <select id="estado-filter">
            <option value="">Todos</option>
            <option value="Borrador">Borrador</option>
            <option value="Enviada">Enviada</option>
            <option value="Revisada">Revisada</option>
            <option value="Aprobada">Aprobada</option>
            <option value="Rechazada">Rechazada</option>
            <option value="Convertida a Contrato">Convertida a Contrato</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Prioridad</label>
          <select id="prioridad-filter">
            <option value="">Todas</option>
            <option value="Baja">Baja</option>
            <option value="Media">Media</option>
            <option value="Alta">Alta</option>
            <option value="Urgente">Urgente</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Fecha Desde</label>
          <input type="date" id="fecha-desde">
        </div>
        <div class="filter-group">
          <label>Fecha Hasta</label>
          <input type="date" id="fecha-hasta">
        </div>
        <div class="filter-group">
          <label>&nbsp;</label>
          <button class="btn-primary" onclick="aplicarFiltros()">
            <i class="fa fa-search"></i> Filtrar
          </button>
        </div>
        <div class="filter-group">
          <label>&nbsp;</label>

          <a class="btn-success" href="cotizaciones.html#workflow-container" role="button">
            <i class="fa fa-plus"></i> Nueva Cotizaci√≥n
          </a>
        </div>
      </div>
    </div>

    <!-- Modal para seleccionar tipo de cotizaci√≥n -->


    <table class="cotizaciones-table">
      <thead>
        <tr>
          <th>N√∫mero</th>
          <th>Cliente/contacto</th>
          <th>Fecha</th>
          <th>Tipo</th>
          <th>Total</th>
          <th>Estado</th>
          <th>Elaborado por</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="cotizaciones-tbody">
        <tr>
          <td colspan="8" style="text-align: center; padding: 40px; color: #3498db; font-size:1.2rem;">
            <i class="fa fa-spinner fa-spin"></i> Cargando cotizaciones...
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal para ver detalles -->
  <div id="modal-detalles" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title">Detalles de Cotizaci√≥n</h3>
        <button class="modal-close" onclick="cerrarModal()">&times;</button>
      </div>
      <div id="modal-body">
        <!-- Contenido din√°mico -->
      </div>
    </div>
  </div>

  <script>
    let cotizaciones = [];
    let filtros = {
      search: '',
      estado: '',
      prioridad: '',
      fechaDesde: '',
      fechaHasta: ''
    };

    // Cargar cotizaciones al iniciar
    document.addEventListener('DOMContentLoaded', function () {
      cargarCotizaciones();
    });

    // Funci√≥n para cargar cotizaciones
    async function cargarCotizaciones() {
      try {
        // Obtener par√°metro de tipo desde la URL
        const urlParams = new URLSearchParams(window.location.search);
        const tipoFiltro = urlParams.get('tipo')?.toUpperCase(); // 'VENTA' o 'RENTA'

        if (tipoFiltro) {
          console.log(`Filtrando cotizaciones por tipo: ${tipoFiltro}`);
        }

        let cotizacionesCargadas = [];

        // Intentar cargar desde sessionStorage primero
        const cotizacionesGuardadas = sessionStorage.getItem('cotizacionesVentas');
        if (cotizacionesGuardadas && tipoFiltro === 'VENTA') {
          try {
            cotizacionesCargadas = JSON.parse(cotizacionesGuardadas);
            console.log('Cotizaciones cargadas desde sessionStorage:', cotizacionesCargadas.length);
          } catch (e) {
            console.error('Error al parsear cotizaciones del sessionStorage:', e);
            cotizacionesCargadas = [];
          }
        }

        // Si no hay en sessionStorage, cargar del backend
        if (cotizacionesCargadas.length === 0) {
          const token = localStorage.getItem('token');
          console.log('Token disponible:', !!token);

          if (!token) {
            console.error('No hay token disponible');
            window.location.href = 'login.html';
            return;
          }

          console.log('Intentando cargar cotizaciones desde base de datos...');
          const response = await fetch('http://localhost:3001/api/cotizaciones', {
            headers: {
              'Authorization': `Bearer ${token}`
            }
          });

          console.log('Respuesta del servidor:', response.status, response.statusText);

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            console.error('Error cargando cotizaciones:', response.status, errorData);
            document.getElementById('cotizaciones-tbody').innerHTML =
              '<tr><td colspan="9" style="text-align: center; color: #e74c3c;">Error cargando cotizaciones: ' + (errorData.error || response.statusText) + '</td></tr>';
            return;
          }

          const result = await response.json();
          console.log('Datos recibidos de base de datos:', result);
          cotizacionesCargadas = Array.isArray(result) ? result : [];
        }

        // Filtrar por tipo si se especific√≥ en la URL
        if (tipoFiltro) {
          cotizacionesCargadas = cotizacionesCargadas.filter(cot =>
            cot.tipo?.toUpperCase() === tipoFiltro
          );
          console.log(`Cotizaciones filtradas (${tipoFiltro}):`, cotizacionesCargadas.length);
        }

        cotizaciones = cotizacionesCargadas;
        renderizarCotizaciones();
      } catch (error) {
        console.error('Error de conexi√≥n:', error);
        document.getElementById('cotizaciones-tbody').innerHTML =
          '<tr><td colspan="9" style="text-align: center; color: #e74c3c;">Error de conexi√≥n: ' + error.message + '</td></tr>';
      }
    }

    // Funci√≥n para renderizar cotizaciones
    function renderizarCotizaciones() {
      const tbody = document.getElementById('cotizaciones-tbody');

      console.log('Renderizando cotizaciones:', cotizaciones);
      console.log('N√∫mero de cotizaciones:', cotizaciones.length);

      if (cotizaciones.length === 0) {
        console.log('No hay cotizaciones para mostrar');
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">No hay cotizaciones</td></tr>';
        return;
      }

      const cotizacionesFiltradas = aplicarFiltrosACotizaciones();
      console.log('Cotizaciones filtradas:', cotizacionesFiltradas);

      tbody.innerHTML = cotizacionesFiltradas.map(cotizacion => `
        <tr>
          <td><strong>${cotizacion.numero_cotizacion}</strong></td>
          <td>${cotizacion.nombre_cliente || cotizacion.contacto_nombre || 'N/A'}</td>
          <td>${new Date(cotizacion.fecha_cotizacion).toLocaleDateString()}</td>
          <td>${cotizacion.tipo}</td>
          <td>$${parseFloat(cotizacion.total || cotizacion.monto_total || 0).toLocaleString()}</td>
          <td>
            <span class="tag tag-${cotizacion.estado?.toLowerCase().replace(/\s+/g, '-')}" 
                  onclick="cambiarEstado(${cotizacion.id_cotizacion}, '${cotizacion.estado || 'Borrador'}')" 
                  style="cursor: pointer;" 
                  title="Click para cambiar estado">
              ${cotizacion.estado || 'Borrador'}
            </span>
          </td>
          <td>
            <div title="${cotizacion.modificado_por_nombre ? 'Modificado por: ' + cotizacion.modificado_por_nombre : ''}">
              ${cotizacion.creado_por_nombre || 'N/A'}
              ${cotizacion.modificado_por_nombre ? '<br><small style="color: #7f8c8d;">(Modificado)</small>' : ''}
            </div>
          </td>
          <td>
            <div class="actions" style="display: flex; gap: 4px; align-items: center; flex-wrap: nowrap;">
              <button class="btn-primary" onclick="verDetalles(${cotizacion.id_cotizacion})" style="padding: 6px 12px; font-size: 0.85rem;">
                <i class="fa fa-eye"></i> Ver
              </button>
              <button class="acciones-btn" onclick="vistaPreviaPDF(${cotizacion.id_cotizacion})" title="Vista previa PDF">
                <i class="fa fa-eye"></i>
              </button>
              <button class="acciones-btn" onclick="editarCotizacion(${cotizacion.id_cotizacion})" title="Editar">
                <i class="fa fa-edit"></i>
              </button>
              <button class="acciones-btn" onclick="clonarCotizacion(${cotizacion.id_cotizacion}, '${cotizacion.tipo}')" title="Clonar">
                <i class="fa fa-copy"></i>
              </button>
              ${cotizacion.tipo?.toUpperCase() === 'VENTA' ? `
              <button class="acciones-btn" onclick="abrirNotaPedido(${cotizacion.id_cotizacion})" title="Nota de Pedido" style="color: #27ae60;">
                <i class="fa fa-file-invoice"></i>
              </button>
              ` : ''}
              <button class="acciones-btn" onclick="eliminarCotizacion(${cotizacion.id_cotizacion})" title="Eliminar">
                <i class="fa fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Funci√≥n para aplicar filtros
    function aplicarFiltros() {
      filtros.search = document.getElementById('search-input').value;
      filtros.estado = document.getElementById('estado-filter').value;
      filtros.prioridad = document.getElementById('prioridad-filter').value;
      filtros.fechaDesde = document.getElementById('fecha-desde').value;
      filtros.fechaHasta = document.getElementById('fecha-hasta').value;

      renderizarCotizaciones();
    }

    // Funci√≥n para aplicar filtros a las cotizaciones
    function aplicarFiltrosACotizaciones() {
      console.log('[Filtros] Aplicando filtros:', filtros);
      console.log('[Filtros] Total cotizaciones antes de filtrar:', cotizaciones.length);

      const resultado = cotizaciones.filter(cotizacion => {
        // Filtro de b√∫squeda (n√∫mero o cliente)
        if (filtros.search && filtros.search.trim() !== '') {
          const searchLower = filtros.search.toLowerCase().trim();
          const numCot = (cotizacion.numero_cotizacion || '').toLowerCase();
          const cliente = (cotizacion.nombre_cliente || cotizacion.cliente_nombre || '').toLowerCase();

          if (!numCot.includes(searchLower) && !cliente.includes(searchLower)) {
            return false;
          }
        }

        // Filtro de estado
        if (filtros.estado && filtros.estado !== '') {
          if (cotizacion.estado !== filtros.estado) {
            return false;
          }
        }

        // Filtro de prioridad
        if (filtros.prioridad && filtros.prioridad !== '') {
          if (cotizacion.prioridad !== filtros.prioridad) {
            return false;
          }
        }

        // Filtro de fecha desde
        if (filtros.fechaDesde && filtros.fechaDesde !== '') {
          // Normalizar fechas a solo fecha (sin hora) para comparaci√≥n correcta
          const fechaCot = new Date(cotizacion.fecha_cotizacion);
          const fechaDesde = new Date(filtros.fechaDesde + 'T00:00:00');

          // Comparar solo a√±o, mes, d√≠a
          const cotDate = new Date(fechaCot.getFullYear(), fechaCot.getMonth(), fechaCot.getDate());
          const desdeDate = new Date(fechaDesde.getFullYear(), fechaDesde.getMonth(), fechaDesde.getDate());

          if (cotDate < desdeDate) {
            return false;
          }
        }

        // Filtro de fecha hasta
        if (filtros.fechaHasta && filtros.fechaHasta !== '') {
          const fechaCot = new Date(cotizacion.fecha_cotizacion);
          const fechaHasta = new Date(filtros.fechaHasta + 'T23:59:59');

          // Comparar solo a√±o, mes, d√≠a
          const cotDate = new Date(fechaCot.getFullYear(), fechaCot.getMonth(), fechaCot.getDate());
          const hastaDate = new Date(fechaHasta.getFullYear(), fechaHasta.getMonth(), fechaHasta.getDate());

          if (cotDate > hastaDate) {
            return false;
          }
        }

        return true;
      });

      console.log('[Filtros] Cotizaciones despu√©s de filtrar:', resultado.length);
      return resultado;
    }


    // Vista previa PDF con la plantilla profesional (APT)
    // Ahora abre reporte_venta_renta.html con el ID de la cotizaci√≥n
    async function vistaPreviaPDF(id) {
      try {
        // Cerrar el modal actual
        cerrarModal();

        // Abrir reporte_venta_renta.html con el ID de la cotizaci√≥n
        // El reporte cargar√° los datos directamente desde la BD
        const reporteUrl = `reporte_venta_renta.html?id=${id}`;
        window.open(reporteUrl, '_blank', 'width=1200,height=900,scrollbars=yes,resizable=yes');

        console.log('[vistaPreviaPDF] Abriendo reporte con ID:', id);
        return; // Nueva implementaci√≥n - salir aqu√≠
      } catch (err) {
        console.error('[vistaPreviaPDF] Error:', err);
        alert('Error al abrir la vista previa: ' + err.message);
      }
    }

    // Funci√≥n legacy de vista previa PDF (backup del c√≥digo anterior)
    async function vistaPreviaPDF_legacy(id) {
      try {
        // Cargar datos completos de la cotizaci√≥n
        const token = localStorage.getItem('token');
        const response = await fetch(`/api/cotizaciones/${id}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) return alert('No se pudo cargar la cotizaci√≥n');
        const c = await response.json();

        // Crear iframe contenedor
        const iframeId = 'pdf-preview-' + id;
        const container = document.createElement('div');
        container.innerHTML = `<iframe id="${iframeId}" style="width:100%;height:75vh;border:1px solid #e0e0e0;border-radius:8px;"></iframe>`;
        document.getElementById('modal-body').innerHTML = '';
        document.getElementById('modal-body').appendChild(container);
        document.getElementById('modal-title').textContent = `Vista previa - ${c.numero_cotizacion}`;
        document.getElementById('modal-detalles').style.display = 'flex';

        // Cargar jsPDF y autotable si no est√°n
        const ensureScript = (src) => new Promise(resolve => {
          if ([...document.scripts].some(s => s.src.includes(src))) return resolve();
          const s = document.createElement('script'); s.src = src; s.onload = resolve; document.body.appendChild(s);
        });
        await ensureScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
        await ensureScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js');

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ unit: 'mm', format: 'a4' });

        // Encabezado con logo y datos
        try {
          const logo = new Image(); logo.src = 'img/logo-demo.jpg';
          await new Promise(r => { logo.onload = r; logo.onerror = r; });
          doc.addImage(logo, 'JPEG', 12, 10, 30, 18);
        } catch { }
        doc.setFont('helvetica', 'bold'); doc.setFontSize(11);
        doc.text('ANDAMIOS Y PROYECTOS TORRES, SA DE C.V', 50, 14);
        doc.setFont('helvetica', 'normal'); doc.setFontSize(8);
        doc.text('Oriente 174 No. 290', 50, 18);
        doc.text('Col. Moctezuma 2a Secci√≥n c.p. 15330', 50, 22);
        doc.text('Venustiano Carranza, CDMX, MEXICO', 50, 26);
        doc.text('Tels. (01) 55-55-71-71-05  55-26-46-00-24  Cel. 55-62-55-78-19', 50, 30);
        doc.text('eMail: ventas@andamiostorres.com', 50, 34);

        // Panel derecho con folio y fecha
        doc.setDrawColor(0); doc.setLineWidth(0.5); doc.line(150, 10, 150, 34);
        doc.setFont('helvetica', 'bold'); doc.setFontSize(11); doc.text('Cotizaci√≥n:', 156, 14);
        doc.setFont('helvetica', 'normal'); doc.text(c.numero_cotizacion || '', 156, 19);
        doc.setFont('helvetica', 'bold'); doc.text('Fecha:', 156, 24);
        doc.setFont('helvetica', 'normal'); doc.text(new Date(c.fecha_cotizacion).toLocaleDateString('es-MX'), 156, 29);
        doc.setFont('helvetica', 'bold'); doc.text('Moneda:', 156, 34);
        doc.setFont('helvetica', 'normal'); doc.text('MXM', 176, 34);

        // L√≠nea morada
        doc.setDrawColor(128, 0, 128); doc.setLineWidth(1.2); doc.line(12, 38, 198, 38);

        // Receptor
        doc.setFont('helvetica', 'bold'); doc.setFontSize(9); doc.text('RECEPTOR', 14, 46);
        doc.setFont('helvetica', 'normal');
        doc.text('Compa√±√≠a:', 14, 52); doc.text(c.nombre_cliente || 'N/A', 40, 52);
        doc.text('Contacto:', 14, 58); doc.text(c.nombre_cliente || 'N/A', 40, 58);
        doc.text('E-Mail:', 120, 58);
        doc.text(String(c.cliente_email || c.email || ''), 135, 58);

        // Descripci√≥n/Detalle - Mejorado para incluir equipos reales
        console.log('üìã Datos de cotizaci√≥n para PDF:', c);
        let filas = [];

        // Primero intentar usar el campo equipos si existe
        if (c.equipos && Array.isArray(c.equipos) && c.equipos.length > 0) {
          console.log('‚úÖ Usando equipos de la cotizaci√≥n:', c.equipos);
          filas = c.equipos.map((equipo, i) => {
            const unit = parseFloat(equipo.precio_unitario || equipo.precio || equipo.price || 0);
            const qty = equipo.cantidad || 1;
            return [
              i + 1,
              equipo.descripcion || equipo.nombre || 'Equipo',
              qty,
              `$${unit.toFixed(2)}`,
              `$${(qty * unit).toFixed(2)}`
            ];
          });
        }
        // Fallback: intentar parsear descripci√≥n como JSON
        else if (c.descripcion) {
          console.log('‚ö†Ô∏è Usando descripci√≥n como fallback:', c.descripcion);
          try {
            const desc = typeof c.descripcion === 'string' ? JSON.parse(c.descripcion) : c.descripcion;
            if (Array.isArray(desc)) {
              filas = desc.map((it, i) => {
                const unit = parseFloat(it.precio_unitario || it.precio || it.price || 0);
                const qty = it.cantidad || 1;
                return [
                  i + 1,
                  it.descripcion || it.nombre || '-',
                  qty,
                  `$${unit.toFixed(2)}`,
                  `$${(qty * unit).toFixed(2)}`
                ];
              });
            } else if (desc && (desc.productos || desc.accesorios)) {
              const mapNombre = {
                'andamio-basico': 'Andamio B√°sico',
                'andamio-profesional': 'Andamio Profesional',
                'escalera': 'Escalera de Acceso',
                'plataforma': 'Plataforma de Trabajo',
                'barandal': 'Barandal de Seguridad',
                'escalera-acceso': 'Escalera de Acceso'
              };
              const productos = (desc.productos || []).map((id) => mapNombre[id] || id);
              const accesorios = (desc.accesorios || []).map((id) => mapNombre[id] || id);
              productos.forEach((n, i) => filas.push([i + 1, n, 1, '$0.00', '$0.00']));
              const base = filas.length;
              accesorios.forEach((n, i) => filas.push([base + i + 1, n, 1, '$0.00', '$0.00']));
            }
          } catch (e) {
            console.error('‚ùå Error parseando descripci√≥n:', e);
          }
        }

        // Si no hay equipos, mostrar mensaje
        if (filas.length === 0) {
          console.log('‚ö†Ô∏è No se encontraron equipos, agregando fila vac√≠a');
          filas = [[1, 'Sin equipos especificados', 1, '$0.00', '$0.00']];
        }

        console.log('üìä Filas para PDF:', filas);

        await doc.autoTable({
          startY: 80,
          head: [['PART.', 'DESCRIPCI√ìN', 'CANT.', 'P.UNIT.', 'IMPORTE']],
          body: filas,
          theme: 'grid',
          styles: { fontSize: 8, cellPadding: 1, lineColor: [0, 102, 204] },
          headStyles: { fillColor: [0, 102, 204], textColor: 255, fontStyle: 'bold' },
          margin: { left: 12, right: 12 },
          columnStyles: { 0: { cellWidth: 12, halign: 'center' }, 2: { cellWidth: 14, halign: 'center' }, 3: { cellWidth: 22, halign: 'right' }, 4: { cellWidth: 22, halign: 'right' } }
        });

        // Totales
        let y = (doc.lastAutoTable?.finalY || 90) + 8;
        doc.setFont('helvetica', 'bold'); doc.text('TOTAL:', 160, y);
        doc.setFont('helvetica', 'normal'); doc.text(`$${parseFloat(c.total || 0).toLocaleString('es-MX')}`, 190, y, { align: 'right' });

        const pdfData = doc.output('datauristring');
        const iframe = document.getElementById(iframeId);
        iframe.src = pdfData;
      } catch (e) {
        console.error(e);
        alert('No se pudo generar la vista previa');
      }
    }

    // Funci√≥n para cerrar modal
    function cerrarModal() {
      document.getElementById('modal-detalles').style.display = 'none';
    }

    // Funci√≥n para cambiar estado de cotizaci√≥n
    async function cambiarEstado(id, estadoActual) {
      const estados = ['Borrador', 'Enviada', 'Revisada', 'Aprobada', 'Rechazada', 'Convertida a Contrato','Prorroga'];

      // Crear modal de selecci√≥n de estado
      const modalHTML = `
        <div id="modal-estado" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 10000;">
          <div style="background: white; padding: 24px; border-radius: 12px; min-width: 300px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
            <h3 style="margin: 0 0 16px 0; color: #1C2F62;"><i class="fa fa-exchange-alt"></i> Cambiar Estado</h3>
            <p style="margin: 0 0 12px 0; color: #666;">Estado actual: <strong>${estadoActual}</strong></p>
            <select id="nuevo-estado" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; margin-bottom: 16px;">
              ${estados.map(e => `<option value="${e}" ${e === estadoActual ? 'selected' : ''}>${e}</option>`).join('')}
            </select>
            <div style="display: flex; gap: 10px;">
              <button onclick="confirmarCambioEstado(${id})" style="flex: 1; padding: 10px; background: #2979ff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                <i class="fa fa-check"></i> Guardar
              </button>
              <button onclick="cerrarModalEstado()" style="flex: 1; padding: 10px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                <i class="fa fa-times"></i> Cancelar
              </button>
            </div>
          </div>
        </div>
      `;

      // Insertar modal en el DOM
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    }

    // Cerrar modal de estado
    function cerrarModalEstado() {
      const modal = document.getElementById('modal-estado');
      if (modal) modal.remove();
    }

    // Confirmar cambio de estado
    async function confirmarCambioEstado(id) {
      const nuevoEstado = document.getElementById('nuevo-estado').value;

      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:3001/api/cotizaciones/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ estado: nuevoEstado })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || 'Error al actualizar estado');
        }

        // Actualizar en la lista local
        actualizarCotizacionEnLista(id, { estado: nuevoEstado });

        cerrarModalEstado();

        // Mostrar mensaje de √©xito
        alert('Estado actualizado correctamente a: ' + nuevoEstado);

      } catch (error) {
        console.error('Error actualizando estado:', error);
        alert('Error al actualizar estado: ' + error.message);
      }
    }

    // Funci√≥n para actualizar una cotizaci√≥n en la lista local
    function actualizarCotizacionEnLista(id, datosActualizados) {
      const cotizacionIndex = cotizaciones.findIndex(c => c.id_cotizacion === id);
      if (cotizacionIndex !== -1) {
        cotizaciones[cotizacionIndex] = { ...cotizaciones[cotizacionIndex], ...datosActualizados };
        renderizarCotizaciones();
        return true;
      }
      return false;
    }

    // Funci√≥n para clonar cotizaci√≥n
    async function clonarCotizacion(id, tipo) {
      try {
        console.log('[clonarCotizacion] Iniciando clonaci√≥n de cotizaci√≥n ID:', id, 'Tipo:', tipo);

        // Cargar datos completos de la cotizaci√≥n
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:3001/api/cotizaciones/${id}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          console.error('[clonarCotizacion] Error:', response.status, errorData);
          alert('Error cargando datos de la cotizaci√≥n: ' + (errorData.error || response.statusText));
          return;
        }

        const cotizacion = await response.json();
        console.log('[clonarCotizacion] Cotizaci√≥n cargada:', cotizacion);

        // Determinar la p√°gina correcta seg√∫n el tipo
        const tipoUpper = tipo?.toUpperCase();
        let paginaDestino = 'cotizacion_venta.html'; // Por defecto venta

        if (tipoUpper === 'RENTA') {
          paginaDestino = 'cotizacion_renta.html';
        } else if (tipoUpper === 'VENTA') {
          paginaDestino = 'cotizacion_venta.html';
        }

        console.log('[clonarCotizacion] Abriendo ventana:', paginaDestino);

        // Abrir la p√°gina en una nueva ventana
        const ventanaClonacion = window.open(
          paginaDestino,
          `clonar-${id}`,
          'width=1400,height=900,scrollbars=yes,resizable=yes'
        );

        if (!ventanaClonacion) {
          alert('Por favor permita las ventanas emergentes para clonar cotizaciones');
          return;
        }

        // Esperar a que la ventana cargue y luego enviar los datos
        ventanaClonacion.addEventListener('load', function () {
          console.log('[clonarCotizacion] Ventana cargada, enviando datos de cotizaci√≥n');

          // Esperar un poco m√°s para asegurar que los scripts est√©n cargados
          setTimeout(() => {
            if (typeof ventanaClonacion.fillCloneModalWithCurrentQuotation === 'function') {
              console.log('[clonarCotizacion] Llamando a fillCloneModalWithCurrentQuotation con datos');
              ventanaClonacion.fillCloneModalWithCurrentQuotation(cotizacion);
            } else {
              console.error('[clonarCotizacion] fillCloneModalWithCurrentQuotation no est√° disponible en la ventana');
              // Intentar de nuevo despu√©s de un delay m√°s largo
              setTimeout(() => {
                if (typeof ventanaClonacion.fillCloneModalWithCurrentQuotation === 'function') {
                  ventanaClonacion.fillCloneModalWithCurrentQuotation(cotizacion);
                } else {
                  console.error('[clonarCotizacion] Funci√≥n de clonaci√≥n no disponible despu√©s del segundo intento');
                }
              }, 2000);
            }
          }, 1000);
        });

      } catch (error) {
        console.error('[clonarCotizacion] Error:', error);
        alert('Error al iniciar la clonaci√≥n: ' + error.message);
      }
    }

    // Funci√≥n para editar cotizaci√≥n
    async function editarCotizacion(id) {
      try {
        console.log('[editarCotizacion] Iniciando edici√≥n de cotizaci√≥n ID:', id);

        // Cargar datos de la cotizaci√≥n primero
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:3001/api/cotizaciones/${id}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const cotizacion = await response.json();
          console.log('[editarCotizacion] Cotizaci√≥n cargada:', cotizacion);

          // Guardar datos para edici√≥n
          sessionStorage.setItem('cotizacionParaEditar', JSON.stringify(cotizacion));

          // Determinar el tipo de cotizaci√≥n y redirigir a la p√°gina correcta
          const tipo = cotizacion.tipo?.toUpperCase();
          let paginaDestino = 'cotizacion_renta.html'; // Por defecto renta

          if (tipo === 'VENTA') {
            paginaDestino = 'cotizacion_venta.html';
            console.log('[editarCotizacion] Redirigiendo a p√°gina de VENTA');
          } else if (tipo === 'RENTA') {
            paginaDestino = 'cotizacion_renta.html';
            console.log('[editarCotizacion] Redirigiendo a p√°gina de RENTA');
          } else {
            console.warn('[editarCotizacion] Tipo desconocido:', tipo, '- usando renta por defecto');
          }

          // Redirigir a la p√°gina correspondiente en modo edici√≥n
          window.location.href = `${paginaDestino}?edit=${id}`;
        } else {
          const errorData = await response.json().catch(() => ({}));
          console.error('[editarCotizacion] Error:', response.status, errorData);
          alert('Error cargando datos de la cotizaci√≥n: ' + (errorData.error || response.statusText));
        }
      } catch (error) {
        console.error('[editarCotizacion] Error:', error);
        alert('Error al editar la cotizaci√≥n: ' + error.message);
      }
    }

    // Funci√≥n para convertir a contrato
    async function convertirAContrato(id) {
      if (!confirm('¬øEst√° seguro de convertir esta cotizaci√≥n a contrato?')) {
        return;
      }

      // Deshabilitar el bot√≥n durante la operaci√≥n
      const button = event.target;
      const originalText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Convirtiendo...';

      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:3001/api/cotizaciones/${id}/convertir-contrato`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          const result = await response.json();
          alert('Cotizaci√≥n convertida a contrato exitosamente');

          // Actualizar el estado de la cotizaci√≥n en la lista local
          if (!actualizarCotizacionEnLista(id, { estado: 'Convertida a Contrato' })) {
            // Si no se encuentra en la lista local, recargar desde el servidor
            cargarCotizaciones();
          }
        } else {
          const result = await response.json();
          alert('Error: ' + (result.error || 'Error desconocido'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error convirtiendo cotizaci√≥n a contrato');
      } finally {
        // Restaurar el bot√≥n
        button.disabled = false;
        button.innerHTML = originalText;
      }
    }

    // Funci√≥n para eliminar cotizaci√≥n
    async function eliminarCotizacion(id) {
      if (!confirm('¬øEst√° seguro de eliminar esta cotizaci√≥n?')) {
        return;
      }

      try {
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:3001/api/cotizaciones/${id}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (response.ok) {
          alert('Cotizaci√≥n eliminada exitosamente');

          // Remover la cotizaci√≥n de la lista local
          cotizaciones = cotizaciones.filter(c => c.id_cotizacion !== id);
          renderizarCotizaciones();
        } else {
          const result = await response.json();
          alert('Error: ' + (result.error || 'Error desconocido'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error eliminando cotizaci√≥n');
      }
    }

    // --- MODAL DE TIPO DE COTIZACI√ìN ---
    window.abrirModalTipoCotizacion = function () {
      document.getElementById('modal-tipo-cotizacion').style.display = 'flex';
    }

    window.cerrarModalTipoCotizacion = function () {
      document.getElementById('modal-tipo-cotizacion').style.display = 'none';
    }

    window.redirigirCotizacionTipo = function (tipo) {
      window.cerrarModalTipoCotizacion();
      window.location.href = `cotizaciones.html?tipo=${encodeURIComponent(tipo)}`;
    }

    // Funci√≥n para abrir Nota de Pedido desde cotizaci√≥n de VENTA
    let cotizacionActualNota = null; // Variable global para almacenar la cotizaci√≥n actual
    let almacenesDisponibles = []; // Variable para almacenar los almacenes cargados

    async function abrirNotaPedido(id) {
      try {
        console.log('[abrirNotaPedido] Abriendo modal para cotizaci√≥n ID:', id);

        // 1. Limpiar storage previo para evitar interferencias
        sessionStorage.removeItem('datosNotaContrato');
        localStorage.removeItem('datosNotaContrato');

        // 2. Cargar datos completos de la cotizaci√≥n
        const token = localStorage.getItem('token');
        const response = await fetch(`http://localhost:3001/api/cotizaciones/${id}`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!response.ok) {
          throw new Error('No se pudo cargar la cotizaci√≥n');
        }

        const cotizacion = await response.json();
        console.log('[abrirNotaPedido] Cotizaci√≥n cargada:', cotizacion);

        // Verificar que sea de tipo VENTA
        if (cotizacion.tipo?.toUpperCase() !== 'VENTA') {
          alert('Esta funci√≥n solo est√° disponible para cotizaciones de VENTA');
          return;
        }

        // Guardar cotizaci√≥n actual
        cotizacionActualNota = cotizacion;

        // 3. Verificar si ya tiene datos de env√≠o completos
        const calle = cotizacion.entrega_calle || cotizacion.direccion_entrega || '';
        // CAMBIO: Siempre mostrar el modal para permitir editar Contacto y Horario
        // const tieneDatosEnvio = calle && calle.trim() !== '';

        console.log('[abrirNotaPedido] Abriendo modal para confirmar datos de env√≠o...');
        await mostrarModalCapturaDatos(cotizacion);

      } catch (error) {
        console.error('[abrirNotaPedido] Error:', error);
        alert('Error al abrir la nota: ' + error.message);
      }
    }

    // Nueva funci√≥n: Generar nota directamente (sin modal)
    async function generarNotaDirecta(cotizacion) {
      try {
        const c = cotizacion;
        
        // 1. Obtener Folio Oficial desde el Backend
        const token = localStorage.getItem('token');
        const respFolio = await fetch(`http://localhost:3001/api/cotizaciones/${c.id_cotizacion}/generar-folio-nota`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!respFolio.ok) throw new Error('Error al generar folio consecutivo');
        const dataFolio = await respFolio.json();
        const folioOficial = dataFolio.folio; // Ej: 2026-02-0001
        
        console.log('[generarNotaDirecta] Folio oficial obtenido:', folioOficial);

        let productos = [];
        try {
          if (c.productos_seleccionados) {
            productos = typeof c.productos_seleccionados === 'string' ? JSON.parse(c.productos_seleccionados) : c.productos_seleccionados;
          } else if (c.productos) {
            productos = Array.isArray(c.productos) ? c.productos : JSON.parse(c.productos);
          }
          if (c.accesorios_seleccionados) {
            const acc = typeof c.accesorios_seleccionados === 'string' ? JSON.parse(c.accesorios_seleccionados) : c.accesorios_seleccionados;
            if (acc && acc.length > 0) productos = [...productos, ...acc];
          }
        } catch (e) { console.error('Error parseando productos:', e); }

        const datosNota = {
          numeroNota: folioOficial, // USAR FOLIO OFICIAL
          folioCotizacion: c.numero_cotizacion, // Guardar referencia al folio original
          nombreCliente: c.nombre_cliente || c.contacto_nombre || '',
          fechaEmision: c.fecha_cotizacion || new Date().toISOString(),
          tipo: 'VENTA',
          cliente: {
            nombre: c.nombre_cliente || c.contacto_nombre || '',
            rfc: c.cliente_rfc || '',
            telefono: c.contacto_telefono || '',
            email: c.contacto_email || ''
          },
          envio: {
            calle: c.entrega_calle || c.direccion_entrega || '',
            no_externo: c.entrega_numero_ext || '',
            no_interno: c.entrega_numero_int || '',
            colonia: c.entrega_colonia || '',
            cp: c.entrega_cp || '',
            estado: c.entrega_estado || '',
            municipio: c.entrega_municipio || '',
            notas: c.notas || c.observaciones || '',
            contacto: c.entrega_contacto || c.nombre_cliente || c.contacto_nombre || '',
            entrega_contacto: c.entrega_contacto || c.nombre_cliente || c.contacto_nombre || '',
            hora_inicio: c.hora_inicio || '',
            hora_fin: c.hora_fin || '',
            metodo: c.metodo_entrega || 'domicilio'
          },
          productos: productos,
          totales: {
            subtotal: parseFloat(c.subtotal || 0),
            iva: parseFloat(c.iva || 0),
            total: parseFloat(c.total || 0)
          },
          condiciones: 'VENTA'
        };

        // Guardar en storage
        sessionStorage.setItem('datosNotaContrato', JSON.stringify(datosNota));
        localStorage.setItem('datosNotaContrato', JSON.stringify(datosNota));

        // Abrir la nota
        const urlNota = `hoja_pedido2.html?ts=${Date.now()}`;
        window.open(urlNota, '_blank', 'width=1200,height=900,scrollbars=yes,resizable=yes');

        console.log('[generarNotaDirecta] Nota generada y abierta exitosamente');
        
        // Refrescar lista para mostrar posible cambio de datos
        // buscarCotizaciones(); // Opcional, si queremos actualizar la vista
      } catch (error) {
        console.error('[generarNotaDirecta] Error:', error);
        alert('Error al generar la nota: ' + error.message);
      }
    }

    // Nueva funci√≥n: Mostrar modal para capturar datos faltantes
    async function mostrarModalCapturaDatos(cotizacionData) {
      let cotizacion = cotizacionData;
      
      // Refrescar datos desde backend para asegurar la versi√≥n m√°s reciente
      try {
          const token = localStorage.getItem('token');
          const resp = await fetch(`/api/cotizaciones/${cotizacionData.id_cotizacion}`, {
              headers: { 'Authorization': `Bearer ${token}` }
          });
          if (resp.ok) {
              cotizacion = await resp.json();
              console.log('[mostrarModalCapturaDatos] Cotizaci√≥n refrescada:', cotizacion);
          }
      } catch (e) {
          console.warn('[mostrarModalCapturaDatos] No se pudo refrescar cotizaci√≥n:', e);
      }

      // Cargar almacenes disponibles
      await cargarAlmacenesNota();

      // Resetear y Precargar datos en el formulario
      // NUEVO: Llenar input de contacto de entrega (priorizar entrega_contacto)
      document.getElementById('nota-contacto').value = 
        cotizacion.entrega_contacto || cotizacion.nombre_cliente || cotizacion.contacto_nombre || '';
      
      document.getElementById('nota-telefono').value = 
        cotizacion.entrega_telefono || cotizacion.cliente_telefono || cotizacion.contacto_telefono || '';
      
      // NUEVO: Limpiar o cargar horario si existiera
      document.getElementById('nota-hora-inicio').value = cotizacion.hora_inicio || '';
      document.getElementById('nota-hora-fin').value = cotizacion.hora_fin || '';

      const calle = cotizacion.entrega_calle || cotizacion.direccion_entrega || '';
      const colonia = cotizacion.entrega_colonia || '';
      document.getElementById('nota-calle').value = calle;
      document.getElementById('nota-no-externo').value = cotizacion.entrega_numero_ext || '';
      document.getElementById('nota-no-interno').value = cotizacion.entrega_numero_int || '';
      document.getElementById('nota-colonia').value = colonia;
      document.getElementById('nota-cp').value = cotizacion.entrega_cp || '';
      document.getElementById('nota-estado').value = cotizacion.entrega_estado || '';
      document.getElementById('nota-municipio').value = cotizacion.entrega_municipio || '';
      document.getElementById('nota-observaciones').value = cotizacion.notas || cotizacion.observaciones || '';

      // Detecci√≥n autom√°tica del m√©todo de entrega
      let metodoEntrega = cotizacion.metodo_entrega || 'sucursal';
      
      // Si no tiene m√©todo expl√≠cito, detectar por calle
      if (!cotizacion.metodo_entrega && calle && !calle.toLowerCase().includes('sucursal') && !calle.toLowerCase().includes('recoleccion')) {
        metodoEntrega = 'domicilio';
      }

      const radios = document.getElementsByName('nota-metodo-entrega');
      radios.forEach(r => {
        r.checked = (r.value === metodoEntrega);
      });

      // SINCRONIZAR UI SEG√öN M√âTODO DETECTADO
      cambiarMetodoEntregaNota(metodoEntrega, true); // Pasar true para evitar limpiar campos en la carga inicial

      // Si es sucursal, intentar pre-seleccionar el almac√©n correcto
      if (metodoEntrega === 'sucursal') {
        const selectAlmacen = document.getElementById('nota-almacen-select');
        const idAlmacenRef = cotizacion.id_almacen_recoleccion || cotizacion.id_almacen;
        
        if (idAlmacenRef && selectAlmacen) {
          selectAlmacen.value = idAlmacenRef;
        } else if (calle && selectAlmacen) {
          // Fallback: buscar por nombre en el texto de la calle
          for (let i = 0; i < selectAlmacen.options.length; i++) {
            const opt = selectAlmacen.options[i];
            if (opt.text && calle.toLowerCase().includes(opt.text.split('-')[0].trim().toLowerCase())) {
              selectAlmacen.selectedIndex = i;
              break;
            }
          }
        }
      }

      // Configurar botones: solo mostrar "Generar" ya que no hay datos previos
      const btnGenerar = document.getElementById('btn-guardar-ver-nota');
      const btnVerDirecto = document.getElementById('btn-ver-nota-directo');
      
      btnGenerar.innerHTML = '<i class="fa fa-file-pdf"></i> Generar Nota de Pedido';
      btnGenerar.style.background = '#27ae60';
      btnVerDirecto.style.display = 'none'; // Ocultar bot√≥n "Ver Nota"

      // Actualizar t√≠tulo del modal
      document.getElementById('modal-nota-title').textContent = 
        `Nota de Env√≠o - ${cotizacion.numero_cotizacion || 'VENTA'}`;

      // Mostrar el modal
      document.getElementById('modal-nota-pedido-venta').style.display = 'flex';
    }

    // Funci√≥n para cerrar el modal
    function cerrarModalNotaPedido() {
      document.getElementById('modal-nota-pedido-venta').style.display = 'none';
      cotizacionActualNota = null;
    }

    // Funci√≥n para cambiar m√©todo de entrega
function cambiarMetodoEntregaNota(metodo, esCargaInicial = false) {
  const selectorAlmacen = document.getElementById('nota-selector-almacen');
  const camposDireccion = document.getElementById('nota-campos-direccion'); // Contenedor de inputs
  const obsField = document.getElementById('nota-observaciones');
  
  if (metodo === 'sucursal') {
    // Mostrar selector de almac√©n y ocultar campos manuales
    if (selectorAlmacen) selectorAlmacen.style.display = 'block';
    if (camposDireccion) camposDireccion.style.display = 'none'; // OCULTAR CAMPOS
    
    // Limpiar campos para que el usuario seleccione un almac√©n (solo si no es carga inicial o si no hay datos)
    if (!esCargaInicial) {
        document.getElementById('nota-calle').value = '';
        document.getElementById('nota-no-externo').value = '';
        document.getElementById('nota-no-interno').value = '';
        document.getElementById('nota-colonia').value = '';
        document.getElementById('nota-cp').value = '';
        document.getElementById('nota-estado').value = '';
        document.getElementById('nota-municipio').value = '';
    }
  } else if (metodo === 'domicilio') {
    // Ocultar selector de almac√©n y mostrar campos manuales
    if (selectorAlmacen) selectorAlmacen.style.display = 'none';
    if (camposDireccion) camposDireccion.style.display = 'block'; // MOSTRAR CAMPOS
    
    // Limpiar notas de recolecci√≥n autom√°ticas si existen (Regex para soportar acentos)
    const esNotaAutomaticaRecoleccion = /^recolecci[o√≥]n en sucursal/i.test(obsField.value.trim());
    if (!esCargaInicial && obsField && esNotaAutomaticaRecoleccion) {
        // Intentar restaurar nota original de la cotizaci√≥n que no sea de recolecci√≥n
        let notaOriginal = cotizacionActualNota?.notas || cotizacionActualNota?.observaciones || '';
        if (/^recolecci[o√≥]n en sucursal/i.test(notaOriginal)) notaOriginal = '';
        obsField.value = notaOriginal;
    }

    // Restaurar datos originales de la cotizaci√≥n si el usuario cambi√≥ a domicilio
    if (!esCargaInicial && cotizacionActualNota) {
      document.getElementById('nota-calle').value = cotizacionActualNota.entrega_calle || cotizacionActualNota.direccion_entrega || '';
      document.getElementById('nota-no-externo').value = cotizacionActualNota.entrega_numero_ext || '';
      document.getElementById('nota-colonia').value = cotizacionActualNota.entrega_colonia || '';
      document.getElementById('nota-cp').value = cotizacionActualNota.entrega_cp || '';
      document.getElementById('nota-estado').value = cotizacionActualNota.entrega_estado || '';
      document.getElementById('nota-municipio').value = cotizacionActualNota.entrega_municipio || '';
    }
  }
}

    // Funci√≥n para cargar almacenes desde la API
    async function cargarAlmacenesNota() {
      try {
        console.log('[cargarAlmacenesNota] Cargando almacenes...');
        
        // Usar window.API_CONFIG si est√° disponible, sino usar fetch directo
        let almacenes = [];
        if (window.API_CONFIG && window.API_CONFIG.get) {
          almacenes = await window.API_CONFIG.get('productos/almacenes');
        } else {
          const token = localStorage.getItem('token');
          const response = await fetch('http://localhost:3001/api/productos/almacenes', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          almacenes = await response.json();
        }

        almacenesDisponibles = almacenes;
        
        // Llenar el select
        const select = document.getElementById('nota-almacen-select');
        
        // Datos de respaldo para completar faltantes
        const respaldo = {
           'BODEGA 68 CDMX': 'Calle Ote. 174 #290, Moctezuma 2da Secc, Venustiano Carranza, 15530 Ciudad de M√©xico, CDMX',
           'TEXCOCO': 'Ahuehuetes No int 6, Col ursulo galvan santa Irene, Texcoco de Mora, CP. 56263, Estado de M√©xico, M√©xico',
           'MEXICALI': 'Carretera San Luis Km 13.5, Ejido Puebla, Mexicali, Baja California'
        };

        if (select) {
          select.innerHTML = '<option value="">-- Selecciona un almac√©n --</option>';
          almacenes.forEach(almacen => {
            // Intentar recuperar direcci√≥n si viene vac√≠a
            let dir = almacen.direccion;
            if (!dir || dir.trim() === '') {
                 // Buscar en respaldo por nombre similar
                 const key = Object.keys(respaldo).find(k => almacen.nombre_almacen.toUpperCase().includes(k));
                 if (key) dir = respaldo[key];
            }

            const option = document.createElement('option');
            option.value = almacen.id_almacen;
            option.textContent = `${almacen.nombre_almacen} - ${almacen.ubicacion || ''}`;
            option.dataset.direccion = dir || ''; // Asignar direcci√≥n recuperada o vac√≠a
            select.appendChild(option);
          });
        }

        console.log('[cargarAlmacenesNota] Almacenes cargados:', almacenes.length);
      } catch (error) {
        console.error('[cargarAlmacenesNota] Error:', error);
        // En caso de error, usar datos de respaldo
        almacenesDisponibles = [
          { 
            id_almacen: 1, 
            nombre_almacen: 'BODEGA 68 CDMX', 
            ubicacion: 'CDMX',
            direccion: 'Calle Ote. 174 #290, Moctezuma 2da Secc, Venustiano Carranza, 15530 Ciudad de M√©xico, CDMX'
          },
          { 
            id_almacen: 2, 
            nombre_almacen: 'TEXCOCO', 
            ubicacion: 'Estado de M√©xico',
            direccion: 'Ahuehuetes No int 6, Col ursulo galvan santa Irene, Texcoco de Mora, CP. 56263, Estado de M√©xico, M√©xico'
          }
        ];
        
        const select = document.getElementById('nota-almacen-select');
        if (select) {
          select.innerHTML = '<option value="">-- Selecciona un almac√©n --</option>';
          almacenesDisponibles.forEach(almacen => {
            const option = document.createElement('option');
            option.value = almacen.id_almacen;
            option.textContent = `${almacen.nombre_almacen} - ${almacen.ubicacion || ''}`;
            option.dataset.direccion = almacen.direccion || '';
            select.appendChild(option);
          });
        }
      }
    }

    // Funci√≥n para seleccionar un almac√©n y llenar los campos
    function seleccionarAlmacenNota() {
      const select = document.getElementById('nota-almacen-select');
      if (!select || !select.value) return;

      const almacenId = parseInt(select.value);
      const almacen = almacenesDisponibles.find(a => a.id_almacen === almacenId);
      
      if (almacen) {
        console.log('[seleccionarAlmacenNota] Almac√©n seleccionado:', almacen);
        
        // Llenar campos con la direcci√≥n REAL del almac√©n
        // El backend devuelve 'direccion' como string completo
        document.getElementById('nota-calle').value = almacen.direccion || '';
        document.getElementById('nota-no-externo').value = '';
        document.getElementById('nota-no-interno').value = '';
        document.getElementById('nota-colonia').value = '';
        document.getElementById('nota-cp').value = '';
        document.getElementById('nota-municipio').value = '';
        document.getElementById('nota-estado').value = '';
        
        // Usar observaciones para el T√≠tulo de Recolecci√≥n
        document.getElementById('nota-observaciones').value = `Recolecci√≥n en Sucursal: ${almacen.nombre_almacen}`;
      }
    }

    // --- NUEVA FUNCI√ìN: VER NOTA DIRECTAMENTE SIN GUARDAR ---
    function verNotaPedidoDirecto() {
      if (!cotizacionActualNota) return;

      try {
        console.log('[verNotaPedidoDirecto] Abriendo nota existente sin guardar cambios');

        // Preparar datos para el reporte usando los datos actuales del formulario
        const c = cotizacionActualNota;
        
        let productos = [];
        try {
          if (c.productos_seleccionados) {
            productos = typeof c.productos_seleccionados === 'string' ? JSON.parse(c.productos_seleccionados) : c.productos_seleccionados;
          } else if (c.productos) {
            productos = Array.isArray(c.productos) ? c.productos : JSON.parse(c.productos);
          }
          if (c.accesorios_seleccionados) {
            const acc = typeof c.accesorios_seleccionados === 'string' ? JSON.parse(c.accesorios_seleccionados) : c.accesorios_seleccionados;
            if (acc && acc.length > 0) productos = [...productos, ...acc];
          }
        } catch (e) { console.error('Error parseando productos:', e); }

        const datosNota = {
          numeroNota: c.numero_cotizacion || c.numero_folio || '',
          nombreCliente: c.nombre_cliente || c.contacto_nombre || '',
          fechaEmision: c.fecha_cotizacion || new Date().toISOString(),
          tipo: 'VENTA',
          cliente: {
            nombre: c.nombre_cliente || c.contacto_nombre || '',
            rfc: c.cliente_rfc || '',
            telefono: c.contacto_telefono || '',
            email: c.contacto_email || ''
          },
          envio: {
            calle: document.getElementById('nota-calle').value || c.entrega_calle,
            no_externo: document.getElementById('nota-no-externo').value || c.entrega_numero_ext,
            no_interno: document.getElementById('nota-no-interno').value || c.entrega_numero_int,
            colonia: document.getElementById('nota-colonia').value || c.entrega_colonia,
            cp: document.getElementById('nota-cp').value || c.entrega_cp,
            estado: document.getElementById('nota-estado').value || c.entrega_estado,
            municipio: document.getElementById('nota-municipio').value || c.entrega_municipio,
            notas: document.getElementById('nota-observaciones').value || c.notas,
            contacto: document.getElementById('nota-contacto').value || c.entrega_contacto,
            entrega_contacto: document.getElementById('nota-contacto').value || c.entrega_contacto,
            hora_inicio: document.getElementById('nota-hora-inicio').value || c.hora_inicio,
            hora_fin: document.getElementById('nota-hora-fin').value || c.hora_fin,
            metodo: document.querySelector('input[name="nota-metodo-entrega"]:checked')?.value || 'domicilio'
          },
          productos: productos,
          totales: {
            subtotal: parseFloat(c.subtotal || 0),
            iva: parseFloat(c.iva || 0),
            total: parseFloat(c.total || 0)
          },
          condiciones: 'VENTA'
        };

        // Guardar en storage para que reporte lo lea
        sessionStorage.setItem('datosNotaContrato', JSON.stringify(datosNota));
        localStorage.setItem('datosNotaContrato', JSON.stringify(datosNota));

        // Abrir la nota
        const urlNota = `hoja_pedido2.html?ts=${Date.now()}`;
        window.open(urlNota, '_blank', 'width=1200,height=900,scrollbars=yes,resizable=yes');

      } catch (error) {
        console.error('[verNotaPedidoDirecto] Error:', error);
        alert('Error al abrir la nota: ' + error.message);
      }
    }

    // --- NUEVA FUNCI√ìN: GUARDAR EN BD Y VER NOTA ---
    async function guardarYVerNotaPedido() {
      if (!cotizacionActualNota) return;

      const btn = document.getElementById('btn-guardar-ver-nota');
      const originalHTML = btn.innerHTML;

      try {
        btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Guardando...';
        btn.disabled = true;
        if (!cotizacionActualNota) return;
        
        // Recopilar datos del formulario
        let calle = document.getElementById('nota-calle').value; // Usamos let para correcci√≥n
        const noExterno = document.getElementById('nota-no-externo').value;
        const noInterno = document.getElementById('nota-no-interno').value;
        const colonia = document.getElementById('nota-colonia').value;
        const cp = document.getElementById('nota-cp').value;
        const municipio = document.getElementById('nota-municipio').value;
        const estado = document.getElementById('nota-estado').value;
        const observaciones = document.getElementById('nota-observaciones').value;
        
        // NUEVOS CAMPOS: Contacto y Horario
        const contactoEntrega = document.getElementById('nota-contacto').value;
        const telefonoEntrega = document.getElementById('nota-telefono').value;
        const horaInicio = document.getElementById('nota-hora-inicio').value;
        const horaFin = document.getElementById('nota-hora-fin').value;
        
        // AUTO-CORRECCI√ìN Y RECUPERACI√ìN DE DIRECCI√ìN
        // 1. Si es Sucursal, recuperamos la direcci√≥n del almac√©n seleccionado directamente del dataset
        const radios = document.getElementsByName('nota-metodo-entrega');
        let esSucursal = false;
        radios.forEach(r => { if(r.checked && r.value === 'sucursal') esSucursal = true; });

        console.log('[guardarYVerNotaPedido] M√©todo entrega:', esSucursal ? 'SUCURSAL' : 'DOMICILIO');

        if (esSucursal) {
           const selectAlmacen = document.getElementById('nota-almacen-select');
           if (!selectAlmacen || !selectAlmacen.value) {
              alert('‚ö†Ô∏è Por favor SELECCIONA UNA SUCURSAL de la lista para continuar.');
              return;
           }
           
           // Recuperar direcci√≥n segura desde el dataset de la opci√≥n
           const selectedOption = selectAlmacen.options[selectAlmacen.selectedIndex];
           if (selectedOption) {
               calle = selectedOption.dataset.direccion || '';
               console.log('[guardarYVerNotaPedido] Direcci√≥n recuperada de dataset:', calle);
               
               if (!calle) {
                   // Fallback: intentar buscar por ID en array global si dataset falla
                   const almacenSel = almacenesDisponibles.find(a => a.id_almacen == selectAlmacen.value);
                   if (almacenSel) calle = almacenSel.direccion;
               }
           }
           
           if (!calle) {
               alert('Error: La sucursal seleccionada no tiene direcci√≥n configurada.');
               return;
           }
        } // <--- Cierre de if (esSucursal)
        
        // Limpiar "falsos positivos" de recolecci√≥n si estamos en modo domicilio
        if (!esSucursal) {
           // Si el campo calle o notas tienen el texto autom√°tico de recolecci√≥n, los limpiamos
           if (/^recolecci[o√≥]n en sucursal/i.test(calle)) calle = '';
           if (/^recolecci[o√≥]n en sucursal/i.test(observaciones)) {
               // Ya lo limpiamos arriba, pero nos aseguramos por si acaso
           }
        }

        // Validar campos requeridos
        if (!calle || !calle.trim()) {
          alert('‚ö†Ô∏è Falta la direcci√≥n. Por favor ingresa la CALLE o selecciona una SUCURSAL.');
          return;
        }

        // Preparar datos para actualizaci√≥n
        const updateData = {
          direccion_entrega: calle, 
          entrega_calle: calle,
          entrega_numero_ext: noExterno,
          entrega_numero_int: noInterno,
          entrega_colonia: colonia,
          entrega_cp: cp,
          entrega_municipio: municipio,
          entrega_estado: estado,
          observaciones: observaciones,
          notas: observaciones,
          // NUEVOS CAMPOS PARA PERSISTENCIA
          entrega_contacto: contactoEntrega,
          entrega_telefono: telefonoEntrega,
          hora_inicio: horaInicio,
          hora_fin: horaFin,
          metodo_entrega: esSucursal ? 'sucursal' : 'domicilio',
          id_almacen_recoleccion: (esSucursal && document.getElementById('nota-almacen-select').value) ? document.getElementById('nota-almacen-select').value : null
        };

        const token = localStorage.getItem('token');
        
        // 1. Guardar cambios en la cotizaci√≥n
        console.log('[guardarYVerNotaPedido] Guardando cambios...');
        const responseUpdate = await fetch(`/api/cotizaciones/${cotizacionActualNota.id_cotizacion}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(updateData)
        });

        if (!responseUpdate.ok) {
          throw new Error('Error al guardar los datos');
        }

        // Actualizar objeto local con los nuevos datos
        const cotizacionActualizada = await responseUpdate.json();
        cotizacionActualNota = { ...cotizacionActualNota, ...cotizacionActualizada };
        
        console.log('[guardarYVerNotaPedido] Cambios guardados, generando folio...');

        // Feedback visual (Toast)
        if (typeof Swal !== 'undefined') {
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true,
                didOpen: (toast) => {
                    toast.addEventListener('mouseenter', Swal.stopTimer);
                    toast.addEventListener('mouseleave', Swal.resumeTimer);
                }
            });
            Toast.fire({
                icon: 'success',
                title: 'Cambios guardados correctamente'
            });
        }

        // 2. Obtener Folio Oficial desde el Backend
        const respFolio = await fetch(`/api/cotizaciones/${cotizacionActualNota.id_cotizacion}/generar-folio-nota`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });

        if (!respFolio.ok) throw new Error('Error al generar folio consecutivo');
        const dataFolio = await respFolio.json();
        const folioOficial = dataFolio.folio; // Ej: 2026-02-0001
        
        console.log('[guardarYVerNotaPedido] Folio oficial obtenido:', folioOficial);

        // 3. Preparar datos para la nota
        let productos = [];
        try {
          if (cotizacionActualNota.productos_seleccionados) {
            productos = typeof cotizacionActualNota.productos_seleccionados === 'string' ? JSON.parse(cotizacionActualNota.productos_seleccionados) : cotizacionActualNota.productos_seleccionados;
          } else if (cotizacionActualNota.productos) {
            productos = Array.isArray(cotizacionActualNota.productos) ? cotizacionActualNota.productos : JSON.parse(cotizacionActualNota.productos);
          }
        } catch (e) { console.error('Error parseando productos:', e); }

        const datosNota = {
          numeroNota: folioOficial, // USAR FOLIO OFICIAL
          folioCotizacion: cotizacionActualNota.numero_cotizacion,
          nombreCliente: cotizacionActualNota.nombre_cliente || cotizacionActualNota.contacto_nombre || '',
          fechaEmision: cotizacionActualNota.fecha_cotizacion || new Date().toISOString(),
          tipo: 'VENTA',
          cliente: {
            nombre: cotizacionActualNota.nombre_cliente || cotizacionActualNota.contacto_nombre || '',
            rfc: cotizacionActualNota.cliente_rfc || '',
            telefono: cotizacionActualNota.contacto_telefono || '',
            email: cotizacionActualNota.contacto_email || ''
          },
          envio: {
            calle: calle,
            no_externo: noExterno,
            no_interno: noInterno,
            colonia: colonia,
            cp: cp,
            estado: estado,
            municipio: municipio,
            notas: observaciones,
            contacto: contactoEntrega, 
            entrega_contacto: contactoEntrega, 
            telefono: telefonoEntrega,
            entrega_telefono: telefonoEntrega,
            hora_inicio: horaInicio,
            hora_fin: horaFin,
            metodo: esSucursal ? 'sucursal' : 'domicilio'
          },
          productos: productos,
          totales: {
            subtotal: parseFloat(cotizacionActualNota.subtotal || 0),
            iva: parseFloat(cotizacionActualNota.iva || 0),
            total: parseFloat(cotizacionActualNota.total || 0)
          },
          condiciones: 'VENTA'
        };

        // Guardar en storage para la nueva ventana
        sessionStorage.setItem('datosNotaContrato', JSON.stringify(datosNota));
        localStorage.setItem('datosNotaContrato', JSON.stringify(datosNota));

        // Cerrar modal y abrir nota
        cerrarModalNotaPedido();
        const urlNota = `hoja_pedido2.html?ts=${Date.now()}`;
        window.open(urlNota, '_blank', 'width=1200,height=900,scrollbars=yes,resizable=yes');
        
        // Refrescar lista de cotizaciones para reflejar folio si fuese necesario
        if (typeof aplicarFiltros === 'function') aplicarFiltros();

        btn.innerHTML = originalHTML;
        btn.disabled = false;

      } catch (error) {
        console.error('[guardarYVerNotaPedido] Error:', error);
        alert('Ocurri√≥ un error al procesar la nota: ' + error.message);
        if (btn) {
           btn.innerHTML = originalHTML;
           btn.disabled = false;
        }
      }
    }
  </script>
  <script src="js/cotizaciones-modal.js"></script>

  <!-- Modal de Nota de Pedido para Ventas (Simplificado) -->
  <div id="modal-nota-pedido-venta" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 500px; width: 90%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div class="modal-header" style="flex-shrink: 0;">
        <h3 id="modal-nota-title">Nota de Pedido - VENTA</h3>
        <button class="modal-close" onclick="cerrarModalNotaPedido()">&times;</button>
      </div>
      
      <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 20px;">
        <h4 style="margin-top: 0; color: #263445; border-bottom: 2px solid #3498db; padding-bottom: 8px;">
          <i class="fa fa-truck"></i> Detalles de Env√≠o
        </h4>
        
        <!-- Contacto (Entrega/Recolecci√≥n) -->
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #263445;">
            <i class="fa fa-user"></i> Quien Recibe / Recoge:
          </label>
          <input type="text" id="nota-contacto" class="filter-group input" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 1rem;" placeholder="Nombre de quien recibe/recoge (Contacto de Entrega)">
        </div>
        
        <!-- Tel√©fono -->
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #263445;">
            <i class="fa fa-phone"></i> Tel√©fono:
          </label>
          <input type="text" id="nota-telefono" class="filter-group input" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 1rem;" placeholder="Tel√©fono del contacto">
        </div>
        
        <!-- Horario de Entrega -->
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: 600; margin-bottom: 5px; color: #263445;">
             <i class="fa fa-clock"></i> Horario de Entrega (Desde / Hasta):
          </label>
          <div style="display: flex; gap: 10px;">
            <input type="time" id="nota-hora-inicio" class="filter-group input" style="flex: 1; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
            <input type="time" id="nota-hora-fin" class="filter-group input" style="flex: 1; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
          </div>
        </div>

        <!-- M√©todo de Entrega -->
        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #263445;">
            <i class="fa fa-location-dot"></i> M√©todo de Entrega:
          </label>
          <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="radio" name="nota-metodo-entrega" value="domicilio" onchange="cambiarMetodoEntregaNota('domicilio')">
              <span>Domicilio</span>
            </label>
            <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
              <input type="radio" name="nota-metodo-entrega" value="sucursal" onchange="cambiarMetodoEntregaNota('sucursal')" checked>
              <span>Sucursal / Recolecci√≥n</span>
            </label>
          </div>
        </div>

        <!-- Selector de Almac√©n (solo visible en modo Sucursal) -->
        <div id="nota-selector-almacen" style="margin-bottom: 15px; display: none;">
          <label style="display: block; font-weight: 600; margin-bottom: 5px;">Selecciona Almac√©n:</label>
          <select id="nota-almacen-select" onchange="seleccionarAlmacenNota()" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; background: white;">
            <option value="">-- Selecciona un almac√©n --</option>
          </select>
        </div>

        <!-- Campos de Direcci√≥n -->
        <div id="nota-campos-direccion">
          <div style="margin-bottom: 12px;">
            <label style="display: block; font-weight: 600; margin-bottom: 5px;">Calle:</label>
            <input type="text" id="nota-calle" class="filter-group input" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 5px;">No. Ext:</label>
              <input type="text" id="nota-no-externo" class="filter-group input" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
            </div>
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 5px;">No. Int:</label>
              <input type="text" id="nota-no-interno" class="filter-group input" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
            </div>
          </div>

          <div style="margin-bottom: 12px;">
            <label style="display: block; font-weight: 600; margin-bottom: 5px;">Colonia:</label>
            <input type="text" id="nota-colonia" class="filter-group input" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 5px;">C.P.:</label>
              <input type="text" id="nota-cp" class="filter-group input" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
            </div>
            <div>
              <label style="display: block; font-weight: 600; margin-bottom: 5px;">Estado:</label>
              <input type="text" id="nota-estado" class="filter-group input" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
            </div>
          </div>

          <div style="margin-bottom: 12px;">
            <label style="display: block; font-weight: 600; margin-bottom: 5px;">Municipio:</label>
            <input type="text" id="nota-municipio" class="filter-group input" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px;">
          </div>
        </div>

        <!-- Notas adicionales -->
        <div style="margin-bottom: 12px;">
          <label style="display: block; font-weight: 600; margin-bottom: 5px;">Notas / Observaciones:</label>
          <textarea id="nota-observaciones" rows="3" style="width: 100%; padding: 8px; border: 1px solid #e0e0e0; border-radius: 4px; resize: vertical;"></textarea>
        </div>
      </div>

      <!-- Footer con botones -->
      <div class="modal-footer" style="flex-shrink: 0; display: flex; justify-content: space-between; padding: 15px; border-top: 1px solid #e0e0e0;">
        <button onclick="cerrarModalNotaPedido()" style="padding: 10px 15px; background: #95a5a6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
          <i class="fa fa-times"></i> Cancelar
        </button>
        <div style="display: flex; gap: 10px;">
          <!-- Bot√≥n "Ver Nota" (solo visible cuando ya hay datos) -->
          <button id="btn-ver-nota-directo" onclick="verNotaPedidoDirecto()" style="padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: none;">
            <i class="fa fa-eye"></i> Ver Nota
          </button>
          <!-- Bot√≥n principal (Generar/Actualizar) -->
          <button id="btn-guardar-ver-nota" onclick="guardarYVerNotaPedido()" style="padding: 10px 20px; background: #27ae60; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
            <i class="fa fa-file-pdf"></i> Generar Nota de Pedido
          </button>
        </div>
      </div>
    </div>
  </div>

</body>

</html>