<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Cotización de Venta</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
  <link rel="stylesheet" href="styles/cotizacion_venta.css" />
</head>
<body>
  <header class="cr-header">
    <div class="cr-container">
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
        <button id="cr-hamburger" class="cr-hamburger" aria-label="Abrir menú" aria-controls="cr-sidemenu" aria-expanded="false">
          <span></span><span></span><span></span>
        </button>
        <a href="cotizaciones.html" class="cr-btn cr-btn--ghost" style="text-decoration:none; display:inline-flex; align-items:center; gap:8px;">
          <i class="fa-solid fa-arrow-left"></i> Volver
        </a>
      </div>
      <!-- Backdrop y Menú lateral (agregados para Venta) -->
      <div id="cr-sidemenu-backdrop" class="cr-sidemenu-backdrop" hidden></div>
      <aside id="cr-sidemenu" class="cr-sidemenu" hidden aria-hidden="true">
        <div class="cr-sidemenu__head">
          <h3><i class="fa-solid fa-bars"></i> Menú</h3>
          <button type="button" class="cr-sidemenu__close" aria-label="Cerrar" data-close-menu>
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>
        <nav class="cr-sidemenu__nav">
          <a href="cotizaciones-lista.html" class="cr-menu-item"><i class="fa-solid fa-file-invoice"></i> Cotizaciones</a>
          <a href="inventario.html" class="cr-menu-item"><i class="fa-solid fa-boxes-stacked"></i> Inventario</a>
          <a href="clientes.html" class="cr-menu-item"><i class="fa-solid fa-user"></i> Clientes</a>
          <a href="configuracion.html" class="cr-menu-item"><i class="fa-solid fa-gear"></i> Configuración</a>
        </nav>
      </aside>
      <h1 class="cr-title">Catálogo de Productos para Venta</h1>
      <p class="cr-subtitle">Explora nuestro catálogo y selecciona los productos que necesitas.</p>

      <div class="cr-steps">
        <div class="cr-step cr-step--done">
          <span class="cr-step__number"><i class="fa-solid fa-check"></i></span>
          <span class="cr-step__label">Tipo</span>
        </div>

        <i class="fa-solid fa-arrow-right cr-step__arrow"></i>
        <div class="cr-step cr-step--active" id="cr-step-products">
          <span class="cr-step__number">2</span>
          <span class="cr-step__label">Productos</span>
        </div>
        <i class="fa-solid fa-arrow-right cr-step__arrow"></i>
        <div class="cr-step" id="cr-step-config">
          <span class="cr-step__number">3</span>
          <span class="cr-step__label">Configuración</span>
        </div>
        <i class="fa-solid fa-arrow-right cr-step__arrow"></i>
        <div class="cr-step" id="cr-step-shipping">
          <span class="cr-step__number">4</span>
          <span class="cr-step__label">Envío</span>
        </div>
      </div>

      <div class="cr-toolbar">
        <div class="cr-view-toggle" role="group" aria-label="Cambiar vista">
          <button id="cr-grid-btn" class="cr-toggle is-active"><i class="fa-solid fa-border-all"></i> Grid</button>
          <button id="cr-list-btn" class="cr-toggle"><i class="fa-solid fa-list"></i> Lista</button>
        </div>
      </div>

      <!-- Floating Notes FAB in header (outside cards) -->
      <button id="cr-notes-fab" class="cr-fab" type="button" title="Notas de Cotización" aria-label="Notas">
        <i class="fa-solid fa-note-sticky"></i>
        <span id="cr-notes-count" class="cr-fab__badge" hidden>0</span>
      </button>

      <!-- Floating Notes Window (draggable) -->
      <div id="cr-notes-floater" class="cr-floater" hidden>
        <div id="cr-notes-floater-head" class="cr-floater__header">
          <h3 id="cr-notes-title" style="margin:0; font-size:15px;"><i class="fa-solid fa-clipboard"></i> Notas de Cotización <span id="cr-notes-chip" class="cr-chip">0 notas</span></h3>
          <div class="cr-floater__actions">
            <button class="cr-floater__close" type="button" title="Cerrar" aria-label="Cerrar" data-close-notes>
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
        </div>
        <div class="cr-floater__body">
          <div class="cr-card" style="margin-bottom: 10px;">
            <h4 style="margin-top:0; display:flex; align-items:center; gap:8px; font-size:14px;">
              <i class="fa-solid fa-plus"></i> Agregar Nueva Nota
              <small id="cr-notes-step" class="cr-location-badge" style="margin-left:6px;">Paso actual</small>
            </h4>
            <div class="cr-row">
              <textarea id="cr-note-text" rows="3" placeholder="Escribe una nota sobre este paso del proceso..."></textarea>
              <div style="display:flex; align-items:center; justify-content: space-between; gap:10px;">
                <small style="color:#64748b;">Tip: Ctrl + Enter para guardar rápidamente</small>
                <button id="cr-note-save" class="cr-btn cr-btn--primary" type="button" style="width:auto;">
                  <i class="fa-solid fa-floppy-disk"></i> Guardar Nota
                </button>
              </div>
            </div>
          </div>
          <div id="cr-notes-list" class="cr-summary-list" style="max-height:40vh;"></div>
        </div>
      </div>
    </div>
  </header>

  <main class="cr-main cr-container">
    <!-- Sección Productos (Step 2) -->
    <section id="cr-products-section" class="cr-section cr-section--active fade-in">
      <aside class="cr-aside">
        <div class="cr-card">
          <h3 class="cr-card__title"><i class="fa-solid fa-location-dot"></i> Ubicación</h3>
          <div class="cr-input-icon">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input id="cr-location" type="text" placeholder="Código postal o ciudad" />
          </div>
          <div class="cr-location-current">
            <div class="cr-location-badge">Sede Principal</div>
            <div class="cr-location-name">CDMX</div>
            <div class="cr-location-address">Oriente 174 No. 290</div>
          </div>
          <div class="cr-popular">
            <button class="cr-chip" data-city="CDMX">CDMX</button>
            <button class="cr-chip" data-city="EdoMex">EdoMex</button>
            <button class="cr-chip" data-city="Puebla">Puebla</button>
          </div>
        </div>

        <div class="cr-card">
          <div class="cr-card__row">
            <h3 class="cr-card__title"><i class="fa-solid fa-sliders"></i> Filtros</h3>
            <button id="cr-toggle-filters" class="cr-link" disabled title="Los filtros permanecen visibles">Siempre visible</button>
          </div>
          <div id="cr-filters" class="cr-filters">
            <div style="color:var(--text-muted); font-size:12px; margin-bottom:6px;">Selecciona una categoría</div>
            <label class="cr-filter-pill"><input type="radio" name="cr-category" value="marco_cruceta" checked /><span>Marco y cruceta</span></label>
            <label class="cr-filter-pill"><input type="radio" name="cr-category" value="multidireccional" /><span>Multidireccional</span></label>
            <label class="cr-filter-pill"><input type="radio" name="cr-category" value="templetes" /><span>Templetes</span></label>
          </div>
        </div>

        <!-- Carrito de selección (movido a área principal para ancho completo) -->

        <div class="cr-card cr-card--muted">
          <div class="cr-count"><i class="fa-solid fa-cube"></i> <span id="cr-found-count">0</span> productos encontrados</div>
        </div>
      </aside>

      <div class="cr-catalog">
        <!-- Datos de Cotización (ancho igual al catálogo) -->
        <div class="cr-card" id="v-quote-header" style="display:grid; gap:10px; margin-bottom:12px;">
          <h3 class="cr-card__title"><i class="fa-solid fa-file-invoice"></i> Datos de Cotización</h3>
          <!-- Fila 1: Buscador + Número y Fecha de Cotización -->
          <div class="cr-form-grid" style="display:grid; grid-template-columns: 1fr auto auto; gap:10px; align-items:center;">
            <div class="cr-input-icon" style="min-width:280px;">
              <i class="fa-solid fa-magnifying-glass"></i>
              <input id="v-search-code" type="text" placeholder="Código de producto o descripción">
            </div>
            <div class="cr-row" style="display:flex; align-items:center; gap:8px;">
              <label for="v-quote-number" style="white-space:nowrap; color:#64748b; font-size:12px;">Cotización No.</label>
              <input id="v-quote-number" type="text" class="cr-input" style="width:140px;" readonly>
            </div>
            <div class="cr-row" style="display:flex; align-items:center; gap:8px;">
              <i class="fa-regular fa-calendar"></i>
              <input id="v-quote-date" type="date" class="cr-input" style="width:160px;">
            </div>
          </div>

          <!-- Fila 2: Tamaño / Configuración / Moneda / Tipo de cambio -->
          <div class="cr-form-grid" style="display:grid; grid-template-columns: 1fr auto auto auto; gap:10px; align-items:center;">
            <div class="cr-input-group">
              <div class="cr-addon" title="Tamaño">
                <i class="fa-regular fa-file-lines"></i>
              </div>
              <div class="cr-input-icon" style="flex:1;">
                <select id="v-size" class="cr-input" aria-label="Tamaño de impresión">
                  <option value="carta" selected>Tamaño Carta</option>
                  <option value="oficio">Tamaño Oficio</option>
                  <option value="a4">A4</option>
                  <option value="a5">A5</option>
                </select>
              </div>
            </div>
            <div class="cr-row" style="display:flex; align-items:center; gap:8px;">
              <select id="v-currency" class="cr-input" style="height:36px; min-width:96px;">
                <option value="MXN" selected>MXN</option>
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
              </select>
            </div>
            <div id="v-exchange-wrap" style="display:flex; align-items:center; gap:8px; justify-self:end;">
              <span class="cr-chip cr-chip--mono" id="v-currency-badge">MXN</span>
              <input id="v-exchange" type="number" step="0.000001" value="1.000000" class="cr-input" style="width:140px; text-align:right;" title="Tipo de cambio">
            </div>
          </div>

          <!-- Fila 3: Público en general / Campo adicional / Acción -->
          <div class="cr-form-grid" style="display:grid; grid-template-columns: 1fr 1fr auto; gap:10px; align-items:center;">
            <div class="cr-input-icon">
              <i class="fa-regular fa-circle-question"></i>
              <select id="v-customer-type" class="cr-input">
                <option value="publico" selected>Público en General</option>
                <option value="distribuidor">Distribuidor</option>
                <option value="gobierno">Gobierno</option>
                <option value="corporativo">Corporativo</option>
              </select>
            </div>
            <div class="cr-input-group">
              <div class="cr-addon" title="Cliente">
                <i class="fa-regular fa-address-card"></i>
              </div>
              <div class="cr-input-icon" style="flex:1;">
                <span id="v-client-label" style="display:inline-block; min-height:20px; padding:4px 8px; color:#1f2937;">-</span>
                <input id="v-extra" type="hidden" title="Cliente seleccionado">
              </div>
              <a href="#" id="v-pick-client" class="cr-btn cr-btn--ghost" title="Seleccionar cliente">
                <i class="fa-solid fa-users"></i>
              </a>
            </div>
            
          </div>
        </div>
        <script>
          // Inicialización ligera del encabezado de cotización en Venta (fecha y número)
          (function(){
            try {
              const dateEl = document.getElementById('v-quote-date');
              if (dateEl && !dateEl.value) {
                const hoy = new Date().toISOString().split('T')[0];
                dateEl.value = hoy;
              }
            } catch {}
            try {
              const numEl = document.getElementById('v-quote-number');
              if (numEl && !numEl.value) {
                const d = new Date();
                const id = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}`;
                numEl.value = id;
              }
            } catch {}

            // --- Lógica de Moneda y Tipo de cambio (compacta y segura) ---
            try {
              const currencySel = document.getElementById('v-currency');
              const exchangeInp = document.getElementById('v-exchange');
              const currencyBadge = document.getElementById('v-currency-badge');
              if (currencySel && exchangeInp) {
                const fmt6 = (v) => {
                  const n = Number(v);
                  return (isFinite(n) ? n : 1).toFixed(6);
                };
                const applyCurrencyRules = () => {
                  const cur = currencySel.value;
                  if (cur === 'MXN') {
                    exchangeInp.value = '1.000000';
                    exchangeInp.setAttribute('disabled', '');
                  } else {
                    exchangeInp.removeAttribute('disabled');
                    if (!exchangeInp.value) exchangeInp.value = '1.000000';
                    exchangeInp.value = fmt6(exchangeInp.value);
                  }
                  if (currencyBadge) currencyBadge.textContent = cur;
                  // notificar posibles listeners existentes
                  exchangeInp.dispatchEvent(new Event('input', { bubbles: true }));
                  exchangeInp.dispatchEvent(new Event('change', { bubbles: true }));
                };
                currencySel.addEventListener('change', applyCurrencyRules);
                // sincronizar badge también en cambio de select (por si hay otros listeners)
                currencySel.addEventListener('change', () => { if (currencyBadge) currencyBadge.textContent = currencySel.value; });
                exchangeInp.addEventListener('blur', () => {
                  exchangeInp.value = fmt6(exchangeInp.value);
                  exchangeInp.dispatchEvent(new Event('input', { bubbles: true }));
                  exchangeInp.dispatchEvent(new Event('change', { bubbles: true }));
                });
                // estado inicial
                applyCurrencyRules();
                if (currencyBadge) currencyBadge.textContent = currencySel.value;
              }
            } catch {}

            // Vincular selector de clientes con clientes.html sin romper lógica
            const CLIENT_KEY = 'cr_selected_client';
            function populateClientFromStorage() {
              try {
                const raw = localStorage.getItem(CLIENT_KEY);
                if (!raw) return;
                const data = JSON.parse(raw);
                const input = document.getElementById('v-extra');
                if (input && data && (data.nombre || data.name)) {
                  input.value = data.nombre || data.name;
                  input.dispatchEvent(new Event('input', { bubbles: true }));
                  input.dispatchEvent(new Event('change', { bubbles: true }));
                }
              } catch {}
            }
            // abrir clientes en nueva pestaña (o misma si se desea en el futuro)
            try {
              const btn = document.getElementById('v-pick-client');
              const input = document.getElementById('v-extra');
              const openClients = () => window.open('clientes.html?pick=1', '_blank', 'noopener');
              btn?.addEventListener('click', (e) => { e.preventDefault(); openClients(); });
              // doble click o icono para abrir desde el input
              input?.addEventListener('dblclick', openClients);
              // cuando regrese el foco a la pestaña, intentar leer el cliente seleccionado
              window.addEventListener('focus', populateClientFromStorage);
              // también escuchar eventos de almacenamiento (por si se elige con postMessage/localStorage)
              window.addEventListener('storage', (ev) => { if (ev.key === CLIENT_KEY) populateClientFromStorage(); });
              // intento inicial
              populateClientFromStorage();
            } catch {}
          })();
          
          // --- Modal de clientes: abrir/cerrar y sincronización ---
          (function(){
            const MODAL_ID = 'v-client-modal';
            const CLIENT_KEY = 'cr_selected_client';
            const modal = document.getElementById(MODAL_ID);
            const btnOpen = document.getElementById('v-pick-client');
            const btnCloses = modal?.querySelectorAll('[data-client-close]');
            const iframe = document.getElementById('v-client-iframe');
            const label = document.getElementById('v-client-label');
            const hidden = document.getElementById('v-extra');

            const setSelectedClient = (data) => {
              try {
                if (!data) return;
                const name = data.nombre || data.name || data.razon_social || '-';
                if (label) label.textContent = name;
                if (hidden) hidden.value = name; // conservar lógica que lee v-extra
                // Notificar a cualquier listener existente
                hidden?.dispatchEvent(new Event('input', { bubbles: true }));
                hidden?.dispatchEvent(new Event('change', { bubbles: true }));
              } catch {}
            };

            const activateClientesTab = () => {
              try {
                const doc = iframe?.contentDocument || iframe?.contentWindow?.document;
                const btn = doc?.querySelector('button.tab[data-section="clientes"]');
                btn?.click?.();
                // además, enviar postMessage por si clientes.html escucha
                iframe?.contentWindow?.postMessage({ type: 'activate-tab', section: 'clientes' }, window.origin || '*');
              } catch {}
            };
            const openModal = (e) => {
              e?.preventDefault?.(); if (!modal) return;
              // forzar que la vista predeterminada sea Clientes
              if (iframe) {
                try { iframe.removeEventListener('load', activateClientesTab); } catch {}
                iframe.src = 'clientes.html?pick=1#clientes';
                iframe.addEventListener('load', () => {
                  activateClientesTab();
                  // intento adicional tras un tick por si hay mounting tardío
                  setTimeout(activateClientesTab, 200);
                }, { once: true });
              }
              modal.hidden = false; modal.setAttribute('aria-hidden','false');
            };
            const closeModal = () => { if (!modal) return; modal.hidden = true; modal.setAttribute('aria-hidden','true'); };

            btnOpen?.addEventListener('click', openModal);
            btnCloses?.forEach(b => b.addEventListener('click', closeModal));
            // Cerrar con ESC
            document.addEventListener('keydown', (ev) => { if (!modal?.hidden && ev.key === 'Escape') closeModal(); });
            // Click en backdrop
            modal?.querySelector('.cr-modal__backdrop')?.addEventListener('click', closeModal);

            // postMessage desde clientes.html (mismo origen)
            window.addEventListener('message', (ev) => {
              try {
                const msg = ev.data;
                if (!msg || typeof msg !== 'object') return;
                if (msg.type === 'select-client' && msg.payload) {
                  // guardar también en storage para persistencia cruzada
                  localStorage.setItem(CLIENT_KEY, JSON.stringify(msg.payload));
                  setSelectedClient(msg.payload);
                  closeModal();
                }
              } catch {}
            });

            // Fallback: si la selección escribe en localStorage
            window.addEventListener('storage', (ev) => { if (ev.key === CLIENT_KEY) { try { setSelectedClient(JSON.parse(ev.newValue)); closeModal(); } catch {} } });
          })();
        </script>
        
        <!-- Modal de selección de clientes (embebe clientes.html) -->
        <div id="v-client-modal" class="cr-modal" hidden aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="v-client-modal-title">
          <div class="cr-modal__backdrop" data-client-close></div>
          <div class="cr-modal__dialog" role="document" style="width:min(900px,96vw);height:min(80vh,900px);display:flex;flex-direction:column;">
            <div class="cr-modal__header">
              <h3 id="v-client-modal-title" class="cr-card__title" style="margin:0;display:flex;align-items:center;gap:8px;"><i class="fa-solid fa-users"></i> Seleccionar cliente</h3>
              <button class="cr-modal__close" type="button" title="Cerrar" aria-label="Cerrar" data-client-close>
                <i class="fa-solid fa-xmark"></i>
              </button>
            </div>
            <div class="cr-modal__body" style="padding:0;flex:1;">
              <iframe id="v-client-iframe" src="clientes.html?pick=1" style="border:0;width:100%;height:100%;"></iframe>
            </div>
          </div>
        </div>
        <div class="cr-carousel-wrap">
          <button type="button" class="cr-car-btn prev" id="cr-car-prev" aria-label="Anterior"><i class="fa-solid fa-chevron-left"></i></button>
          <div id="cr-products" class="cr-grid"></div>
          <button type="button" class="cr-car-btn next" id="cr-car-next" aria-label="Siguiente"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
        <!-- Cart full-width moved below products grid -->
        <div class="cr-card" style="width:100%; margin-top:12px;">
          <div class="cr-card__row">
            <h3 class="cr-card__title"><i class="fa-solid fa-cart-plus"></i> Seleccionados</h3>
            <div style="display:flex; align-items:center; gap:10px;">
              <div id="cr-cart-count-wrap" class="cr-count"><i class="fa-solid fa-cubes"></i> <span id="cr-cart-count">0</span> ítems</div>
              <button id="cr-clear-cart" class="cr-btn cr-btn--ghost" title="Vaciar carrito"><i class="fa-solid fa-trash"></i> Vaciar</button>
            </div>
          </div>
          <div id="cr-cart-list" style="display:flex; flex-direction:column; gap:8px; max-height:260px; overflow:auto;"></div>
          <div id="cr-cart-subtotal" style="display:flex; justify-content:flex-end; gap:12px; align-items:center; margin-top:8px;">
            <span style="color:#64748b;">Subtotal (diario):</span>
            <strong id="cr-cart-subtotal-value" style="font-size:16px; color:#2563eb;">$0</strong>
          </div>
          <div style="display:flex; justify-content:flex-end;">
            <button id="cr-go-config" class="cr-btn cr-btn--primary" type="button" style="margin-top:10px;">
              Continuar <i class="fa-solid fa-arrow-right"></i>
            </button>
          </div>
        </div>
        <div class="cr-results-foot">
          <i class="fa-regular fa-circle-info"></i>
          <span id="cr-results-text">Mostrando 0 productos</span>
        </div>
      </div>
    </section>

    <!-- Sección Configuración (Step 3) -->
    <section id="cr-config-section" class="cr-section" hidden>
      <div class="cr-config-layout">
        <aside class="cr-config-side">
          <div class="cr-card">
            <img id="cr-selected-image" class="cr-selected-image" alt="Producto" hidden />
            <!-- Lista de módulos seleccionados dentro de la ficha enfocada -->
            <div id="cr-focused-list" class="cr-side-list cr-scroll" aria-label="Módulos seleccionados" style="margin-top:8px;"></div>
            <h3 id="cr-selected-name" class="cr-selected-title" hidden>-</h3>
            <p id="cr-selected-desc" class="cr-selected-desc" hidden>-</p>

            <div class="cr-selected-meta" hidden>
              <div><strong>SKU:</strong> <span id="cr-selected-sku">-</span></div>
              <div><strong>Marca:</strong> <span id="cr-selected-brand">-</span></div>
              <div><strong>Stock:</strong> <span id="cr-selected-stock">-</span></div>
            </div>

          

            <div class="cr-prices" hidden>
              <div>Diario: <strong id="cr-price-daily">$0</strong></div>
            </div>

            

          </div>
          <button id="cr-back-to-products" class="cr-btn cr-btn--ghost"><i class="fa-solid fa-arrow-left"></i> Volver a Productos</button>
        </aside>

        <div class="cr-config-main">
          <div class="cr-card">
            <h3 class="cr-card__title"><i class="fa-solid fa-list-check"></i> Productos seleccionados</h3>
            <div id="cr-summary-list" class="cr-summary-list cr-scroll"></div>
          </div>

          <div class="cr-card cr-card--muted" style="border:1px solid #e2e8f0;">
            <div class="cr-total">
              <div class="cr-total__label">Total estimado</div>
              <div id="cr-total" class="cr-total__value">$0</div>
              <div id="cr-total-detail" class="cr-total__detail">-</div>
            </div>
          </div>

          <!-- Ancla para accesorios -->
          <div id="cr-acc-anchor" style="position:relative; top:-14px; height:1px;"></div>
          <div class="cr-accesorios">
            <div class="cr-card">
              <div class="cr-card__row" style="margin-bottom:8px;">
                <h3 id="cr-acc-title" style="margin:0;"><i class="fa-solid fa-clipboard-list"></i> Accesorios complementarios</h3>
                <div>
                  <button id="cr-acc-toggle" class="cr-btn cr-btn--primary cr-btn--sm" type="button">
                    <i class="fa-solid fa-plus"></i> Agregar accesorios
                  </button>
                  <span id="cr-acc-badge" class="cr-acc-badge" hidden><i class="fa-solid fa-puzzle-piece"></i> <span id="cr-acc-badge-count">0</span></span>
                </div>
              </div>
              <p class="cr-note" style="margin-top:0;">
                <i class="fa-regular fa-circle-question"></i>
                Primero selecciona los accesorios que necesitas.
              </p>
              <!-- cuerpo colapsable de accesorios -->
              <div id="cr-acc-body" hidden>
              <h4>Seleccione los productos de complemento para estos Productos</h4>

              <!-- Filtros: búsqueda y subcategorías -->
              <div class="cr-acc-filters cr-acc-filters--row">
                <div class="cr-acc-search">
                  <i class="fa-solid fa-magnifying-glass"></i>
                  <input id="cr-accessory-search" type="text" placeholder="Buscar accesorios..." />
                  <button id="cr-acc-clear" class="cr-acc-clear" type="button" title="Limpiar búsqueda" aria-label="Limpiar">
                    <i class="fa-solid fa-xmark"></i>
                  </button>
                </div>
                <div class="cr-acc-subcat-select">
                  <label for="cr-acc-subcat" class="cr-acc-label">Subcategorías</label>
                  <select id="cr-acc-subcat">
                    <option value="todas" selected>Todas las subcategorías</option>
                    <option value="ruedas">Ruedas</option>
                    <option value="plataformas">Plataformas</option>
                    <option value="escaleras">Escaleras</option>
                    <option value="tornillos">Tornillos</option>
                  </select>
                </div>
                <div class="cr-acc-sort">
                  <label for="cr-acc-sort" class="cr-acc-label">Ordenar por</label>
                  <select id="cr-acc-sort">
                    <option value="name">Nombre (A–Z)</option>
                    <option value="stock">Stock (mayor a menor)</option>
                  </select>
                </div>
                <div class="cr-acc-count"><span id="cr-accessory-count">0</span> accesorios encontrados</div>
              </div>

              <!-- Lista de productos complementarios -->
              <div id="cr-accessories" class="cr-grid">
                <div class="cr-card cr-acc-item" data-name="Rueda 8\" con freno" data-subcat="ruedas" data-stock="20" data-price="350">
                  <img class="accesorios" src="img/default.jpg" alt="Rueda con freno" />
                  <h3 class="cr-product__name">Rueda 8" con freno</h3>
                  <p class="cr-product__desc">Rueda para andamio con sistema de freno, diámetro 8".</p>
                  <div class="cr-product__meta">
                    <div><i class="fa-solid fa-hashtag"></i> <strong>SKU:</strong> RU-008-F</div>
                    <div><i class="fa-solid fa-tags"></i> <strong>Subcat:</strong> Ruedas</div>
                    <div><i class="fa-solid fa-boxes-stacked"></i> <strong>Stock:</strong> 20</div>
                  </div>
                  <small style="color:#64748b;"><i class="fa-solid fa-dollar-sign"></i> Precio ref.: $350</small>
                </div>

                <div class="cr-card cr-acc-item" data-name="Plataforma 2.0m antideslizante" data-subcat="plataformas" data-stock="15" data-price="1200">
                  <img src="img/default.jpg" alt="Plataforma" />
                  <h3 class="cr-product__name">Plataforma 2.0m antideslizante</h3>
                  <p class="cr-product__desc">Plataforma con superficie antideslizante y ganchos de seguridad.</p>
                  <div class="cr-product__meta">
                    <div><i class="fa-solid fa-hashtag"></i> <strong>SKU:</strong> PL-200-ANT</div>
                    <div><i class="fa-solid fa-tags"></i> <strong>Subcat:</strong> Plataformas</div>
                    <div><i class="fa-solid fa-boxes-stacked"></i> <strong>Stock:</strong> 15</div>
                  </div>
                  <small style="color:#64748b;"><i class="fa-solid fa-dollar-sign"></i> Precio ref.: $1,200</small>
                </div>

                <div class="cr-card cr-acc-item" data-name="Escalera interna 2.0m" data-subcat="escaleras" data-stock="10" data-price="900">
                  <img src="img/default.jpg" alt="Escalera" />
                  <h3 class="cr-product__name">Escalera interna 2.0m</h3>
                  <p class="cr-product__desc">Escalera modular interna compatible con sistemas Marco/Cruceta.</p>
                  <div class="cr-product__meta">
                    <div><i class="fa-solid fa-hashtag"></i> <strong>SKU:</strong> ES-INT-200</div>
                    <div><i class="fa-solid fa-tags"></i> <strong>Subcat:</strong> Escaleras</div>
                    <div><i class="fa-solid fa-boxes-stacked"></i> <strong>Stock:</strong> 10</div>
                  </div>
                  <small style="color:#64748b;"><i class="fa-solid fa-dollar-sign"></i> Precio ref.: $900</small>
                </div>

                <div class="cr-card cr-acc-item" data-name="Tornillo nivelador 0.5m" data-subcat="tornillos" data-stock="40" data-price="250">
                  <img src="img/default.jpg" alt="Tornillo nivelador" />
                  <h3 class="cr-product__name">Tornillo nivelador 0.5m</h3>
                  <p class="cr-product__desc">Tornillo nivelador para ajuste fino de altura.</p>
                  <div class="cr-product__meta">
                    <div><i class="fa-solid fa-hashtag"></i> <strong>SKU:</strong> TN-050</div>
                    <div><i class="fa-solid fa-tags"></i> <strong>Subcat:</strong> Tornillos</div>
                    <div><i class="fa-solid fa-boxes-stacked"></i> <strong>Stock:</strong> 40</div>
                  </div>
                  <small style="color:#64748b;"><i class="fa-solid fa-dollar-sign"></i> Precio ref.: $250</small>
                </div>
              </div>
              </div> <!-- fin cuerpo colapsable -->
              <!-- Resumen de accesorios seleccionados (siempre visible) -->
              <div class="cr-card cr-card--muted" id="cr-acc-summary-card" style="margin-top:12px; border:1px solid #e2e8f0;">
                <h3 class="cr-card__title"><i class="fa-solid fa-puzzle-piece"></i> Accesorios seleccionados</h3>
                <div id="cr-acc-summary-list" class="cr-summary-list cr-scroll" aria-label="Accesorios seleccionados" style="margin-bottom:8px;"></div>
                <div class="cr-total">
                  <div class="cr-total__label">Total accesorios</div>
                  <div id="cr-acc-total" class="cr-total__value">0</div>
                  <div id="cr-acc-total-detail" class="cr-total__detail">Sin accesorios seleccionados</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Ancla para posicionar el scroll justo antes de las cards de Período de Renta -->
          <div id="cr-config-anchor" style="position:relative; top:-16px; height:1px;"></div>

          <!-- Total combinado módulos + accesorios (Venta) -->
          <div class="cr-card cr-card--muted" style="border:1px solid #e2e8f0;">
            <div class="cr-total">
              <div class="cr-total__label">Total módulos + accesorios</div>
              <div id="cr-grand-total" class="cr-total__value">$0</div>
              <div id="cr-grand-total-detail" class="cr-total__detail">-</div>
            </div>
          </div>

          <div class="cr-actions" style="margin-top: 10px; justify-content: flex-end;">
            <button id="cr-go-shipping" class="cr-btn cr-btn--primary" type="button">Continuar a Envío <i class="fa-solid fa-arrow-right"></i></button>
          </div>

          
              
            </div>
          </div>

          

          <!-- Total final con entrega (opcional) - Guardado para uso futuro
          <div class="cr-card cr-card--muted" style="border:1px solid #e2e8f0;">
            <div class="cr-total">
              <div class="cr-total__label">Total final (con entrega)</div>
              <div id="cr-final-total" class="cr-total__value">$0</div>
              <div id="cr-final-total-detail" class="cr-total__detail">Incluye entrega: $0</div>
            </div>
          </div>
          -->

          <!-- Entrega y Observaciones movidos al Paso 4 (no mostrar en Paso 3)
          <div class="cr-card">
            <h3 class="cr-card__title"><i class="fa-solid fa-truck"></i> Entrega</h3>
            <label class="cr-switch">
              <input id="cr-need-delivery" type="checkbox" checked />
              <span>Requiere entrega y recogida en obra</span>
            </label>
            <div class="cr-grid-2">
              <input id="cr-delivery-address" type="text" placeholder="Dirección completa donde se requiere la entrega..." />
              <input id="cr-delivery-notes" type="text" placeholder="Instrucciones especiales..." />
            </div>
            <div class="cr-note" id="cr-delivery-extra">Costo adicional de entrega: $0</div>
          </div>

          <div class="cr-card">
            <h3 class="cr-card__title"><i class="fa-regular fa-note-sticky"></i> Observaciones</h3>
            <textarea id="cr-observations" rows="3" placeholder="Comentarios adicionales, requisitos especiales, condiciones..."></textarea>
          </div>
          -->

          <!-- Botón de Agregar a Cotización oculto en Paso 3 (se mostrará en Paso 4 si se requiere más adelante)
          <div class="cr-actions">
            <button id="cr-add-to-quote" class="cr-btn cr-btn--primary">Agregar a Cotización <i class="fa-solid fa-arrow-right"></i></button>
          </div>
          -->
        </div>
      </div>
    </section>

    <!-- Nueva Sección Envío y Mapa (Step 4) -->
    <section id="cr-shipping-section" class="cr-section" hidden>
      <div class="cr-card">
        <h3><i class="fa-solid fa-map-location-dot"></i> Detalles de Envío</h3>
        <p>Confirma tu ubicación en el mapa y completa los detalles de envío.</p>

        <div style="display:flex; align-items:center; gap:10px; flex-wrap: wrap;">
          <div class="cr-input-icon" style="flex:1; min-width:260px; max-width:520px;">
            <i class="fa-solid fa-magnifying-glass"></i>
            <input id="cr-search-address" type="text" placeholder="Buscar dirección o código postal..." />
          </div>
          <button onclick="searchLocation()" class="cr-btn"><i class="fa-solid fa-search"></i> Buscar</button>
        </div>

        <!-- Método de Entrega -->
        <div class="cr-card" style="margin-top:12px;">
          <h3 class="cr-card__title"><i class="fa-solid fa-route"></i> Método de Entrega</h3>
          <div class="cr-radio-group cr-radio-group--pills" role="radiogroup" aria-label="Método de entrega">
            <label class="cr-radio-pill"><input type="radio" name="deliveryMethod" id="delivery-branch-radio"><span>Entrega en Sucursal</span></label>
            <label class="cr-radio-pill"><input type="radio" name="deliveryMethod" id="delivery-home-radio" checked><span>Entrega a Domicilio</span></label>
          </div>
        </div>

        <!-- Seleccionar Sucursal (solo visible cuando Entrega en Sucursal) -->
        <div id="cr-branch-card" class="cr-card" style="margin-top:12px; display:none;">
          <h3 class="cr-card__title"><i class="fa-solid fa-store"></i> Seleccionar Sucursal</h3>
          <div class="cr-form-grid">
            <div class="cr-row full-width">
              <label for="cr-branch-select">Sucursal de Entrega</label>
              <select id="cr-branch-select" class="cr-input">
                <option value="" selected>Selecciona una sucursal</option>
                <option value="centro">Sucursal Centro — Av. Juárez 123, Col. Centro</option>
                <option value="norte">Sucursal Norte — Av. Revolución 456, Col. Satélite</option>
                <option value="sur">Sucursal Sur — Av. Insurgentes 789, Col. Del Valle</option>
                <option value="oriente">Sucursal Oriente — Av. Zaragoza 321, Col. Jardines</option>
              </select>
            </div>
            <div id="cr-branch-summary" class="cr-note full-width" hidden>
              Sucursal seleccionada: <strong id="cr-branch-name">-</strong>
            </div>
          </div>
        </div>

        <div id="cr-home-delivery-wrap">
        <!-- Detalles de Entrega a Domicilio -->
        <div class="cr-card" style="margin-top:12px;">
          <h3 class="cr-card__title"><i class="fa-solid fa-truck"></i> Detalles de Entrega a Domicilio</h3>
          <label class="cr-switch" style="margin-bottom:10px;">
            <input id="cr-need-delivery" type="checkbox" checked />
            <span>Requiere entrega y recogida en obra</span>
          </label>
          <div class="cr-form-grid">
            <div class="cr-row"><label>Calle</label><input class="cr-input" id="cr-delivery-street" /></div>
            <div class="cr-row"><label>Número Exterior</label><input class="cr-input" id="cr-delivery-ext" /></div>
            <div class="cr-row"><label>Número Interior</label><input class="cr-input" id="cr-delivery-int" /></div>
            <div class="cr-row"><label>Colonia</label><input class="cr-input" id="cr-delivery-colony" /></div>
            <div class="cr-row"><label>Código Postal</label><input class="cr-input" id="cr-delivery-zip" /></div>
            <div class="cr-row"><label>Municipio / Alcaldía</label><input class="cr-input" id="cr-delivery-city" /></div>
            <div class="cr-row"><label>Estado</label><input class="cr-input" id="cr-delivery-state" /></div>
            <div class="cr-row full-width"><label>Referencia</label><textarea class="cr-input" rows="2" id="cr-delivery-reference"></textarea></div>
          </div>
        </div>

        <!-- Costo de Envío (visual + acciones) -->
        <div class="cr-card cr-card--muted" style="margin-top:12px; border:1px solid #e2e8f0;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
            <h3 class="cr-card__title" style="margin:0;">Costo de Envío</h3>
            <button id="open-google-maps-btn" class="cr-btn cr-btn--sm cr-btn--ghost" type="button" title="Abrir Google Maps">Abrir Maps</button>
          </div>
          <p class="cr-subtitle">Calcula el costo de envío basado en kilómetros y tipo de zona.</p>
          <div class="cr-form-grid">
            <div class="cr-row"><label>Kilómetros</label><input class="cr-input" type="number" min="0" step="0.1" id="cr-delivery-distance"></div>
            <div class="cr-row"><label>Tipo de Zona</label>
              <select class="cr-input" id="cr-zone-type">
                <option value="metropolitana">Metropolitana</option>
                <option value="foraneo">Foráneo</option>
              </select>
            </div>
          </div>
          <div class="cr-actions" style="margin-top:10px; flex-wrap:wrap; gap:8px;">
            <button id="calculate-shipping-cost-btn" class="cr-btn" type="button">Calcular Envío</button>
          </div>
          <input id="cr-delivery-cost" type="hidden" />
          <div class="cr-total" style="margin-top:12px;">
            <div class="cr-total__label">Costo estimado de Envío</div>
            <div class="cr-total__value" id="cr-delivery-cost-display">$0</div>
          </div>
          <div id="cr-delivery-cost-formula" class="cr-hint" style="margin-top:6px;">No se cobra envío cuando km ≤ 5</div>
        </div>

        <!-- Observaciones (migrada desde Paso 3) -->
        <div class="cr-card" style="margin-top:12px;">
          <h3 class="cr-card__title"><i class="fa-regular fa-note-sticky"></i> Observaciones</h3>
          <div class="cr-obsv-head">
            <span class="cr-hint">Comparte indicaciones para entrega, horarios, referencias o restricciones de acceso.</span>
            <span id="cr-observations-counter" class="cr-counter">0/500</span>
          </div>
          <textarea id="cr-observations" maxlength="500" rows="3" class="cr-textarea-lg" placeholder="Ejemplo: La obra tiene acceso por Calle Cedro, horario de 8am a 6pm, solicitar entrada a vigilancia..."></textarea>
        </div>


        <!-- Datos de contacto (extendido) -->
        <div class="cr-card" style="margin-top:12px;">
          <h3 class="cr-card__title"><i class="fa-solid fa-address-card"></i> Datos de contacto</h3>
          <label class="cr-switch" style="margin-bottom:10px;">
            <input id="cr-contact-use-delivery" type="checkbox" />
            <span>Usar datos de entrega (CP, Municipio/Alcaldía, Estado)</span>
          </label>
          <div class="cr-form-grid">
            <div class="cr-row"><label>Nombre de contacto</label><input class="cr-input" id="cr-contact-name" /></div>
            <div class="cr-row"><label>Teléfono</label><input class="cr-input" id="cr-contact-phone" /></div>
            <div class="cr-row"><label>Correo</label><input class="cr-input" type="email" id="cr-contact-email" /></div>

            <div class="cr-row"><label>Atención (Atn.)</label><input class="cr-input" id="cr-contact-attn" /></div>
            <div class="cr-row"><label>Empresa</label><input class="cr-input" id="cr-contact-company" /></div>
            <div class="cr-row"><label>Condiciones</label>
              <select class="cr-input" id="cr-contact-condicion">
                <option value="fisica">Persona Física</option>
                <option value="moral">Persona Moral</option>
              </select>
            </div>

            <div class="cr-row"><label>Celular</label><input class="cr-input" id="cr-contact-mobile" /></div>
            <div class="cr-row"><label>C.P.</label><input class="cr-input" id="cr-contact-zip" /></div>
            <div class="cr-row"><label>País</label><input class="cr-input" id="cr-contact-country" value="México" /></div>

            <div class="cr-row"><label>Estado</label><input class="cr-input" id="cr-contact-state" /></div>
            <div class="cr-row"><label>Mun. o Alc.</label><input class="cr-input" id="cr-contact-municipio" /></div>
            <div class="cr-row full-width"><label>Descripción</label><textarea class="cr-input" rows="2" id="cr-contact-notes"></textarea></div>
          </div>
          <div class="cr-actions" style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px;">
            <button id="cr-save-contact" class="cr-btn cr-btn--primary" type="button"><i class="fa-solid fa-floppy-disk"></i> Guardar datos</button>
          </div>
        </div>
        <!-- Resumen de Cotización (Paso 4) -->
        <div class="cr-card" id="cr-quote-summary-card" style="margin-top:12px; display:none;">
          <div class="cr-card__row" style="justify-content:space-between; align-items:center; gap:12px;">
            <h3 class="cr-card__title" style="margin:0;"><i class="fa-solid fa-file-invoice"></i> Resumen de Cotización</h3>
            <!-- Toolbar de descuento (derecha) -->
            <div class="cr-toolbar" style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
              <label style="font-size:12px; color:#475569;">Aplica descuento:</label>
              <select id="cr-summary-apply-discount" class="cr-input cr-input--sm" style="max-width:110px;">
                <option value="no" selected>NO</option>
                <option value="si">SÍ</option>
              </select>
              <label for="cr-summary-discount-percent-input" style="font-size:12px; color:#475569;">%</label>
              <input id="cr-summary-discount-percent-input" type="number" min="0" max="100" step="0.5" class="cr-input cr-input--sm" style="width:90px;" value="0" />
            </div>
          </div>
          <div class="cr-summary-wrap" style="overflow:auto; margin-top:8px;">
            <style>
              /* Centrar encabezados y celdas únicamente en la tabla de resumen */
              .cr-table--summary th,
              .cr-table--summary td { text-align: center; vertical-align: middle; }
              .cr-table--summary th { font-weight: 700; }
              .cr-table--summary td { padding: 8px 10px; }
            </style>
            <table class="cr-table cr-table--summary" style="width:100%; border-collapse:collapse; min-width:920px;">
              <thead>
                <tr>
                  <th>Exist.</th>
                  <th>Part.</th>
                  <th>Clave</th>
                  <th>Descripción</th>
                  <th>Cant.</th>
                  <th>P. Unit.</th>
                  <th>% Desc</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody id="cr-summary-rows">
                <!-- filas dinámicas: agregar <tr> con <td> por producto -->
              </tbody>
            </table>
          </div>
          <div class="cr-summary-totals" style="display:grid; grid-template-columns: 1fr 300px; gap: 12px; margin-top: 12px; align-items:start;">
            <div>
              <div class="cr-conditions" style="border:1px solid #e2e8f0; border-radius:10px; padding:10px;">
                <div class="cr-conditions__title" style="font-weight:700; font-size:12px; color:#334155;">CONDICIONES</div>
                <textarea id="cr-summary-conditions" rows="3" class="cr-input" placeholder="Pago anticipado, tiempo de entrega, lugar de entrega, vigencia..." style="margin-top:6px; height:88px;"></textarea>
              </div>
              <div class="cr-hint" style="margin-top:8px;">Este resumen refleja lo seleccionado desde el Paso 1 (equipos, periodos, accesorios y envío).</div>
            </div>
            <div class="cr-total" style="margin:0; background:#f8fbff; border:1px solid #e2e8f0; border-radius:10px; padding:10px;">
              <div style="display:grid; grid-template-columns: 1fr auto; row-gap:6px; column-gap:12px;">
                <div class="cr-total__label">Sub-Total</div>
                <div id="cr-summary-subtotal" class="cr-total__value">$0.00</div>
                <div class="cr-total__label">Descuento</div>
                <div id="cr-summary-discount" class="cr-total__value">$0.00</div>
                <div class="cr-total__label">IVA</div>
                <div id="cr-summary-iva" class="cr-total__value">$0.00</div>
                <div class="cr-total__label" style="font-weight:800;">Total</div>
                <div id="cr-summary-total" class="cr-total__value" style="color: var(--primary);">$0.00</div>
              </div>
            </div>
          </div>
        </div>
        </div><!-- /#cr-home-delivery-wrap -->

        <div class="cr-actions">
          <button onclick="goToPreviousStep()" class="cr-btn cr-btn--ghost"><i class="fa-solid fa-arrow-left"></i> Volver</button>
          <button onclick="completeShippingStep()" class="cr-btn cr-btn--primary">Generar Cotización <i class="fa-solid fa-arrow-right"></i></button>
        </div>
      </div>
    </section>
  </main>
  <script>
    // Inicialización ligera para el encabezado de venta
    (function(){
      const dateEl = document.getElementById('v-quote-date');
      const numEl = document.getElementById('v-quote-number');
      try {
        if (dateEl) {
          const hoy = new Date().toISOString().split('T')[0];
          if (!dateEl.value) dateEl.value = hoy;
        }
      } catch {}
      try {
        if (numEl && !numEl.value) {
          const d = new Date();
          const id = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${String(d.getHours()).padStart(2,'0')}${String(d.getMinutes()).padStart(2,'0')}`;
          numEl.value = id;
        }
      } catch {}
    })();
  </script>
  <!-- Cargar lógica completa reutilizada desde renta mientras se porta a venta -->
  <script src="scripts/cotizacion_venta.js"></script>
  
</body>
</html>
