<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestión de Clientes</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="theme-dark.css" />
  <link rel="stylesheet" href="clientes.css" />
  <link rel="stylesheet" href="modal-styles.css" />
  <script src="theme.js" defer></script>
  <script src="js/auth.js" defer></script>
  <script src="js/clientes.js" defer></script>
  <script src="js/clientes-ui.js"></script>
  <script src="js/clientes-modals.js"></script>
  <script src="js/satisfaccion.js" defer></script>
  <script src="js/transacciones.js"></script>
  <script src="js/modal-handler.js" defer></script>
</head>
<body>

  <main class="main-content">
    <div class="topbar">
      <input class="searchbar" id="search-input" placeholder="Buscar por nombre, empresa o email..." />
      <div class="topbar-right">
        <span id="notif-bell" style="position:relative;cursor:pointer"><i class="fa fa-bell"></i><span class="notif-dot"></span></span>
        <div id="notif-dropdown" style="display:none;position:absolute;right:0;top:40px;background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);min-width:320px;z-index:200">
          <div id="notif-list"></div>
        </div>

        <div id="user-menu" style="position:relative;margin-left:18px;">
          <img id="avatar-img" src="img/default-user.png" alt="avatar" style="width:38px;height:38px;border-radius:50%;object-fit:cover;cursor:pointer;border:2px solid #e3f0ff;">
          <div id="user-dropdown" style="display:none;position:absolute;right:0;top:48px;background:#fff;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);padding:12px;z-index:200">
            <div id="user-name" style="font-weight:600"></div>
            <div id="user-role" style="font-size:0.9rem;color:#666"></div>
            <hr style="margin:8px 0" />
            <a id="logout-btn" href="#">Cerrar sesión</a>
          </div>
        </div>
      </div>
    </div>

    <section class="header-row">
      <div>
        <h1 class="header-title">Gestión de Clientes</h1>
        <div class="header-desc">Administra clientes, historiales y satisfacción</div>
      </div>
      <div class="header-actions">
        <button class="export-btn" hrfe="dashboard.html" >
          <a href="dashboard.html">
          Volver al Sistema
        </button></a>
        <button class="add-btn">+ Nuevo Cliente</button>
      </div>
    </section>

    <nav class="tabs">
      <button class="tab active" data-section="dashboard">
        <i class="fa fa-chart-line"></i> Dashboard
      </button>
      <button class="tab" data-section="clientes">
        <i class="fa fa-users"></i> Clientes
      </button>
      <button class="tab" data-section="transacciones">
        <i class="fa fa-list"></i> Transacciones
      </button>
      <button class="tab" data-section="satisfaccion">
        <i class="fa fa-star"></i> Satisfacción
      </button>
    </nav>

    <!-- Contenedor de secciones con transición -->
    <div class="sections-container">
      <!-- Dashboard Section -->
      <section id="dashboard-area" class="active">
        <div class="summary-cards">
      <div class="summary-card">
        <div class="icon"><i class="fa fa-users"></i></div>
        <div class="info"><div class="label">Total Clientes</div><div class="value">0</div></div>
      </div>
      <div class="summary-card">
        <div class="icon green"><i class="fa fa-user-check"></i></div>
        <div class="info"><div class="label">Clientes Activos</div><div class="value">0</div></div>
      </div>
      <div class="summary-card">
        <div class="icon yellow"><i class="fa fa-star"></i></div>
        <div class="info"><div class="label">Calificación Promedio</div><div class="value">0.0</div></div>
      </div>
      <div class="summary-card">
        <div class="icon purple"><i class="fa fa-dollar-sign"></i></div>
        <div class="info"><div class="label">Ingresos Totales</div><div class="value">$0</div></div>
      </div>
    </div>

        <!-- Dashboard Charts -->
        <div class="charts-grid">
          <div class="chart-card">
            <h3>Distribución de Clientes</h3>
            <canvas id="clientesDistribucionChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>clientes por ciudad</h3>
            <canvas id="ingresosMensualesChart"></canvas>
          </div>
          <div class="chart-card wide">
            <h3>Actividad de Clientes</h3>
            <canvas id="actividadClientesChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>Satisfacción del cliente</h3>
            <canvas id="satisfaccionChart"></canvas>
          </div>
          <div class="chart-card">
            <h3>Servicios mas contratados</h3>
            <canvas id="serviciosChart"></canvas>
          </div>
        </div>
      </section>

      <!-- Clientes Section -->
      <section id="clientes-area">
      <!-- Aquí `js/clientes.js` renderiza las tarjetas/listado -->
      <div id="clientes-list"></div>
    </section>

    <section id="transacciones-area" style="margin-top:28px;">
      <div class="client-card">
        <div class="header-row">
          <div>
            <h3>Historial de Transacciones</h3>
            <p class="header-desc">Todas las transacciones de clientes</p>
          </div>
          <div class="header-actions">
            <button class="export-btn">
              <i class="fas fa-file-export"></i> Exportar
            </button>
            
          </div>
        </div>
        
        <table class="transactions-table">
          <thead>
            <tr>
              <th>Cliente</th>
              <th>Tipo</th>
              <th>Referencia</th>
              <th>Descripción</th>
              <th>Monto</th>
              <th>Estado</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody id="transacciones-table">
            <!-- El contenido de la tabla se llenará dinámicamente -->
          </tbody>
        </table>
      </div>
    </section>

    <section id="satisfaccion-area" style="margin-top:28px;">
      <div class="client-card">
        <h3>Encuestas de Satisfacción</h3>
        <div id="satisfaccion-list" style="min-height:120px;display:flex;align-items:center;justify-content:center;color:#999">Las encuestas de satisfacción se mostrarán aquí</div>
      </div>
    </section>

  </main>
</body>

<!-- Modal Nuevo Cliente -->
<div id="nuevo-cliente-modal" class="modal">
    <div class="modal-content" style="margin: auto;">
      <div class="modal-header">
        <h3>Nuevo Cliente</h3>
        <p class="modal-subtitle">Completa la información para crear un nuevo cliente</p>
      </div>

      <form id="nuevo-cliente-form" class="modal-form">
        <!-- Información Personal -->
        <div class="form-section">
          <h4>Información Personal</h4>
          <p class="section-desc">Datos de identificación y contacto del cliente</p>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="nc-nombre">Nombre Completo *</label>
              <input id="nc-nombre" type="text" required />
            </div>
            <div class="form-group">
              <label for="nc-empresa">Empresa</label>
              <input id="nc-empresa" type="text" />
            </div>
            <div class="form-group">
              <label for="nc-telefono">Teléfono Principal</label>
              <input id="nc-telefono" type="tel" />
            </div>
            <div class="form-group">
              <label for="nc-telefono-alt">Teléfono Alternativo</label>
              <input id="nc-telefono-alt" type="tel" />
            </div>
            <div class="form-group">
              <label for="nc-contacto">Persona de Contacto</label>
              <input id="nc-contacto" type="text" />
            </div>
            <div class="form-group">
              <label for="nc-email">Email *</label>
              <input id="nc-email" type="email" required />
            </div>
            <div class="form-group">
              <label for="nc-sitio-web">Sitio Web</label>
              <input id="nc-sitio-web" type="url" />
            </div>
            <div class="form-group">
              <label for="nc-nit">NIT / Cédula</label>
              <input id="nc-nit" type="text" />
            </div>
            <div class="form-group full-width">
              <label for="nc-direccion">Dirección</label>
              <textarea id="nc-direccion" rows="2"></textarea>
            </div>
          </div>
        </div>

        <!-- Clasificación del Cliente -->
        <div class="form-section">
          <h4>Clasificación del Cliente</h4>
          <p class="section-desc">Segmentación y categorización</p>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="nc-segmento">Segmento</label>
              <select id="nc-segmento">
                <option value="Individual">Individual</option>
                <option value="Pequeña Empresa">Pequeña Empresa</option>
                <option value="Mediana Empresa">Mediana Empresa</option>
                <option value="Gran Empresa">Gran Empresa</option>
                <option value="Gobierno">Gobierno</option>
              </select>
            </div>
            <div class="form-group">
              <label for="nc-estado">Estado</label>
              <select id="nc-estado">
                <option value="Activo">Activo</option>
                <option value="Inactivo">Inactivo</option>
                <option value="Lista Negra">Lista Negra</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Información Financiera -->
        <div class="form-section">
          <h4>Información Financiera</h4>
          <p class="section-desc">Configuración de crédito y términos de pago</p>
          
          <div class="form-grid">
            <div class="form-group">
              <label for="nc-limite-credito">Límite de Crédito ($)</label>
              <input id="nc-limite-credito" type="number" min="0" value="0" />
            </div>
            <div class="form-group">
              <label for="nc-deuda-actual">Deuda Actual ($)</label>
              <input id="nc-deuda-actual" type="number" min="0" value="0" />
            </div>
            <div class="form-group">
              <label for="nc-terminos-pago">Términos de Pago (días)</label>
              <input id="nc-terminos-pago" type="number" min="0" value="30" />
            </div>
            <div class="form-group">
              <label for="nc-metodo-pago">Método de Pago Preferido</label>
              <select id="nc-metodo-pago">
                <option value="Transferencia">Transferencia</option>
                <option value="Efectivo">Efectivo</option>
                <option value="Cheque">Cheque</option>
                <option value="Crédito">Crédito</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Calificación del Cliente -->
        <div class="form-section">
          <h4>Calificación del Cliente</h4>
          <p class="section-desc">Evaluación del desempeño y confiabilidad</p>
          
          <div class="form-grid ratings-grid">
            <div class="form-group">
              <label for="nc-cal-general">Calificación General (1-5)</label>
              <input id="nc-cal-general" type="number" min="1" max="5" value="5" />
            </div>
            <div class="form-group">
              <label for="nc-cal-pago">Confiabilidad de Pago (1-5)</label>
              <input id="nc-cal-pago" type="number" min="1" max="5" value="5" />
            </div>
            <div class="form-group">
              <label for="nc-cal-comunicacion">Calidad de Comunicación (1-5)</label>
              <input id="nc-cal-comunicacion" type="number" min="1" max="5" value="5" />
            </div>
            <div class="form-group">
              <label for="nc-cal-equipos">Cuidado de Equipos (1-5)</label>
              <input id="nc-cal-equipos" type="number" min="1" max="5" value="5" />
            </div>
            <div class="form-group">
              <label for="nc-cal-satisfaccion">Satisfacción General (1-5)</label>
              <input id="nc-cal-satisfaccion" type="number" min="1" max="5" value="5" />
            </div>
            <div class="form-group">
              <label for="nc-fecha-evaluacion">Fecha de Última Evaluación</label>
              <input id="nc-fecha-evaluacion" type="date" />
            </div>
          </div>

          <div class="form-group full-width">
            <label for="nc-notas-evaluacion">Notas de Evaluación</label>
            <textarea id="nc-notas-evaluacion" rows="2" placeholder="Observaciones sobre el desempeño del cliente..."></textarea>
          </div>
        </div>

        <!-- Notas Adicionales -->
        <div class="form-section">
          <h4>Notas Adicionales</h4>
          <p class="section-desc">Información adicional y observaciones</p>
          
          <div class="form-group full-width">
            <label for="nc-notas-generales">Notas Generales</label>
            <textarea id="nc-notas-generales" rows="3" placeholder="Observaciones generales, preferencias, restricciones, etc..."></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-secondary" id="close-nuevo-cliente-modal">Cancelar</button>
          <button type="submit" class="btn-primary" id="save-nuevo-cliente">Guardar</button>
        </div>
      </form>
    </div>
  </div>

<!-- Modal Historial Cliente -->
<div id="historial-cliente-modal" class="modal">
  <div class="modal-content historial-modal-content">
    <div class="modal-header">
      <h3>Historial del Cliente</h3>
      <p class="modal-subtitle">Información completa del historial del cliente</p>
    </div>

    <div class="historial-container">
      <!-- Información del Cliente -->
      <div class="historial-cliente-info">
        <div class="cliente-header">
          <div class="cliente-avatar">
            <i class="fas fa-user-circle"></i>
          </div>
          <div class="cliente-details">
            <h4 id="historial-cliente-nombre">Nombre del Cliente</h4>
            <p id="historial-cliente-empresa">Empresa</p>
            <div class="cliente-tags">
              <span class="tag" id="historial-cliente-tipo">Tipo</span>
              <span class="tag" id="historial-cliente-estado">Estado</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Estadísticas del Cliente -->
      <div class="historial-stats">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-file-contract"></i>
          </div>
          <div class="stat-info">
            <div class="stat-value" id="historial-total-contratos">0</div>
            <div class="stat-label">Contratos</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-calculator"></i>
          </div>
          <div class="stat-info">
            <div class="stat-value" id="historial-total-cotizaciones">0</div>
            <div class="stat-label">Cotizaciones</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-receipt"></i>
          </div>
          <div class="stat-info">
            <div class="stat-value" id="historial-total-facturas">0</div>
            <div class="stat-label">Facturas</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">
            <i class="fas fa-dollar-sign"></i>
          </div>
          <div class="stat-info">
            <div class="stat-value" id="historial-valor-total">$0</div>
            <div class="stat-label">Valor Total</div>
          </div>
        </div>
      </div>

      <!-- Tabs de Historial -->
      <div class="historial-tabs">
        <button class="tab-btn active" data-tab="contratos">
          <i class="fas fa-file-contract"></i> Contratos
        </button>
        <button class="tab-btn" data-tab="cotizaciones">
          <i class="fas fa-calculator"></i> Cotizaciones
        </button>
        <button class="tab-btn" data-tab="facturas">
          <i class="fas fa-receipt"></i> Facturas
        </button>
        <button class="tab-btn" data-tab="pagos">
          <i class="fas fa-credit-card"></i> Pagos
        </button>
      </div>

      <!-- Contenido de las Tabs -->
      <div class="tab-content active" id="tab-contratos">
        <div class="historial-list">
          <div class="empty-state">
            <i class="fas fa-file-contract"></i>
            <h4>No hay contratos registrados</h4>
            <p>Este cliente aún no tiene contratos asociados</p>
          </div>
        </div>
      </div>

      <div class="tab-content" id="tab-cotizaciones">
        <div class="historial-list">
          <div class="empty-state">
            <i class="fas fa-calculator"></i>
            <h4>No hay cotizaciones registradas</h4>
            <p>Este cliente aún no tiene cotizaciones asociadas</p>
          </div>
        </div>
      </div>

      <div class="tab-content" id="tab-facturas">
        <div class="historial-list">
          <div class="empty-state">
            <i class="fas fa-receipt"></i>
            <h4>No hay facturas registradas</h4>
            <p>Este cliente aún no tiene facturas asociadas</p>
          </div>
        </div>
      </div>

      <div class="tab-content" id="tab-pagos">
        <div class="historial-list">
          <div class="empty-state">
            <i class="fas fa-credit-card"></i>
            <h4>No hay pagos registrados</h4>
            <p>Este cliente aún no tiene pagos asociados</p>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-secondary" id="close-historial-modal">Cerrar</button>
    </div>
  </div>
  </div>

<!-- Modal Encuesta de Satisfacción -->
<div id="encuesta-satisfaccion-modal" class="modal">
  <div class="modal-content encuesta-modal-content">
    <div class="modal-header">
      <h3>Encuesta de Satisfacción del Cliente</h3>
      <p class="modal-subtitle">Vista previa y opciones de compartir</p>
    </div>

    <div class="encuesta-container">
      <!-- Vista Previa -->
      <div class="preview-section">
        <h4>Vista Previa de la Encuesta</h4>
        <div class="preview-frame">
          <iframe id="encuesta-preview" src="sastifaccion_clienteSG.html" width="100%" height="400" frameborder="0"></iframe>
        </div>
      </div>

      <!-- Información de la Encuesta -->
      <div class="encuesta-info">
        <div class="info-card">
          <div class="info-header">
            <i class="fas fa-link"></i>
            <h5>URL de la Encuesta</h5>
          </div>
          <div class="url-container">
            <input type="text" id="encuesta-url" readonly value="https://tu-dominio.com/sastifaccion_clienteSG.html" />
            <button class="btn-copy" onclick="copiarURL()">
              <i class="fas fa-copy"></i> Copiar
            </button>
          </div>
        </div>

        <div class="info-card">
          <div class="info-header">
            <i class="fas fa-chart-bar"></i>
            <h5>Estadísticas de la Encuesta</h5>
          </div>
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="total-respuestas">0</div>
              <div class="stat-label">Respuestas</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="promedio-satisfaccion">0.0</div>
              <div class="stat-label">Promedio</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="tasa-respuesta">0%</div>
              <div class="stat-label">Tasa Respuesta</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Opciones de Compartir -->
      <div class="share-section">
        <h4>Compartir Encuesta</h4>
        <div class="share-options">
          <button class="share-btn whatsapp" onclick="compartirWhatsApp()">
            <i class="fab fa-whatsapp"></i>
            <span>WhatsApp</span>
          </button>
          <button class="share-btn email" onclick="compartirEmail()">
            <i class="fas fa-envelope"></i>
            <span>Correo Electrónico</span>
          </button>
          <button class="share-btn link" onclick="copiarURL()">
            <i class="fas fa-link"></i>
            <span>Copiar Enlace</span>
          </button>
        </div>
      </div>

      <!-- Configuración de Cliente (Opcional) -->
      <div class="client-config">
        <h4>Configuración para Cliente Específico</h4>
        <div class="config-form">
          <div class="form-group">
            <label for="cliente-nombre">Nombre del Cliente:</label>
            <input type="text" id="cliente-nombre" placeholder="Nombre del cliente (opcional)" />
          </div>
          <div class="form-group">
            <label for="proyecto-relacionado">Proyecto/Contrato:</label>
            <input type="text" id="proyecto-relacionado" placeholder="Número de proyecto o contrato (opcional)" />
          </div>
          <button class="btn-generar" onclick="generarURLPersonalizada()">
            <i class="fas fa-magic"></i> Generar URL Personalizada
          </button>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-secondary" id="close-encuesta-modal">Cerrar</button>
      <button type="button" class="btn-primary" onclick="verEstadisticas()">
        <i class="fas fa-chart-line"></i> Ver Estadísticas
      </button>
    </div>
  </div>
</div>

  <script>
    (function() {
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const avatarImg = document.getElementById('avatar-img');
      const avatarDropdown = document.getElementById('avatar-img-dropdown');
      const userName = document.getElementById('user-name');
      const userRole = document.getElementById('user-role');
      const userEmail = document.getElementById('user-email');
      const dropdown = document.getElementById('user-dropdown');
      if (user && avatarImg) {
        avatarImg.src = user.foto || 'img/default-user.png';
        avatarImg.onerror = () => { avatarImg.src = 'img/default-user.png'; };
      }
      if (user && avatarDropdown) {
        avatarDropdown.src = user.foto || 'img/default-user.png';
        avatarDropdown.onerror = () => { avatarDropdown.src = 'img/default-user.png'; };
      }
      if (userName) userName.textContent = user.nombre || '';
      if (userRole) userRole.textContent = user.rol || '';
      if (userEmail) userEmail.textContent = user.correo || '';
      if (avatarImg && dropdown) {
        avatarImg.onclick = function(e) {
          e.stopPropagation();
          dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        };
        document.body.addEventListener('click', function(e) {
          if (!e.target.closest('#user-menu')) dropdown.style.display = 'none';
        });
      }
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.onclick = function(e) {
          e.preventDefault();
          localStorage.removeItem('token');
          localStorage.removeItem('user');
          window.location.href = 'login.html';
        };
      }
    })();
  </script>
</body>
</html>