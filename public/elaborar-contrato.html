<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Elaboración de Contrato - ScaffoldPro</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <!-- Librerías para PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      margin: 0;
      background: #f7f9fb;
      font-family: 'Segoe UI', Arial, sans-serif;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
    }
    .header {
      background: #2c3e50;
      color: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .form-section {
      background: white;
      border-radius: 8px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .section-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 15px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      font-weight: 600;
      margin-bottom: 8px;
      color: #495057;
    }
    .form-group input, .form-group select, .form-group textarea {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    .action-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
    }
    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-primary { background: #2979ff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-warning { background: #ffc107; color: #212529; }
    .btn-warning:hover { background: #e0a800; }
    
    /* Estilos para los PDFs */
    .pdf-container {
      display: none;
      position: fixed;
      top: -9999px;
      left: -9999px;
    }
    .pdf-header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid #333;
      padding-bottom: 20px;
    }
    .pdf-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .pdf-subtitle {
      font-size: 16px;
      color: #666;
    }
    .pdf-section {
      margin-bottom: 25px;
    }
    .pdf-section-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #2c3e50;
      border-bottom: 1px solid #ddd;
      padding-bottom: 5px;
    }
    .pdf-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    .pdf-table th, .pdf-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    .pdf-table th {
      background-color: #f8f9fa;
      font-weight: bold;
    }
    .pdf-signature {
      margin-top: 50px;
      text-align: center;
    }
    .pdf-signature-line {
      border-top: 1px solid #000;
      width: 200px;
      margin: 0 auto;
      margin-bottom: 10px;
    }
  </style>
  <script src="js/auth.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>📋 Elaboración de Contrato</h1>
      <button onclick="window.location.href='cotizaciones.html'" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
        <i class="fa fa-arrow-left"></i> Volver
      </button>
    </div>

    <div class="form-section">
      <div class="section-title">
        <i class="fa fa-user" style="color: #007bff;"></i>
        Datos del Arrendatario
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Nombre Completo *</label>
          <input type="text" id="arrendatario-nombre" required>
        </div>
        <div class="form-group">
          <label>Tipo de Persona *</label>
          <select id="arrendatario-tipo" required>
            <option value="">Seleccionar...</option>
            <option value="fisica">Persona Física</option>
            <option value="moral">Persona Moral</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Dirección Completa *</label>
        <textarea id="arrendatario-direccion" required></textarea>
      </div>
    </div>

    <div class="form-section">
      <div class="section-title">
        <i class="fa fa-map-marker-alt" style="color: #dc3545;"></i>
        Ubicación de la Obra
      </div>
      <div class="form-group">
        <label>Dirección de la Obra *</label>
        <textarea id="obra-direccion" required></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Responsable en Obra *</label>
          <input type="text" id="obra-responsable" required>
        </div>
        <div class="form-group">
          <label>Teléfono *</label>
          <input type="tel" id="obra-telefono" required>
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="section-title">
        <i class="fa fa-calendar" style="color: #28a745;"></i>
        Plazo del Contrato
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Fecha de Inicio *</label>
          <input type="date" id="contrato-inicio" required>
        </div>
        <div class="form-group">
          <label>Fecha de Fin *</label>
          <input type="date" id="contrato-fin" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Monto Total (sin IVA) *</label>
          <input type="number" id="contrato-monto" required step="0.01">
        </div>
        <div class="form-group">
          <label>Total con IVA *</label>
          <input type="number" id="contrato-total" required step="0.01">
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="section-title">
        <i class="fa fa-shield-alt" style="color: #dc3545;"></i>
        Garantías
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Monto de Garantía *</label>
          <input type="number" id="garantia-monto" required step="0.01">
        </div>
        <div class="form-group">
          <label>Tipo de Garantía *</label>
          <select id="garantia-tipo" required>
            <option value="">Seleccionar...</option>
            <option value="pagare">Pagaré</option>
            <option value="cheque">Cheque Bancario</option>
            <option value="fianza">Fianza</option>
          </select>
        </div>
      </div>
    </div>

    <div class="form-section">
      <div class="section-title">
        <i class="fa fa-boxes-stacked" style="color: #8e44ad;"></i>
        Items Seleccionados y Deducciones de Stock
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Productos y Accesorios</label>
          <table class="pdf-table">
            <thead>
              <tr>
                <th>Tipo</th>
                <th>Nombre</th>
                <th>Cantidad</th>
                <th>Precio</th>
              </tr>
            </thead>
            <tbody id="contrato-items-body"></tbody>
          </table>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Deducciones de Componentes</label>
          <table class="pdf-table">
            <thead>
              <tr>
                <th>Producto</th>
                <th>Componente</th>
                <th>Req.</th>
                <th>Stock Actual</th>
              </tr>
            </thead>
            <tbody id="contrato-deducciones-body"></tbody>
          </table>
        </div>
      </div>
      <div class="action-buttons">
        <button class="btn btn-secondary" onclick="aplicarDeduccionesStock()">
          <i class="fa fa-database"></i> Aplicar Deducciones de Stock
        </button>
      </div>
    </div>

    <div class="action-buttons">
      <button class="btn btn-secondary" onclick="guardarBorrador()">
        <i class="fa fa-save"></i> Guardar Borrador
      </button>
      <button class="btn btn-primary" onclick="generarContrato()">
        <i class="fa fa-file-contract"></i> Generar Contrato
      </button>
      <button class="btn btn-success" onclick="generarNotaPedido()">
        <i class="fa fa-clipboard-list"></i> Nota de Pedido
      </button>
      <button class="btn btn-warning" onclick="generarFactura()">
        <i class="fa fa-file-invoice-dollar"></i> Facturar
      </button>
    </div>
  </div>

  <!-- Modal para información fiscal -->
  <div id="modal-fiscal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 500px; max-width: 90%;">
      <h3 style="margin-top: 0; color: #2c3e50;">📋 Información Fiscal para Facturación</h3>
      <p style="color: #666; margin-bottom: 20px;">Complete la información fiscal del cliente para generar la factura:</p>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: 600; margin-bottom: 5px;">RFC *</label>
        <input type="text" id="cliente-rfc" placeholder="XAXX010101000" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: 600; margin-bottom: 5px;">Uso de CFDI</label>
        <select id="cliente-uso-cfdi" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
          <option value="G01">G01 - Adquisición de mercancías</option>
          <option value="G02">G02 - Devoluciones, descuentos o bonificaciones</option>
          <option value="G03">G03 - Gastos en general</option>
          <option value="I01">I01 - Construcciones</option>
          <option value="I02">I02 - Mobilario y equipo de oficina por inversiones</option>
          <option value="I03">I03 - Equipo de transporte</option>
          <option value="I04">I04 - Equipo de cómputo y accesorios</option>
          <option value="I05">I05 - Dados, troqueles, moldes, matrices y herramental</option>
          <option value="I06">I06 - Comunicaciones telefónicas</option>
          <option value="I07">I07 - Comunicaciones satelitales</option>
          <option value="I08">I08 - Otra maquinaria y equipo</option>
          <option value="D01">D01 - Honorarios médicos, dentales y gastos hospitalarios</option>
          <option value="D02">D02 - Gastos médicos por incapacidad o discapacidad</option>
          <option value="D03">D03 - Gastos funerales</option>
          <option value="D04">D04 - Donativos</option>
          <option value="D05">D05 - Intereses reales efectivamente pagados por créditos hipotecarios</option>
          <option value="D06">D06 - Aportaciones voluntarias al SAR</option>
          <option value="D07">D07 - Primas por seguros de gastos médicos</option>
          <option value="D08">D08 - Gastos de transportación escolar obligatoria</option>
          <option value="D09">D09 - Depósitos en cuentas para el ahorro, primas que tengan como base planes de pensiones</option>
          <option value="D10">D10 - Pagos por servicios educativos</option>
          <option value="P01">P01 - Por definir</option>
        </select>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; font-weight: 600; margin-bottom: 5px;">Forma de Pago</label>
        <select id="cliente-forma-pago" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
          <option value="01">01 - Efectivo</option>
          <option value="02">02 - Cheque nominativo</option>
          <option value="03">03 - Transferencia electrónica de fondos</option>
          <option value="04">04 - Tarjeta de crédito</option>
          <option value="28">28 - Tarjeta de débito</option>
          <option value="99">99 - Por definir</option>
        </select>
      </div>
      
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="cerrarModalFiscal()" style="padding: 10px 20px; border: 1px solid #ddd; background: #f8f9fa; border-radius: 5px; cursor: pointer;">Cancelar</button>
        <button onclick="confirmarFactura()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">Generar Factura</button>
      </div>
    </div>
  </div>

  <!-- Contenedor oculto para generar PDFs -->
  <div id="pdf-container" class="pdf-container">
    <div id="contrato-pdf">
      <div class="pdf-header">
        <div class="pdf-title">CONTRATO DE ARRENDAMIENTO DE EQUIPOS</div>
        <div class="pdf-subtitle">ScaffoldPro - Servicios de Andamios y Equipos</div>
      </div>
      
      <div class="pdf-section">
        <div class="pdf-section-title">1. DATOS DE LAS PARTES</div>
        <table class="pdf-table">
          <tr>
            <td><strong>ARRENDADOR:</strong></td>
            <td>ScaffoldPro S.A. de C.V.</td>
          </tr>
          <tr>
            <td><strong>ARRENDATARIO:</strong></td>
            <td id="pdf-arrendatario-nombre"></td>
          </tr>
          <tr>
            <td><strong>TIPO DE PERSONA:</strong></td>
            <td id="pdf-arrendatario-tipo"></td>
          </tr>
          <tr>
            <td><strong>DOMICILIO:</strong></td>
            <td id="pdf-arrendatario-direccion"></td>
          </tr>
        </table>
      </div>

      <div class="pdf-section">
        <div class="pdf-section-title">2. OBJETO DEL CONTRATO</div>
        <p>El presente contrato tiene por objeto el arrendamiento de equipos y andamios para uso en construcción, conforme a las especificaciones técnicas y condiciones establecidas en la cotización correspondiente.</p>
      </div>

      <div class="pdf-section">
        <div class="pdf-section-title">3. UBICACIÓN DE LA OBRA</div>
        <table class="pdf-table">
          <tr>
            <td><strong>DIRECCIÓN:</strong></td>
            <td id="pdf-obra-direccion"></td>
          </tr>
          <tr>
            <td><strong>RESPONSABLE:</strong></td>
            <td id="pdf-obra-responsable"></td>
          </tr>
          <tr>
            <td><strong>TELÉFONO:</strong></td>
            <td id="pdf-obra-telefono"></td>
          </tr>
        </table>
      </div>

      <div class="pdf-section">
        <div class="pdf-section-title">4. PLAZO Y MONTO</div>
        <table class="pdf-table">
          <tr>
            <td><strong>FECHA DE INICIO:</strong></td>
            <td id="pdf-contrato-inicio"></td>
          </tr>
          <tr>
            <td><strong>FECHA DE FIN:</strong></td>
            <td id="pdf-contrato-fin"></td>
          </tr>
          <tr>
            <td><strong>MONTO SIN IVA:</strong></td>
            <td id="pdf-contrato-monto"></td>
          </tr>
          <tr>
            <td><strong>TOTAL CON IVA:</strong></td>
            <td id="pdf-contrato-total"></td>
          </tr>
        </table>
      </div>

      <div class="pdf-section">
        <div class="pdf-section-title">5. GARANTÍAS</div>
        <table class="pdf-table">
          <tr>
            <td><strong>MONTO DE GARANTÍA:</strong></td>
            <td id="pdf-garantia-monto"></td>
          </tr>
          <tr>
            <td><strong>TIPO DE GARANTÍA:</strong></td>
            <td id="pdf-garantia-tipo"></td>
          </tr>
        </table>
      </div>

      <div class="pdf-signature">
        <div class="pdf-signature-line"></div>
        <p><strong>Firma del Arrendatario</strong></p>
      </div>
    </div>

    <div id="nota-pedido-pdf">
      <div class="pdf-header">
        <div class="pdf-title">NOTA DE PEDIDO</div>
        <div class="pdf-subtitle">ScaffoldPro - Servicios de Andamios y Equipos</div>
      </div>
      
      <div class="pdf-section">
        <div class="pdf-section-title">DATOS DEL CLIENTE</div>
        <table class="pdf-table">
          <tr>
            <td><strong>CLIENTE:</strong></td>
            <td id="np-cliente-nombre"></td>
          </tr>
          <tr>
            <td><strong>DIRECCIÓN:</strong></td>
            <td id="np-cliente-direccion"></td>
          </tr>
          <tr>
            <td><strong>LUGAR DE ENTREGA:</strong></td>
            <td id="np-lugar-entrega"></td>
          </tr>
        </table>
      </div>

      <div class="pdf-section">
        <div class="pdf-section-title">EQUIPOS SOLICITADOS</div>
        <table class="pdf-table" id="np-equipos-table">
          <thead>
            <tr>
              <th>Descripción</th>
              <th>Cantidad</th>
              <th>Precio Unitario</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody id="np-equipos-body">
          </tbody>
        </table>
      </div>

      <div class="pdf-section">
        <div class="pdf-section-title">RESUMEN FINANCIERO</div>
        <table class="pdf-table">
          <tr>
            <td><strong>SUBTOTAL:</strong></td>
            <td id="np-subtotal"></td>
          </tr>
          <tr>
            <td><strong>IVA (16%):</strong></td>
            <td id="np-iva"></td>
          </tr>
          <tr>
            <td><strong>TOTAL:</strong></td>
            <td id="np-total"></td>
          </tr>
        </table>
      </div>

      <div class="pdf-section">
        <div class="pdf-section-title">CONDICIONES DE ENTREGA</div>
        <ul>
          <li>La entrega se realizará en el lugar especificado</li>
          <li>El cliente deberá verificar el estado de los equipos al recibirlos</li>
          <li>Se requiere firma de conformidad al momento de la entrega</li>
          <li>Los equipos deben ser devueltos en el mismo estado de recepción</li>
        </ul>
      </div>

      <div class="pdf-signature">
        <div class="pdf-signature-line"></div>
        <p><strong>Firma del Cliente</strong></p>
      </div>
    </div>

    <div id="factura-pdf">
      <div class="pdf-header">
        <div class="pdf-title">FACTURA</div>
        <div class="pdf-subtitle">ScaffoldPro - Servicios de Andamios y Equipos</div>
      </div>
      
      <div class="pdf-section">
        <div class="pdf-section-title">INFORMACIÓN DE LA FACTURA</div>
        <table class="pdf-table">
          <tr>
            <td><strong>FOLIO:</strong></td>
            <td id="factura-folio"></td>
          </tr>
          <tr>
            <td><strong>FECHA DE EMISIÓN:</strong></td>
            <td id="factura-fecha"></td>
          </tr>
          <tr>
            <td><strong>CONTRATO REFERENCIA:</strong></td>
            <td id="factura-contrato-ref"></td>
          </tr>
        </table>
      </div>

      <div class="pdf-section">
        <div class="pdf-section-title">DATOS DEL CLIENTE</div>
        <table class="pdf-table">
          <tr>
            <td><strong>RAZÓN SOCIAL:</strong></td>
            <td id="factura-cliente-nombre"></td>
          </tr>
          <tr>
            <td><strong>RFC:</strong></td>
            <td id="factura-cliente-rfc"></td>
          </tr>
          <tr>
            <td><strong>DOMICILIO FISCAL:</strong></td>
            <td id="factura-cliente-direccion"></td>
          </tr>
          <tr>
            <td><strong>CONDICIONES DE PAGO:</strong></td>
            <td id="factura-condiciones-pago"></td>
          </tr>
        </table>
      </div>

      <div class="pdf-section">
        <div class="pdf-section-title">CONCEPTO DEL SERVICIO</div>
        <table class="pdf-table" id="factura-equipos-table">
          <thead>
            <tr>
              <th>Descripción</th>
              <th>Cantidad</th>
              <th>Precio Unitario</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody id="factura-equipos-body">
          </tbody>
        </table>
      </div>

      <div class="pdf-section">
        <div class="pdf-section-title">RESUMEN FINANCIERO</div>
        <table class="pdf-table">
          <tr>
            <td><strong>SUBTOTAL:</strong></td>
            <td id="factura-subtotal"></td>
          </tr>
          <tr>
            <td><strong>IVA (16%):</strong></td>
            <td id="factura-iva"></td>
          </tr>
          <tr>
            <td><strong>TOTAL:</strong></td>
            <td id="factura-total"></td>
          </tr>
        </table>
      </div>

      <div class="pdf-section">
        <div class="pdf-section-title">INFORMACIÓN BANCARIA</div>
        <table class="pdf-table">
          <tr>
            <td><strong>BANCO:</strong></td>
            <td>Banco de México</td>
          </tr>
          <tr>
            <td><strong>CUENTA:</strong></td>
            <td>1234-5678-9012-3456</td>
          </tr>
          <tr>
            <td><strong>CLABE:</strong></td>
            <td>012345678901234567</td>
          </tr>
        </table>
      </div>

      <div class="pdf-signature">
        <div class="pdf-signature-line"></div>
        <p><strong>Firma Autorizada</strong></p>
      </div>
    </div>
  </div>

  <script>
    // Cargar datos de la cotización
    document.addEventListener('DOMContentLoaded', function() {
      let datosCotizacion = {};
      
      // Priorizar datos de la cotización recién guardada
      try {
        const cotizacionReciente = JSON.parse(sessionStorage.getItem('cotizacionParaContrato') || 'null');
        if (cotizacionReciente && cotizacionReciente.cliente) {
          console.log('📋 Usando datos de cotización recién guardada:', cotizacionReciente);
          datosCotizacion = {
            cliente: cotizacionReciente.cliente,
            equipos: cotizacionReciente.equipos,
            total: cotizacionReciente.total,
            subtotal: cotizacionReciente.total * 0.86, // Aproximado sin IVA
            direccion_entrega: cotizacionReciente.direccion_entrega
          };
        } else {
          // Fallback a localStorage
          datosCotizacion = JSON.parse(localStorage.getItem('datosCotizacion') || '{}') || {};
        }
      } catch {
        datosCotizacion = JSON.parse(localStorage.getItem('datosCotizacion') || '{}') || {};
      }
      
      let contratoDraft = {};
      try { contratoDraft = JSON.parse(localStorage.getItem('contratoDraft') || '{}') || {}; } catch {}
      datosCotizacion.cliente = datosCotizacion.cliente || {};
      const draftCli = contratoDraft.cliente || {};
      const merge = (a, b) => (a && a.toString().trim()) ? a : (b || '');
      
      // Solo usar draft si no hay datos recientes de cotización
      const usarDraft = !sessionStorage.getItem('cotizacionParaContrato');
      if (usarDraft) {
        // Prioriza los valores del draft si existen
        datosCotizacion.cliente.id_cliente = merge(datosCotizacion.cliente.id_cliente, draftCli.id_cliente);
        datosCotizacion.cliente.nombre = merge(datosCotizacion.cliente.nombre, draftCli.nombre);
        datosCotizacion.cliente.telefono = merge(datosCotizacion.cliente.telefono, draftCli.telefono);
        datosCotizacion.cliente.email = merge(datosCotizacion.cliente.email, draftCli.email);
        // Normaliza domicilio/direccion
        const domicilio = merge(datosCotizacion.cliente.domicilio, draftCli.domicilio);
        const direccion = merge(datosCotizacion.cliente.direccion, draftCli.direccion);
        datosCotizacion.cliente.domicilio = domicilio || direccion || '';
        datosCotizacion.cliente.ciudad = merge(datosCotizacion.cliente.ciudad, draftCli.ciudad);
      }
      
      try { localStorage.setItem('datosCotizacion', JSON.stringify(datosCotizacion)); } catch {}
      console.log('🧭 Cliente resuelto para contrato:', datosCotizacion.cliente);
      if (datosCotizacion.cliente) {
        document.getElementById('arrendatario-nombre').value = datosCotizacion.cliente.nombre || '';
        document.getElementById('arrendatario-direccion').value = (datosCotizacion.cliente.domicilio || datosCotizacion.cliente.direccion || '');
        document.getElementById('contrato-monto').value = datosCotizacion.subtotal || '';
        document.getElementById('contrato-total').value = datosCotizacion.total || '';
      }

      // Poblar items y deducciones si existe contratoDraft
      try {
        if (contratoDraft) {
          const itemsBody = document.getElementById('contrato-items-body');
          const dedBody = document.getElementById('contrato-deducciones-body');
          if (itemsBody) itemsBody.innerHTML = '';
          if (dedBody) dedBody.innerHTML = '';

          // Productos
          (contratoDraft.productos || []).forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>Producto</td>
              <td>${(p.nombre||'').toString()}</td>
              <td>${Number(p.cantidad||1)}</td>
              <td>$${Number(p.precio||0).toFixed(2)}</td>
            `;
            itemsBody.appendChild(tr);
          });
          // Accesorios
          (contratoDraft.accesorios || []).forEach(a => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>Accesorio</td>
              <td>${(a.nombre||'').toString()}</td>
              <td>${Number(a.cantidad||1)}</td>
              <td>$${Number(a.precio||0).toFixed(2)}</td>
            `;
            itemsBody.appendChild(tr);
          });

          // Deducciones de componentes
          (contratoDraft.componentesDeduccion || []).forEach(d => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${(d.id_producto||'')}</td>
              <td>${(d.nombre||d.clave||'')}</td>
              <td>${Number(d.cantidad_requerida||0)}</td>
              <td>${Number(d.stock_actual||0)}</td>
            `;
            dedBody.appendChild(tr);
          });
        }
      } catch (e) { console.warn('No se pudieron poblar items/deducciones', e); }

      // Auto-aplicar deducción de stock si fue seleccionada en el paso anterior
      try {
        if (contratoDraft && contratoDraft.aplicarDeducciones) {
          console.log('Auto-aplicando deducciones de stock según contratoDraft.aplicarDeducciones');
          aplicarDeduccionesStock();
        }
      } catch (e) {
        console.warn('No se pudo auto-aplicar la deducción de stock:', e);
      }

      // Event listener para cerrar modal al hacer clic fuera
      document.getElementById('modal-fiscal').addEventListener('click', function(e) {
        if (e.target === this) {
          cerrarModalFiscal();
        }
      });
    });

    // Placeholder: aplicar deducciones de stock (integración backend pendiente)
async function aplicarDeduccionesStock() {
  const draft = JSON.parse(localStorage.getItem('contratoDraft') || 'null');
  if (!draft) { alert('No hay borrador de contrato cargado.'); return; }
  const yaAplicado = localStorage.getItem('contratoDeduccionAplicada') === 'true';
  if (yaAplicado) {
    console.log('ℹ️ Deducción de stock ya aplicada en esta sesión. Omitiendo.');
    return;
  }
  console.log('Aplicando deducciones de stock (placeholder). Detalles:', {
    productos: draft.productos,
    accesorios: draft.accesorios,
    componentesDeduccion: draft.componentesDeduccion
  });
  // TODO: Integrar con backend para deducción atómica de stock.
  // Ejemplo (comentado):
  // const token = localStorage.getItem('token');
  // await fetch('http://localhost:3001/api/stock/deducir', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(draft) });
  localStorage.setItem('contratoDeduccionAplicada', 'true');
  alert('Simulación: deducciones de stock marcadas como aplicadas. (Integración backend pendiente)');
}

    function guardarBorrador() {
      // Recopilar todos los datos del formulario
      const datosContrato = {
        arrendatario: {
          nombre: document.getElementById('arrendatario-nombre').value,
          tipo: document.getElementById('arrendatario-tipo').value,
          direccion: document.getElementById('arrendatario-direccion').value
        },
        obra: {
          direccion: document.getElementById('obra-direccion').value,
          responsable: document.getElementById('obra-responsable').value,
          telefono: document.getElementById('obra-telefono').value
        },
        contrato: {
          inicio: document.getElementById('contrato-inicio').value,
          fin: document.getElementById('contrato-fin').value,
          monto: document.getElementById('contrato-monto').value,
          total: document.getElementById('contrato-total').value
        },
        garantia: {
          monto: document.getElementById('garantia-monto').value,
          tipo: document.getElementById('garantia-tipo').value
        },
        fechaGuardado: new Date().toISOString()
      };

      // Guardar en localStorage
      localStorage.setItem('datosContrato', JSON.stringify(datosContrato));
      alert('✅ Borrador guardado exitosamente');
    }

    function generarContrato() {
      // Validar que todos los campos requeridos estén llenos
      const camposRequeridos = [
        'arrendatario-nombre', 'arrendatario-tipo', 'arrendatario-direccion',
        'obra-direccion', 'obra-responsable', 'obra-telefono',
        'contrato-inicio', 'contrato-fin', 'contrato-monto', 'contrato-total',
        'garantia-monto', 'garantia-tipo'
      ];

      for (let campo of camposRequeridos) {
        const elemento = document.getElementById(campo);
        if (!elemento.value.trim()) {
          alert(`❌ Por favor completa el campo: ${elemento.previousElementSibling.textContent}`);
          elemento.focus();
          return;
        }
      }

      // Llenar datos en el PDF
      llenarDatosContratoPDF();
      
      // Generar PDF
      const elemento = document.getElementById('contrato-pdf');
      const opciones = {
        margin: 1,
        filename: `contrato_${document.getElementById('arrendatario-nombre').value.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };

      html2pdf().set(opciones).from(elemento).save().then(() => {
        alert('✅ Contrato generado exitosamente');
      }).catch(error => {
        console.error('Error generando contrato:', error);
        alert('❌ Error al generar el contrato');
      });
    }

    function generarNotaPedido() {
      // Obtener datos de la cotización
      const datosCotizacion = JSON.parse(localStorage.getItem('datosCotizacion') || '{}');
      
      if (!datosCotizacion.cliente) {
        alert('❌ No se encontraron datos de cotización. Regresa a la página de cotizaciones.');
        return;
      }

      // Llenar datos en el PDF de nota de pedido
      llenarDatosNotaPedidoPDF(datosCotizacion);
      
      // Generar PDF
      const elemento = document.getElementById('nota-pedido-pdf');
      const opciones = {
        margin: 1,
        filename: `nota_pedido_${datosCotizacion.cliente.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };

      html2pdf().set(opciones).from(elemento).save().then(() => {
        alert('✅ Nota de pedido generada exitosamente');
      }).catch(error => {
        console.error('Error generando nota de pedido:', error);
        alert('❌ Error al generar la nota de pedido');
      });
    }

    function generarFactura() {
      // Obtener datos de la cotización
      const datosCotizacion = JSON.parse(localStorage.getItem('datosCotizacion') || '{}');
      
      if (!datosCotizacion.cliente) {
        alert('❌ No se encontraron datos de cotización. Regresa a la página de cotizaciones.');
        return;
      }

      // Mostrar modal para información fiscal
      document.getElementById('modal-fiscal').style.display = 'block';
      
      // Pre-llenar RFC si existe en los datos del cliente
      if (datosCotizacion.cliente.rfc) {
        document.getElementById('cliente-rfc').value = datosCotizacion.cliente.rfc;
      }
    }

    function cerrarModalFiscal() {
      document.getElementById('modal-fiscal').style.display = 'none';
    }

    function confirmarFactura() {
      const rfc = document.getElementById('cliente-rfc').value.trim();
      const usoCfdi = document.getElementById('cliente-uso-cfdi').value;
      const formaPago = document.getElementById('cliente-forma-pago').value;
      
      if (!rfc) {
        alert('❌ Por favor ingrese el RFC del cliente');
        document.getElementById('cliente-rfc').focus();
        return;
      }

      // Obtener datos de la cotización
      const datosCotizacion = JSON.parse(localStorage.getItem('datosCotizacion') || '{}');
      
      // Agregar información fiscal a los datos del cliente
      datosCotizacion.cliente.rfc = rfc;
      datosCotizacion.cliente.usoCfdi = usoCfdi;
      datosCotizacion.cliente.formaPago = formaPago;
      
      // Guardar datos actualizados
      localStorage.setItem('datosCotizacion', JSON.stringify(datosCotizacion));
      
      // Cerrar modal
      cerrarModalFiscal();
      
      // Llenar datos en el PDF de factura
      llenarDatosFacturaPDF(datosCotizacion);
      
      // Generar PDF
      const elemento = document.getElementById('factura-pdf');
      const opciones = {
        margin: 1,
        filename: `factura_${datosCotizacion.cliente.nombre.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };

      html2pdf().set(opciones).from(elemento).save().then(() => {
        alert('✅ Factura generada exitosamente');
      }).catch(error => {
        console.error('Error generando factura:', error);
        alert('❌ Error al generar la factura');
      });
    }

    function llenarDatosContratoPDF() {
      // Llenar datos del arrendatario
      document.getElementById('pdf-arrendatario-nombre').textContent = document.getElementById('arrendatario-nombre').value;
      document.getElementById('pdf-arrendatario-tipo').textContent = document.getElementById('arrendatario-tipo').value === 'fisica' ? 'Persona Física' : 'Persona Moral';
      document.getElementById('pdf-arrendatario-direccion').textContent = document.getElementById('arrendatario-direccion').value;
      
      // Llenar datos de la obra
      document.getElementById('pdf-obra-direccion').textContent = document.getElementById('obra-direccion').value;
      document.getElementById('pdf-obra-responsable').textContent = document.getElementById('obra-responsable').value;
      document.getElementById('pdf-obra-telefono').textContent = document.getElementById('obra-telefono').value;
      
      // Llenar datos del contrato
      document.getElementById('pdf-contrato-inicio').textContent = formatearFecha(document.getElementById('contrato-inicio').value);
      document.getElementById('pdf-contrato-fin').textContent = formatearFecha(document.getElementById('contrato-fin').value);
      document.getElementById('pdf-contrato-monto').textContent = formatearMoneda(document.getElementById('contrato-monto').value);
      document.getElementById('pdf-contrato-total').textContent = formatearMoneda(document.getElementById('contrato-total').value);
      
      // Llenar datos de garantía
      document.getElementById('pdf-garantia-monto').textContent = formatearMoneda(document.getElementById('garantia-monto').value);
      document.getElementById('pdf-garantia-tipo').textContent = document.getElementById('garantia-tipo').value;
    }

    function llenarDatosNotaPedidoPDF(datosCotizacion) {
      // Llenar datos del cliente
      document.getElementById('np-cliente-nombre').textContent = datosCotizacion.cliente.nombre;
      document.getElementById('np-cliente-direccion').textContent = (datosCotizacion.cliente.domicilio || datosCotizacion.cliente.direccion || '');
      document.getElementById('np-lugar-entrega').textContent = (datosCotizacion.cliente.domicilio || datosCotizacion.cliente.direccion || ''); // Usar la misma dirección como lugar de entrega
      
      // Llenar equipos
      const tbody = document.getElementById('np-equipos-body');
      tbody.innerHTML = '';
      
      if (datosCotizacion.equipos && datosCotizacion.equipos.length > 0) {
        datosCotizacion.equipos.forEach(equipo => {
          const row = tbody.insertRow();
          row.innerHTML = `
            <td>${equipo.nombre}</td>
            <td>${equipo.cantidad}</td>
            <td>${formatearMoneda(equipo.precio)}</td>
            <td>${formatearMoneda(equipo.subtotal)}</td>
          `;
        });
      }
      
      // Llenar resumen financiero
      document.getElementById('np-subtotal').textContent = formatearMoneda(datosCotizacion.subtotal);
      document.getElementById('np-iva').textContent = formatearMoneda(datosCotizacion.iva);
      document.getElementById('np-total').textContent = formatearMoneda(datosCotizacion.total);
    }

    function llenarDatosFacturaPDF(datosCotizacion) {
      // Generar un folio único (ejemplo: 001-2023-000001)
      const fecha = new Date();
      const year = fecha.getFullYear();
      const month = String(fecha.getMonth() + 1).padStart(2, '0');
      const day = String(fecha.getDate()).padStart(2, '0');
      const folio = `001-${year}-${month}-${day}-${Math.floor(Math.random() * 1000000).toString().padStart(6, '0')}`;

      document.getElementById('factura-folio').textContent = folio;
      document.getElementById('factura-fecha').textContent = formatearFecha(fecha.toISOString().split('T')[0]);
      document.getElementById('factura-contrato-ref').textContent = `Contrato ${folio}`; // Referencia al contrato

      // Llenar datos del cliente
      document.getElementById('factura-cliente-nombre').textContent = datosCotizacion.cliente.nombre;
      document.getElementById('factura-cliente-rfc').textContent = datosCotizacion.cliente.rfc || 'XAXX010101000';
      document.getElementById('factura-cliente-direccion').textContent = (datosCotizacion.cliente.domicilio || datosCotizacion.cliente.direccion || '');
      
      // Determinar condiciones de pago basadas en la forma de pago
      let condicionesPago = 'Pago contra entrega';
      if (datosCotizacion.cliente.formaPago) {
        switch(datosCotizacion.cliente.formaPago) {
          case '01': condicionesPago = 'Efectivo'; break;
          case '02': condicionesPago = 'Cheque nominativo'; break;
          case '03': condicionesPago = 'Transferencia electrónica'; break;
          case '04': condicionesPago = 'Tarjeta de crédito'; break;
          case '28': condicionesPago = 'Tarjeta de débito'; break;
          default: condicionesPago = 'Pago contra entrega'; break;
        }
      }
      document.getElementById('factura-condiciones-pago').textContent = condicionesPago;

      // Llenar equipos
      const tbody = document.getElementById('factura-equipos-body');
      tbody.innerHTML = '';
      
      if (datosCotizacion.equipos && datosCotizacion.equipos.length > 0) {
        datosCotizacion.equipos.forEach(equipo => {
          const row = tbody.insertRow();
          row.innerHTML = `
            <td>${equipo.nombre}</td>
            <td>${equipo.cantidad}</td>
            <td>${formatearMoneda(equipo.precio)}</td>
            <td>${formatearMoneda(equipo.subtotal)}</td>
          `;
        });
      }
      
      // Llenar resumen financiero
      document.getElementById('factura-subtotal').textContent = formatearMoneda(datosCotizacion.subtotal);
      document.getElementById('factura-iva').textContent = formatearMoneda(datosCotizacion.iva);
      document.getElementById('factura-total').textContent = formatearMoneda(datosCotizacion.total);
    }

    function formatearFecha(fecha) {
      if (!fecha) return '';
      const fechaObj = new Date(fecha);
      return fechaObj.toLocaleDateString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    function formatearMoneda(valor) {
      if (!valor) return '$0.00';
      return new Intl.NumberFormat('es-MX', {
        style: 'currency',
        currency: 'MXN'
      }).format(valor);
    }
  </script>
</body>
</html> 