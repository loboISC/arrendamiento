<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics y Reportes - ScaffoldPro</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <link rel="stylesheet" href="theme-dark.css">
  <script src="theme.js"></script>
  <script src="js/auth.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- jsPDF Autotable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { margin: 0; background: #f7f9fb; font-family: 'Segoe UI', Arial, sans-serif; color: #232323; }
    body { min-height: 100vh; display: flex; flex-direction: column; }
    .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 270px; background: #fff; box-shadow: 2px 0 8px rgba(0,0,0,0.04); z-index: 20; display: flex; flex-direction: column; padding: 24px 0 0 0; height: 100vh; }
    .sidebar .logo { font-size: 1.7rem; font-weight: 700; color: #2979ff; margin-left: 32px; margin-bottom: 32px; letter-spacing: -1px; display: flex; align-items: center; justify-content: space-between; }
    .sidebar .close { font-size: 1.5rem; color: #888; cursor: pointer; margin-right: 24px; display: none; }
    .sidebar ul { list-style: none; padding: 0; margin: 0; flex: 1; }
    .sidebar li { margin-bottom: 6px; }
    .sidebar a { display: flex; align-items: center; gap: 16px; padding: 12px 32px; color: #6b7280; text-decoration: none; font-size: 1.08rem; border-radius: 10px 20px 20px 10px; transition: background 0.2s, color 0.2s; }
    .sidebar a.active, .sidebar a:hover { background: #e3f0ff; color: #2979ff; font-weight: 600; }
    .sidebar a .fa { font-size: 1.2rem; width: 22px; text-align: center; }
    .main-content {
      background: #fafdff;
      border-radius: 24px;
      box-shadow: 0 4px 32px rgba(41,121,255,0.07);
      margin: 48px auto 48px auto;
      padding: 48px 56px 56px 56px;
      max-width: 1600px;
      min-width: 320px;
      min-height: 80vh;
      display: flex;
      flex-direction: column;
      gap: 32px;
    }
    @media (max-width: 1200px) {
      .main-content { padding: 32px 12px 32px 12px; margin: 24px 0; gap: 24px; }
    }
    @media (max-width: 700px) {
      .main-content { padding: 8px 2vw 18px 2vw; margin: 8px 0; gap: 16px; }
    }
    .topbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
    .menu-btn { background: none; border: none; font-size: 1.7rem; color: #232323; cursor: pointer; margin-right: 18px; margin-left: 0; display: none; }
    .searchbar { display: flex; align-items: center; background: #f1f5f9; border-radius: 30px; padding: 8px 18px; width: 350px; font-size: 1rem; color: #6b7280; border: none; outline: none; }
    .topbar-right { display: flex; align-items: center; gap: 24px; }
    .topbar .fa-bell { font-size: 1.3rem; color: #6b7280; position: relative; }
    .notif-dot { position: absolute; top: 2px; right: 0; width: 8px; height: 8px; background: #f44336; border-radius: 50%; border: 2px solid #fff; }
    .avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid #e3f0ff; }
    .header-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 18px; }
    .header-title { font-size: 2.3rem; font-weight: 700; }
    .header-desc { color: #6b7280; margin-bottom: 18px; }
    .header-actions { display: flex; gap: 12px; align-items: center; }
    .select-period { padding: 8px 18px; border-radius: 8px; border: 1px solid #e3e8ef; background: #fff; font-size: 1rem; outline: none; }
    .filter-btn { border: 1px solid #e3e8ef; background: #fff; color: #232323; border-radius: 8px; padding: 10px 18px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .filter-btn:hover { background: #f1f5f9; }
    .export-btn { background: #2979ff; color: #fff; border: none; border-radius: 8px; padding: 10px 18px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .export-btn:hover { background: #1565c0; }
    .summary-cards { display: grid; grid-template-columns: repeat(4,1fr); gap: 24px; margin-bottom: 32px; }
    .summary-card { background: #fff; border-radius: 16px; padding: 24px 28px; display: flex; align-items: center; gap: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); min-width: 180px; }
    .summary-card .icon { background: #e3f0ff; color: #2979ff; border-radius: 10px; padding: 12px; font-size: 1.6rem; display: flex; align-items: center; justify-content: center; }
    .summary-card .info { flex: 1; }
    .summary-card .info .label { color: #6b7280; font-size: 1.02rem; margin-bottom: 2px; }
    .summary-card .info .value { font-size: 1.5rem; font-weight: 700; margin-bottom: 2px; }
    .summary-card .info .trend { color: #43a047; font-size: 1.02rem; font-weight: 600; margin-left: 8px; }
    .summary-card .info .trend.negative { color: #f44336; }
    .summary-card .info .desc { color: #888; font-size: 0.98rem; }
    .dashboard-row { display: grid; grid-template-columns: 2fr 1.2fr; gap: 24px; margin-bottom: 32px; }
    .dashboard-card { background: #fff; border-radius: 16px; padding: 24px 28px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .dashboard-card h3 { font-size: 1.2rem; font-weight: 700; margin-bottom: 18px; }
    .chart-placeholder { width: 100%; height: 260px; background: linear-gradient(135deg,#e3f0ff 60%,#fff 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #2979ff; font-size: 1.3rem; font-weight: 600; }
    .dashboard-row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 32px; }
    .equipos-card { background: #fff; border-radius: 16px; padding: 24px 28px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); margin-bottom: 32px; }
    .equipos-card h3 { font-size: 1.2rem; font-weight: 700; margin-bottom: 18px; }
    .equipos-bar { background: #e3e8ef; border-radius: 8px; height: 14px; margin: 8px 0 12px 0; position: relative; }
    .equipos-bar-fill { background: #2979ff; border-radius: 8px; height: 100%; position: absolute; left: 0; top: 0; }
    .equipos-bar-label { display: flex; justify-content: space-between; align-items: center; font-size: 1rem; margin-bottom: 2px; }
    .metrics-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .metrics-table th, .metrics-table td { padding: 14px 10px; text-align: left; }
    .metrics-table th { color: #6b7280; font-weight: 600; background: #f7f9fb; }
    .metrics-table tr { border-bottom: 1px solid #e3e8ef; }
    .metrics-table td { vertical-align: middle; }
    .badge { display: inline-flex; align-items: center; gap: 6px; font-size: 0.98rem; font-weight: 600; border-radius: 8px; padding: 4px 12px; }
    .badge.yellow { background: #fffbe6; color: #ffc107; }
    .badge.green { background: #e6f9f0; color: #1abc9c; }
    .trend-up { color: #43a047; font-weight: 600; }
    .trend-down { color: #f44336; font-weight: 600; }
    /* Modal Filtros Avanzados */
    .modal-bg-filtros {
      display: none; position: fixed; z-index: 2000; left: 0; top: 0; right: 0; bottom: 0;
      background: rgba(41,121,255,0.10); align-items: center; justify-content: center;
    }
    .modal-bg-filtros.active { display: flex; }
    .modal-filtros {
      background: #fff; border-radius: 18px; box-shadow: 0 8px 32px rgba(41,121,255,0.13);
      padding: 36px 38px 28px 38px; min-width: 340px; max-width: 98vw; width: 420px; position: relative;
      display: flex; flex-direction: column; gap: 18px; animation: notif-fade-in 0.22s cubic-bezier(.4,1.4,.6,1) both;
    }
    .modal-filtros h2 { margin: 0 0 12px 0; font-size: 1.25rem; font-weight: 700; color: #2979ff; }
    .modal-filtros label { font-weight: 600; margin-bottom: 4px; display: block; color: #232323; }
    .modal-filtros input, .modal-filtros select {
      width: 100%; padding: 9px 12px; border-radius: 8px; border: 1px solid #e3e8ef; margin-bottom: 10px; font-size: 1rem; background: #f7f9fb; outline: none;
      transition: border-color 0.18s;
    }
    .modal-filtros input:focus, .modal-filtros select:focus { border-color: #2979ff; }
    .modal-filtros .modal-actions { display: flex; justify-content: flex-end; gap: 12px; margin-top: 8px; }
    .modal-filtros .close-modal { position: absolute; top: 12px; right: 18px; font-size: 1.3rem; color: #888; background: none; border: none; cursor: pointer; }
    .modal-filtros .reset-btn { background: none; color: #2979ff; border: none; font-weight: 600; cursor: pointer; }
    /* Mejoras generales UX */
    .main-content { background: #fafdff; border-radius: 24px; box-shadow: 0 4px 32px rgba(41,121,255,0.07); margin: 32px auto; padding: 40px 48px 48px 48px; max-width: 1600px; }
    .summary-cards { background: #f7f9fb; border-radius: 16px; box-shadow: 0 2px 8px rgba(41,121,255,0.04); padding: 18px 0 6px 0; }
    .dashboard-card, .equipos-card { border: 1.5px solid #e3e8ef; }
    .dashboard-card h3, .equipos-card h3 { color: #2979ff; letter-spacing: 0.5px; }
    .header-title { color: #2979ff; letter-spacing: -1px; }
    .export-btn { box-shadow: 0 2px 8px rgba(41,121,255,0.08); }
    .filter-btn { box-shadow: 0 2px 8px rgba(41,121,255,0.04); }
    .select-period { box-shadow: 0 2px 8px rgba(41,121,255,0.04); }
    .metrics-table { border: 1.5px solid #e3e8ef; }
    .badge { font-size: 1.01rem; }
    /* Scrollbar UX */
    ::-webkit-scrollbar { width: 10px; background: #f7f9fb; }
    ::-webkit-scrollbar-thumb { background: #e3e8ef; border-radius: 8px; }
    @media (max-width: 1200px) { .main-content { margin-left: 0; padding: 24px 8px 8px 8px; } .sidebar { position: absolute; z-index: 100; transform: translateX(-100%); } .sidebar.open { transform: translateX(0); } .menu-btn { display: block; } .dashboard-row, .dashboard-row2 { grid-template-columns: 1fr; } }
    @media (max-width: 900px) { .summary-cards { grid-template-columns: 1fr 1fr; } .dashboard-row, .dashboard-row2 { grid-template-columns: 1fr; } }
    @media (max-width: 600px) { .summary-cards { grid-template-columns: 1fr; } .main-content { padding: 8px; } }
    .sidebar { z-index: 100; }
    .main-content { margin-left: 270px; }
    @media (max-width: 1200px) {
      .main-content { margin-left: 0; }
      .sidebar { position: absolute; z-index: 100; transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
    }
    .topbar {
      margin-top: 8px; margin-bottom: 32px;
      position: sticky; top: 0; z-index: 10; background: #fafdff;
      box-shadow: 0 2px 12px rgba(41,121,255,0.04);
      border-radius: 18px;
      padding: 18px 24px;
    }
    .topbar-right { display: flex; align-items: center; gap: 24px; }
    .topbar .fa-bell {
      font-size: 1.3rem;
      color: #6b7280;
      position: relative;
      cursor: pointer;
      transition: color 0.18s, transform 0.18s;
    }
    .topbar .fa-bell:hover {
      color: #2979ff;
      transform: scale(1.13) rotate(-8deg);
    }
    .notif-dot {
      position: absolute; top: 2px; right: 0; width: 8px; height: 8px; background: #f44336; border-radius: 50%; border: 2px solid #fff;
      box-shadow: 0 0 0 2px #fff, 0 2px 8px rgba(244,67,54,0.18);
      animation: notif-pulse 1.2s infinite alternate;
    }
    @keyframes notif-pulse {
      0% { box-shadow: 0 0 0 2px #fff, 0 2px 8px rgba(244,67,54,0.18); }
      100% { box-shadow: 0 0 0 4px #fff, 0 2px 16px rgba(244,67,54,0.28); }
    }
    .notif-dropdown {
      display: none;
      position: absolute;
      top: 44px; right: 0;
      background: #fff;
      box-shadow: 0 8px 32px rgba(41,121,255,0.13);
      border-radius: 16px;
      min-width: 320px;
      z-index: 1001;
      padding: 0;
      overflow: hidden;
      animation: notif-fade-in 0.22s cubic-bezier(.4,1.4,.6,1) both;
    }
    .notif-dropdown.active { display: block; }
    @keyframes notif-fade-in {
      from { opacity: 0; transform: translateY(-12px) scale(.98); }
      to { opacity: 1; transform: none; }
    }
    .notif-header {
      font-weight:700; color:#2979ff; font-size:1.08rem; padding:14px 22px 8px 22px; background:#f7f9fb; border-bottom:1px solid #e3e8ef;
      display:flex;align-items:center;gap:8px;
    }
    .notif-list { max-height: 260px; overflow-y: auto; }
    .notif-item {
      padding: 12px 22px; font-size: 1.01rem; color: #232323; border-bottom: 1px solid #f1f1f1; display: flex; align-items: flex-start; gap: 12px; background: none; transition: background 0.18s;
      cursor:pointer;
    }
    .notif-item:last-child { border-bottom: none; }
    .notif-item .fa { font-size: 1.15rem; margin-top:2px; }
    .notif-item.unread { background: #e3f0ff; font-weight:600; }
    .notif-item:hover { background: #f1f5f9; }
    .notif-empty { color:#888; text-align:center; padding:24px 0; }
    .notif-footer { padding:10px 0 10px 0; text-align:center; background:#f7f9fb; border-top:1px solid #e3e8ef; }
    .notif-footer a { color:#2979ff; text-decoration:none; font-weight:600; font-size:0.98rem; }
    /* Usuario */
    .avatar {
      width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 2px solid #e3f0ff;
      box-shadow: 0 2px 8px rgba(41,121,255,0.07);
      cursor:pointer;
      transition: box-shadow 0.18s, border-color 0.18s;
    }
    .avatar:hover { box-shadow: 0 4px 16px rgba(41,121,255,0.13); border-color: #2979ff; }
    .user-menu {
      display: none;
      position: absolute;
      top: 52px; right: 0;
      background: #fff;
      box-shadow: 0 8px 32px rgba(41,121,255,0.13);
      border-radius: 16px;
      min-width: 210px;
      z-index: 1001;
      padding: 0;
      animation: notif-fade-in 0.22s cubic-bezier(.4,1.4,.6,1) both;
      overflow: hidden;
    }
    .user-menu.active { display: block; }
    .user-menu-header {
      display:flex;align-items:center;gap:12px;padding:18px 22px 10px 22px;background:#f7f9fb;border-bottom:1px solid #e3e8ef;
    }
    .user-menu-header .avatar { width:44px;height:44px; }
    .user-menu-header .user-info { display:flex;flex-direction:column; }
    .user-menu-header .user-info .name { font-weight:700; font-size:1.08rem; }
    .user-menu-header .user-info .role { color:#888; font-size:0.97rem; }
    .user-menu a {
      display: flex; align-items: center; gap: 12px; padding: 12px 22px; color: #232323; text-decoration: none; font-size: 1.01rem; transition: background 0.18s, color 0.18s; border-bottom:1px solid #f1f1f1;
    }
    .user-menu a:last-child { border-bottom:none; }
    .user-menu a:hover { background: #f1f5f9; color:#2979ff; }
    .user-menu .fa { font-size:1.13rem; }
  </style>
  </head>
<body>
  <aside class="sidebar" id="sidebar">
    <div class="logo">ScaffoldPro <span class="close" id="closeSidebar">&times;</span></div>
    <ul>
        <li><a href="dashboard.html"><i class="fa fa-house"></i> Dashboard</a></li>
        <li><a href="inventario.html"><i class="fa fa-cube"></i> Inventario</a></li>
        <li><a href="cotizaciones.html"><i class="fa fa-file-lines"></i> Cotización</a></li>
        <li><a href="contratos.html"><i class="fa fa-file-contract"></i> Contratos</a></li>
        <li><a href="clientes.html"><i class="fa fa-users"></i> Clientes</a></li>
        <li><a href="facturacion.html"><i class="fa fa-file-invoice-dollar"></i> Facturación</a></li>
        <li><a href="ventas.html"><i class="fa fa-chart-line"></i> Ventas</a></li>
        <li><a href="logistica.html"><i class="fa fa-truck"></i> Logística</a></li>
        <li><a href="analisis.html" class="active"><i class="fa fa-chart-bar"></i> Análisis</a></li>
        <li><a href="mantenimiento.html"><i class="fa fa-screwdriver-wrench"></i> Mantenimientos</a></li>
        <li><a href="proyectos.html"><i class="fa fa-diagram-project"></i> Proyectos</a></li>
        <li><a href="calidad.html"><i class="fa fa-shield-halved"></i> Calidad</a></li>
        <li><a href="notificaciones.html"><i class="fa fa-bell"></i> Notificaciones</a></li>
        <li><a href="configuracion.html"><i class="fa fa-gear"></i> Configuración</a></li>
      </ul>
  </aside>
  <div class="main-content">
    <div class="topbar">
      <button class="menu-btn" id="openSidebar"><i class="fa fa-bars"></i></button>
      <input class="searchbar" type="text" placeholder="Buscar equipos, contratos, clientes..." />
      <div class="topbar-right">
        <span style="position:relative"><i class="fa fa-bell"></i><span class="notif-dot"></span></span>
        <div id="user-menu" style="position:relative;margin-left:18px;">
          <img id="avatar-img" src="img/default-user.png" alt="avatar" style="width:38px;height:38px;border-radius:50%;object-fit:cover;cursor:pointer;border:2px solid #e3f0ff;">
          <div id="user-dropdown" style="display:none;position:absolute;right:0;top:48px;z-index:100;background:#fff;border-radius:16px;box-shadow:0 2px 16px rgba(41,121,255,0.13);padding:18px 24px;min-width:220px;">
            <div style="display:flex;align-items:center;gap:14px;margin-bottom:12px;">
              <img id="avatar-img-dropdown" src="img/default-user.png" style="width:56px;height:56px;border-radius:50%;object-fit:cover;">
              <div>
                <div id="user-name" style="font-weight:700;font-size:1.1rem;"></div>
                <div id="user-role" style="color:#888;font-size:0.98rem;"></div>
                <div id="user-email" style="color:#888;font-size:0.95em;"></div>
              </div>
            </div>
            <a href="configuracion.html" style="display:block;margin-bottom:8px;color:#2979ff;text-decoration:none;">Configuración</a>
            <a href="#" id="logout-btn" style="color:#f44336;text-decoration:none;">Cerrar sesión</a>
          </div>
        </div>
      </div>
    </div>
    <div class="header-row">
      <div>
        <div class="header-title">Analytics y Reportes</div>
        <div class="header-desc">Análisis detallado del rendimiento del negocio</div>
      </div>
      <div class="header-actions">
        <select class="select-period">
          <option>Últimos 30 días</option>
          <option>Últimos 90 días</option>
          <option>Este año</option>
        </select>
        <button class="filter-btn"><i class="fa fa-filter"></i> Filtros</button>
        <button class="export-btn"><i class="fa fa-download"></i> Exportar</button>
      </div>
    </div>
    <div class="summary-cards">
      <div class="summary-card">
        <div class="icon"><i class="fa fa-cube"></i></div>
        <div class="info">
          <div class="label">Tasa de Utilización</div>
          <div class="value">72.5% <span class="trend">↗ +5.2%</span></div>
          <div class="desc">Promedio de equipos en uso</div>
        </div>
      </div>
      <div class="summary-card">
        <div class="icon"><i class="fa fa-dollar-sign"></i></div>
        <div class="info">
          <div class="label">Ingresos por Día</div>
          <div class="value">$4,150 <span class="trend">↗ +12.8%</span></div>
          <div class="desc">Promedio diario del mes</div>
        </div>
      </div>
      <div class="summary-card">
        <div class="icon"><i class="fa fa-clock"></i></div>
        <div class="info">
          <div class="label">Tiempo Promedio de Al...</div>
          <div class="value">18.5 <span style="font-size:1rem;">días</span> <span class="trend">↗ +2.1 días</span></div>
          <div class="desc">Duración promedio de contratos</div>
        </div>
      </div>
      <div class="summary-card">
        <div class="icon"><i class="fa fa-user-group"></i></div>
        <div class="info">
          <div class="label">Satisfacción del Cliente</div>
          <div class="value">4.6/5 <span class="trend">↗ +0.3</span></div>
          <div class="desc">Calificación promedio</div>
        </div>
      </div>
    </div>
    <div class="dashboard-row">
      <div class="dashboard-card">
        <h3>Ingresos y Contratos</h3>
        <canvas id="chartIngresos" height="260"></canvas>
      </div>
      <div class="dashboard-card">
        <h3>Segmentación de Clientes</h3>
        <canvas id="chartClientes" height="260"></canvas>
      </div>
    </div>
    <div class="equipos-card">
      <h3>Utilización de Equipos</h3>
      <div class="equipos-bar-label">Andamios Estándar <span>856/1247 (68.6%)</span></div>
      <div class="equipos-bar"><div class="equipos-bar-fill" style="width:68.6%;background:#2979ff;"></div></div>
      <div class="equipos-bar-label">Andamios Multidireccionales <span>324/450 (72.0%)</span></div>
      <div class="equipos-bar"><div class="equipos-bar-fill" style="width:72.0%;background:#2979ff;"></div></div>
      <div class="equipos-bar-label">Plataformas <span>189/280 (67.5%)</span></div>
      <div class="equipos-bar"><div class="equipos-bar-fill" style="width:67.5%;background:#2979ff;"></div></div>
      <div class="equipos-bar-label">Escaleras <span>145/220 (65.9%)</span></div>
      <div class="equipos-bar"><div class="equipos-bar-fill" style="width:65.9%;background:#2979ff;"></div></div>
      <div class="equipos-bar-label">Accesorios <span>567/890 (63.7%)</span></div>
      <div class="equipos-bar"><div class="equipos-bar-fill" style="width:63.7%;background:#2979ff;"></div></div>
    </div>
    <div class="dashboard-row2">
      <div class="dashboard-card">
        <h3>Análisis de Rentabilidad</h3>
        <canvas id="chartRentabilidad" height="220"></canvas>
      </div>
      <div class="dashboard-card">
        <h3>Tendencias de Mantenimiento</h3>
        <canvas id="chartMantenimiento" height="220"></canvas>
      </div>
    </div>
    <div class="dashboard-card" style="margin-bottom:0;">
      <h3>Métricas Detalladas por Categoría</h3>
      <table class="metrics-table">
        <thead>
          <tr>
            <th>CATEGORÍA</th>
            <th>INGRESOS</th>
            <th>COSTOS</th>
            <th>GANANCIA</th>
            <th>MARGEN</th>
            <th>TENDENCIA</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>Andamios Estándar</td>
            <td>$45,000</td>
            <td>$18,000</td>
            <td>$27,000</td>
            <td><span class="badge yellow">60.0%</span></td>
            <td><span class="trend-up">↗ +14%</span></td>
          </tr>
          <tr>
            <td>Andamios Multidireccionales</td>
            <td>$38,000</td>
            <td>$12,000</td>
            <td>$26,000</td>
            <td><span class="badge yellow">68.4%</span></td>
            <td><span class="trend-up">↗ +17%</span></td>
          </tr>
          <tr>
            <td>Plataformas</td>
            <td>$22,000</td>
            <td>$8,800</td>
            <td>$13,200</td>
            <td><span class="badge yellow">60.0%</span></td>
            <td><span class="trend-up">↗ +16%</span></td>
          </tr>
          <tr>
            <td>Escaleras</td>
            <td>$15,000</td>
            <td>$4,500</td>
            <td>$10,500</td>
            <td><span class="badge yellow">70.0%</span></td>
            <td><span class="trend-up">↗ +12%</span></td>
          </tr>
          <tr>
            <td>Accesorios</td>
            <td>$4,500</td>
            <td>$900</td>
            <td>$3,600</td>
            <td><span class="badge yellow">80.0%</span></td>
            <td><span class="trend-up">↗ +16%</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <!-- Modal Filtros Avanzados -->
  <div class="modal-bg-filtros" id="modalBgFiltros">
    <form class="modal-filtros" id="formFiltros">
      <button class="close-modal" type="button" id="closeFiltros">&times;</button>
      <h2>Filtros Avanzados</h2>
      <label>Periodo</label>
      <select id="filtroPeriodo">
        <option value="30">Últimos 30 días</option>
        <option value="90">Últimos 90 días</option>
        <option value="365">Este año</option>
      </select>
      <label>Tipo de Cliente</label>
      <select id="filtroCliente">
        <option value="todos">Todos</option>
        <option value="empresas">Empresas</option>
        <option value="particulares">Particulares</option>
        <option value="gobierno">Gobierno</option>
      </select>
      <label>Estado de Contrato</label>
      <select id="filtroEstado">
        <option value="todos">Todos</option>
        <option value="activo">Activo</option>
        <option value="finalizado">Finalizado</option>
        <option value="cancelado">Cancelado</option>
      </select>
      <div class="modal-actions">
        <button type="button" class="reset-btn" id="resetFiltros">Restablecer</button>
        <button type="submit" style="background:#2979ff;color:#fff;border:none;padding:8px 18px;border-radius:8px;">Aplicar</button>
      </div>
    </form>
  </div>
  <!-- Notificaciones -->
  <div class="notif-dropdown" id="notifDropdown">
    <div class="notif-header"><i class="fa fa-bell"></i> Notificaciones</div>
    <div class="notif-list" id="notifList">
      <!-- Notificaciones dinámicas -->
    </div>
    <div class="notif-footer"><a href="#">Ver todas</a></div>
  </div>
  <script>
    // Menú lateral desplegable (solo para pantallas pequeñas)
    const sidebar = document.getElementById('sidebar');
    const openSidebar = document.getElementById('openSidebar');
    const closeSidebar = document.getElementById('closeSidebar');
    if(openSidebar && closeSidebar && sidebar) {
      openSidebar.onclick = () => sidebar.classList.add('open');
      closeSidebar.onclick = () => sidebar.classList.remove('open');
    }
    // Modal Filtros Avanzados y lógica de filtros
    const modalBgFiltros = document.getElementById('modalBgFiltros');
    const formFiltros = document.getElementById('formFiltros');
    const closeFiltros = document.getElementById('closeFiltros');
    const resetFiltros = document.getElementById('resetFiltros');
    const filtroPeriodo = document.getElementById('filtroPeriodo');
    const filtroCliente = document.getElementById('filtroCliente');
    const filtroEstado = document.getElementById('filtroEstado');
    const filterBtn = document.querySelector('.filter-btn');
    let filtros = { periodo: '30', cliente: 'todos', estado: 'todos' };
    filterBtn.onclick = function() {
      modalBgFiltros.classList.add('active');
      filtroPeriodo.value = filtros.periodo;
      filtroCliente.value = filtros.cliente;
      filtroEstado.value = filtros.estado;
    };
    closeFiltros.onclick = () => modalBgFiltros.classList.remove('active');
    modalBgFiltros.onclick = e => { if(e.target === modalBgFiltros) modalBgFiltros.classList.remove('active'); };
    resetFiltros.onclick = () => {
      filtroPeriodo.value = '30'; filtroCliente.value = 'todos'; filtroEstado.value = 'todos';
    };
    formFiltros.onsubmit = function(e) {
      e.preventDefault();
      filtros = {
        periodo: filtroPeriodo.value,
        cliente: filtroCliente.value,
        estado: filtroEstado.value
      };
      modalBgFiltros.classList.remove('active');
      actualizarDashboard();
    };
    const API_URL = "http://localhost:3001/api/dashboard";
    function getToken() {
      return localStorage.getItem('token');
    }
    async function fetchDashboard(endpoint) {
      const token = getToken();
      const res = await fetch(`${API_URL}/${endpoint}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (!res.ok) throw new Error('Error al obtener datos');
      return await res.json();
    }

    // Instancias de Chart.js
    let chartIngresos, chartClientes, chartRentabilidad, chartMantenimiento;
    async function actualizarDashboard() {
      // 1. Tarjetas resumen
      try {
        // Tasa de Utilización
        const data = await fetchDashboard('utilizacion');
        document.querySelector('.summary-cards .summary-card:nth-child(1) .value').innerHTML =
          `${data.porcentaje.toFixed(1)}% <span class="trend">↗ +5.2%</span>`;
      } catch (e) {}
      try {
        // Ingresos por Día (promedio)
        const ingresos = await fetchDashboard('ingresos-dia');
        const total = ingresos.reduce((acc, d) => acc + Number(d.ingresos), 0);
        const promedio = ingresos.length ? total / ingresos.length : 0;
        document.querySelector('.summary-cards .summary-card:nth-child(2) .value').innerHTML =
          `$${Math.round(promedio).toLocaleString()} <span class="trend">↗ +12.8%</span>`;
      } catch (e) {}
      try {
        // Tiempo Promedio de Alquiler
        const res = await fetch('http://localhost:3001/api/contratos', {
          headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        const contratos = await res.json();
        const duraciones = contratos
          .filter(c => c.fecha_inicio && c.fecha_fin)
          .map(c => (new Date(c.fecha_fin) - new Date(c.fecha_inicio)) / (1000 * 60 * 60 * 24));
        const promedio = duraciones.length ? duraciones.reduce((a, b) => a + b, 0) / duraciones.length : 0;
        document.querySelector('.summary-cards .summary-card:nth-child(3) .value').innerHTML =
          `${promedio.toFixed(1)} <span style="font-size:1rem;">días</span> <span class="trend">↗ +2.1 días</span>`;
      } catch (e) {}
      try {
        // Satisfacción del Cliente
        const data = await fetchDashboard('satisfaccion');
        document.querySelector('.summary-cards .summary-card:nth-child(4) .value').innerHTML =
          `${data.promedio ? data.promedio.toFixed(2) : 'N/A'}/5 <span class="trend">↗ +0.3</span>`;
      } catch (e) {}

      // 2. Gráfico de Ingresos y Contratos
      try {
        const { ingresos, contratos } = await fetchDashboard('ingresos-contratos');
        const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
        const labels = ingresos.map(i => meses[new Date(i.mes).getMonth()]);
        const ingresosData = ingresos.map(i => Number(i.ingresos));
        const contratosData = contratos.map(c => Number(c.contratos));
        chartIngresos.data.labels = labels;
        chartIngresos.data.datasets[0].data = ingresosData;
        chartIngresos.data.datasets[1].data = contratosData;
        chartIngresos.update();
      } catch (e) {}

      // 3. Gráfico de Segmentación de Clientes
      try {
        const data = await fetchDashboard('segmentacion-clientes');
        const labels = data.map(d => d.tipo);
        const values = data.map(d => Number(d.count));
        chartClientes.data.labels = labels;
        chartClientes.data.datasets[0].data = values;
        chartClientes.update();
      } catch (e) {}

      // 4. Gráfico de Utilización de Equipos
      try {
        const data = await fetchDashboard('utilizacion-categorias');
        const container = document.querySelector('.equipos-card');
        container.innerHTML = '<h3>Utilización de Equipos</h3>';
        data.forEach(row => {
          const porcentaje = row.total > 0 ? (row.en_uso * 100 / row.total) : 0;
          container.innerHTML += `
            <div class="equipos-bar-label">${row.categoria} <span>${row.en_uso}/${row.total} (${porcentaje.toFixed(1)}%)</span></div>
            <div class="equipos-bar"><div class="equipos-bar-fill" style="width:${porcentaje}%;background:#2979ff;"></div></div>
          `;
        });
      } catch (e) {}

      // 5. Gráfico de Rentabilidad
      try {
        const data = await fetchDashboard('rentabilidad');
        chartRentabilidad.data.labels = data.map(d => d.categoria);
        chartRentabilidad.data.datasets[0].data = data.map(d => Number(d.ganancia));
        chartRentabilidad.update();
      } catch (e) {}

      // 6. Gráfico de Tendencias de Mantenimiento
      try {
        const data = await fetchDashboard('tendencias-mantenimiento');
        const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
        chartMantenimiento.data.labels = data.map(d => meses[new Date(d.mes).getMonth()]);
        chartMantenimiento.data.datasets[0].data = data.map(d => Number(d.mantenimientos));
        chartMantenimiento.update();
      } catch (e) {}

      // 7. Tabla de Métricas Detalladas por Categoría
      try {
        const data = await fetchDashboard('metricas-categorias');
        const tbody = document.querySelector('.metrics-table tbody');
        tbody.innerHTML = '';
        data.forEach(row => {
          tbody.innerHTML += `
            <tr>
              <td>${row.categoria}</td>
              <td>$${Number(row.ingresos).toLocaleString()}</td>
              <td>$${Number(row.costos).toLocaleString()}</td>
              <td>$${Number(row.ganancia).toLocaleString()}</td>
              <td><span class="badge yellow">${Number(row.margen).toFixed(1)}%</span></td>
              <td><span class="trend-up">↗ +16%</span></td>
            </tr>
          `;
        });
      } catch (e) {}
    }
    // Inicializar Chart.js y dashboard
    window.addEventListener('DOMContentLoaded', async () => {
      chartIngresos = new Chart(document.getElementById('chartIngresos').getContext('2d'), {
        type: 'line',
        data: {
          labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'],
          datasets: [
            { label: 'Ingresos', data: [], borderColor: '#2979ff', backgroundColor: 'rgba(41,121,255,0.13)', fill: true, tension:0.4 },
            { label: 'Contratos', data: [], borderColor: '#43a047', backgroundColor: 'rgba(67,160,71,0.10)', fill: true, tension:0.4, yAxisID: 'y1' }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          scales: { y: { beginAtZero: true }, y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false } } }
        }
      });
      chartClientes = new Chart(document.getElementById('chartClientes').getContext('2d'), {
        type: 'doughnut',
        data: {
          labels: [],
          datasets: [{ data: [], backgroundColor: ['#2979ff','#43a047','#ffc107'] }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
      });
      chartRentabilidad = new Chart(document.getElementById('chartRentabilidad').getContext('2d'), {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{ label: 'Rentabilidad', data: [], backgroundColor: '#2979ff' }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
      chartMantenimiento = new Chart(document.getElementById('chartMantenimiento').getContext('2d'), {
        type: 'line',
        data: {
          labels: [],
          datasets: [{ label: 'Mantenimientos', data: [], borderColor: '#ffc107', backgroundColor: 'rgba(255,193,7,0.10)', fill: true, tension:0.4 }]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
      });
      await actualizarDashboard();
    });
    // Exportar a PDF profesional
    const exportBtn = document.querySelector('.export-btn');
    exportBtn.onclick = function() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: 'landscape', unit: 'pt', format: 'a4' });
      doc.setFont('helvetica','bold');
      doc.setFontSize(22);
      doc.text('Reporte de Analytics - ScaffoldPro', 40, 50);
      doc.setFontSize(13);
      doc.setFont('helvetica','normal');
      doc.text('Generado: ' + new Date().toLocaleString(), 40, 70);
      // Resumen
      doc.setFillColor(227,240,255);
      doc.roundedRect(30, 90, 780, 60, 12, 12, 'F');
      doc.setFontSize(15);
      doc.text('Resumen Ejecutivo', 50, 115);
      doc.setFontSize(12);
      doc.text('Tasa de Utilización: ' + document.querySelector('.summary-cards .summary-card:nth-child(1) .value').innerText, 60, 140);
      doc.text('Ingresos por Día: ' + document.querySelector('.summary-cards .summary-card:nth-child(2) .value').innerText, 220, 140);
      doc.text('Tiempo Promedio de Alquiler: ' + document.querySelector('.summary-cards .summary-card:nth-child(3) .value').innerText, 400, 140);
      doc.text('Satisfacción Cliente: ' + document.querySelector('.summary-cards .summary-card:nth-child(4) .value').innerText, 650, 140);
      // Tabla de métricas
      let tabla = [];
      document.querySelectorAll('.metrics-table tbody tr').forEach(tr => {
        let row = [];
        tr.querySelectorAll('td').forEach(td => row.push(td.innerText));
        tabla.push(row);
      });
      doc.autoTable({
        startY: 170,
        head: [['Categoría','Ingresos','Costos','Ganancia','Margen','Tendencia']],
        body: tabla,
        theme: 'grid',
        headStyles: { fillColor: [41,121,255], textColor:255, fontStyle:'bold' },
        styles: { font:'helvetica', fontSize:11, cellPadding:4 },
        margin: { left: 40, right: 40 },
        tableWidth: 760
      });
      // Pie de página
      doc.setFontSize(10);
      doc.setTextColor(150);
      doc.text('ScaffoldPro - Reporte generado automáticamente', 40, 560);
      doc.save('reporte-analytics.pdf');
    };
    // Notificaciones UX mejorado
    const notifIcon = document.querySelector('.topbar-right .fa-bell');
    const notifDropdown = document.getElementById('notifDropdown');
    const notifList = document.getElementById('notifList');
    let notificaciones = [
      { icon: 'fa-bell', texto: 'Nueva entrega programada', unread: true, time: 'hoy' },
      { icon: 'fa-truck', texto: 'Vehículo en ruta', unread: false, time: 'hace 2h' },
      { icon: 'fa-exclamation-triangle', texto: 'Entrega retrasada', unread: true, time: 'ayer' },
    ];
    function renderNotificaciones() {
      notifList.innerHTML = '';
      if (notificaciones.length === 0) {
        notifList.innerHTML = `<div class='notif-empty'>Sin notificaciones</div>`;
        return;
      }
      notificaciones.forEach((n, i) => {
        notifList.innerHTML += `<div class='notif-item${n.unread ? ' unread' : ''}' data-idx='${i}'><i class='fa ${n.icon}'></i> <span>${n.texto}</span><span style='margin-left:auto;color:#888;font-size:0.93em;'>${n.time}</span></div>`;
      });
    }
    renderNotificaciones();
    notifIcon.onclick = e => {
      notifDropdown.classList.toggle('active');
      notifDropdown.style.right = '0px';
      notifDropdown.style.top = notifIcon.getBoundingClientRect().bottom + 8 + 'px';
    };
    document.addEventListener('click', e => {
      if(!notifDropdown.contains(e.target) && e.target !== notifIcon) notifDropdown.classList.remove('active');
    });
    notifList.onclick = function(e) {
      const item = e.target.closest('.notif-item');
      if (!item) return;
      const idx = item.dataset.idx;
      notificaciones[idx].unread = false;
      renderNotificaciones();
    };
    // Menú usuario UX mejorado
    const avatar = document.querySelector('.avatar');
    const userMenu = document.getElementById('userMenu');
    avatar.onclick = e => {
      userMenu.classList.toggle('active');
      userMenu.style.right = '0px';
      userMenu.style.top = avatar.getBoundingClientRect().bottom + 8 + 'px';
    };
    document.addEventListener('click', e => {
      if(!userMenu.contains(e.target) && e.target !== avatar) userMenu.classList.remove('active');
    });
  </script>
  <script>
(function() {
  const user = JSON.parse(localStorage.getItem('user') || '{}');
  const avatarImg = document.getElementById('avatar-img');
  const avatarDropdown = document.getElementById('avatar-img-dropdown');
  const userName = document.getElementById('user-name');
  const userRole = document.getElementById('user-role');
  const userEmail = document.getElementById('user-email');
  const dropdown = document.getElementById('user-dropdown');
  if (user && avatarImg) {
    avatarImg.src = user.foto || 'img/default-user.png';
    avatarImg.onerror = () => { avatarImg.src = 'img/default-user.png'; };
  }
  if (user && avatarDropdown) {
    avatarDropdown.src = user.foto || 'img/default-user.png';
    avatarDropdown.onerror = () => { avatarDropdown.src = 'img/default-user.png'; };
  }
  if (userName) userName.textContent = user.nombre || '';
  if (userRole) userRole.textContent = user.rol || '';
  if (userEmail) userEmail.textContent = user.correo || '';
  if (avatarImg && dropdown) {
    avatarImg.onclick = function(e) {
      e.stopPropagation();
      dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    };
    document.body.addEventListener('click', function(e) {
      if (!e.target.closest('#user-menu')) dropdown.style.display = 'none';
    });
  }
  const logoutBtn = document.getElementById('logout-btn');
  if (logoutBtn) {
    logoutBtn.onclick = function(e) {
      e.preventDefault();
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    };
  }
})();
</script>
</body>
</html>