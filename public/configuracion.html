<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configuración del Sistema - ScaffoldPro</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    body { margin: 0; background: #f7f9fb; font-family: 'Segoe UI', Arial, sans-serif; color: #232323; }
    .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 270px; background: #fff; box-shadow: 2px 0 8px rgba(0,0,0,0.04); z-index: 20; display: flex; flex-direction: column; padding: 24px 0 0 0; height: 100vh; }
    .sidebar .logo { font-size: 1.7rem; font-weight: 700; color: #2979ff; margin-left: 32px; margin-bottom: 32px; letter-spacing: -1px; display: flex; align-items: center; justify-content: space-between; }
    .sidebar ul { list-style: none; padding: 0; margin: 0; flex: 1; }
    .sidebar li { margin-bottom: 6px; }
    .sidebar a { display: flex; align-items: center; gap: 16px; padding: 12px 32px; color: #6b7280; text-decoration: none; font-size: 1.08rem; border-radius: 10px 20px 20px 10px; transition: background 0.2s, color 0.2s; }
    .sidebar a.active, .sidebar a:hover { background: #e3f0ff; color: #2979ff; font-weight: 600; }
    .sidebar a .fa { font-size: 1.2rem; width: 22px; text-align: center; }
    .main-content { margin-left: 270px; padding: 32px 40px 40px 40px; min-height: 100vh; max-width: 1600px; }
    .config-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
    .config-title { font-size: 2.3rem; font-weight: 700; }
    .config-desc { color: #6b7280; margin-bottom: 18px; }
    .config-actions { display: flex; gap: 14px; }
    .reset-btn { border: 1px solid #e3e8ef; background: #f3f6fa; color: #232323; border-radius: 8px; padding: 10px 18px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: background 0.2s, color 0.2s, border 0.2s; }
    .reset-btn:hover { background: #e3f0ff; color: #2979ff; border: 1px solid #b6d4fe; }
    .save-btn { background: #22c8fa; color: #fff; border: none; border-radius: 8px; padding: 10px 18px; font-size: 1rem; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(41,121,255,0.08); transition: background 0.2s; }
    .save-btn:hover { background: #38b6ff; }
    .config-panel { display: flex; gap: 32px; }
    .config-nav { background: #fff; border-radius: 14px; padding: 18px 0; min-width: 240px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); display: flex; flex-direction: column; gap: 2px; }
    .config-nav-btn { display: flex; align-items: center; gap: 14px; padding: 12px 32px; font-size: 1.1rem; color: #232323; background: none; border: none; border-radius: 8px; cursor: pointer; text-align: left; transition: background 0.2s, color 0.2s; }
    .config-nav-btn.active, .config-nav-btn:hover { background: #e3f0ff; color: #2979ff; font-weight: 600; }
    .config-section { flex: 1; background: #fff; border-radius: 14px; padding: 32px 40px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .config-section h2 { font-size: 1.3rem; font-weight: 700; margin-bottom: 24px; }
    .form-row { display: flex; gap: 32px; margin-bottom: 18px; }
    .form-group { flex: 1; margin-bottom: 18px; }
    .form-label { font-weight: 600; margin-bottom: 6px; display: block; }
    .form-input, .form-select { width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid #e3e8ef; background: #f7f9fb; font-size: 1rem; outline: none; margin-bottom: 4px; }
    .form-select { background: #fff; }
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; vertical-align: middle; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #e3e8ef; border-radius: 24px; transition: .4s; }
    .switch input:checked + .slider { background: #2979ff; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: .4s; }
    .switch input:checked + .slider:before { transform: translateX(20px); }
    .form-check { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .form-check input[type=checkbox] { accent-color: #2979ff; width: 18px; height: 18px; }
    .logo-upload { display: flex; align-items: center; gap: 18px; margin-top: 12px; }
    .logo-preview { width: 64px; height: 64px; border-radius: 12px; object-fit: cover; border: 1px solid #e3e8ef; }
    .upload-btn { border: 1px solid #e3e8ef; background: #fff; color: #232323; border-radius: 8px; padding: 10px 18px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .upload-btn:hover { background: #f1f5f9; }
    .info-text { color: #888; font-size: 0.98rem; margin-top: 4px; }
    @media (max-width: 1200px) { .main-content { margin-left: 0; padding: 24px 8px 8px 8px; } .sidebar { position: absolute; z-index: 100; transform: translateX(-100%); } .sidebar.open { transform: translateX(0); } .config-panel { flex-direction: column; gap: 18px; } }
    @media (max-width: 900px) { .config-panel { flex-direction: column; gap: 18px; } .config-section { padding: 18px 8px; } }
    @media (max-width: 600px) { .main-content { padding: 8px; } .config-section { padding: 8px 2px; } }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="logo">ScaffoldPro</div>
    <ul>
      <li><a href="dashboard.html"><i class="fa fa-house"></i> Dashboard</a></li>
      <li><a href="inventario.html"><i class="fa fa-cube"></i> Inventario</a></li>
      <li><a href="contratos.html"><i class="fa fa-file-contract"></i> Contratos</a></li>
      <li><a href="clientes.html"><i class="fa fa-users"></i> Clientes</a></li>
      <li><a href="facturacion.html"><i class="fa fa-file-invoice-dollar"></i> Facturación</a></li>
      <li><a href="mantenimiento.html"><i class="fa fa-screwdriver-wrench"></i> Mantenimiento</a></li>
      <li><a href="logistica.html"><i class="fa fa-truck"></i> Logística</a></li>
      <li><a href="proyectos.html"><i class="fa fa-diagram-project"></i> Proyectos</a></li>
      <li><a href="#"><i class="fa fa-shield-halved"></i> Calidad</a></li>
      <li><a href="analisis.html"><i class="fa fa-chart-bar"></i> Analytics</a></li>
      <li><a href="notificaciones.html"><i class="fa fa-bell"></i> Notificaciones</a></li>
      <li><a href="#" ><i class="fa fa-gear"></i> Configuración</a></li>
    </ul>
  </aside>
  <div class="main-content">
    <div class="config-header">
      <div>
        <div class="config-title">Configuración del Sistema</div>
        <div class="config-desc">Gestiona la configuración general del sistema y preferencias</div>
      </div>
      <div class="config-actions">
        <button class="reset-btn">Restablecer</button>
        <button class="save-btn"><i class="fa fa-save"></i> Guardar Cambios</button>
      </div>
    </div>
    <div class="config-panel">
      <nav class="config-nav">
        <button class="config-nav-btn active"><i class="fa fa-gear"></i> General</button>
        <button class="config-nav-btn"><i class="fa fa-building"></i> Empresa</button>
        <button class="config-nav-btn"><i class="fa fa-users"></i> Usuarios</button>
        <button class="config-nav-btn"><i class="fa fa-shield"></i> Seguridad</button>
        <button class="config-nav-btn"><i class="fa fa-bell"></i> Notificaciones</button>
        <button class="config-nav-btn"><i class="fa fa-cube"></i> Inventario</button>
        <button class="config-nav-btn"><i class="fa fa-file-invoice-dollar"></i> Facturación</button>
        <button class="config-nav-btn"><i class="fa fa-file-alt"></i> Reportes</button>
        <button class="config-nav-btn"><i class="fa fa-database"></i> Sistema</button>
        <button class="config-nav-btn"><i class="fa fa-palette"></i> Apariencia</button>
      </nav>
      <section class="config-section" id="section-general">
        <h2>Configuración General</h2>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Nombre del Sistema</label>
            <input class="form-input" type="text" value="ScaffoldPro" />
          </div>
          <div class="form-group">
            <label class="form-label">Zona Horaria</label>
            <select class="form-select">
              <option>America/Mexico_City</option>
              <option>America/New_York</option>
              <option>America/Los_Angeles</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Idioma</label>
            <select class="form-select">
              <option>Español</option>
              <option>English</option>
              <option>Français</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Moneda</label>
            <select class="form-select">
              <option>MXN - Peso Mexicano</option>
              <option>USD - Dólar Americano</option>
              <option>EUR - Euro</option>
            </select>
          </div>
        </div>
      </section>
      <section class="config-section" id="section-empresa" style="display:none;">
        <h2>Información de la Empresa</h2>
        <div class="form-group">
          <label class="form-label">Nombre de la Empresa</label>
          <input class="form-input" id="empresa-nombre" type="text" />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">RFC</label>
            <input class="form-input" type="text" value="AAP123456789" />
          </div>
          <div class="form-group">
            <label class="form-label">Teléfono</label>
            <input class="form-input" type="text" value="+52 55 1234-5678" />
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Dirección</label>
          <textarea class="form-input" style="resize:vertical;min-height:40px;">Av. Industrial 123, Col. Centro, Ciudad de México, CP 01000</textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Email</label>
            <input class="form-input" type="email" value="contacto@scaffoldpro.com" />
          </div>
          <div class="form-group">
            <label class="form-label">Sitio Web</label>
            <input class="form-input" type="url" value="https://www.scaffoldpro.com" />
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Logo de la Empresa</label>
          <div class="logo-upload">
            <img class="logo-preview" id="logo-preview" src="logo-demo.jpg" alt="Logo" />
            <input type="file" id="logo-input" accept="image/png, image/jpeg" style="display:none;" />
            <button class="upload-btn" id="logo-upload-btn" type="button"><i class="fa fa-upload"></i> Cambiar Logo</button>
          </div>
          <div class="info-text">JPG, PNG hasta 2MB. Recomendado: 200x200px</div>
        </div>
      </section>
      <section class="config-section" id="section-usuarios" style="display:none;">
        <h2>Gestión de Usuarios</h2>
        <button id="btnAgregarUsuario" style="background:#2979ff;color:#fff;border:none;border-radius:10px;padding:10px 22px;font-size:1.1rem;font-weight:600;display:flex;align-items:center;gap:8px;cursor:pointer;margin-bottom:18px;"><i class="fa fa-user-plus"></i> Agregar Usuario</button>
        <table id="usuarios-table" style="width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 2px 8px rgba(41,121,255,0.04);">
          <thead style="background:#f7f9fb;">
            <tr>
              <th style="padding:14px 8px;text-align:left;color:#232323;font-weight:700;">Foto</th>
              <th style="padding:14px 8px;text-align:left;color:#232323;font-weight:700;">Nombre</th>
              <th style="padding:14px 8px;text-align:left;color:#232323;font-weight:700;">Correo</th>
              <th style="padding:14px 8px;text-align:left;color:#232323;font-weight:700;">Rol</th>
              <th style="padding:14px 8px;text-align:left;color:#232323;font-weight:700;">Estado</th>
              <th style="padding:14px 8px;text-align:left;color:#232323;font-weight:700;">Acciones</th>
            </tr>
          </thead>
          <tbody id="usuarios-tbody">
            <tr><td colspan="5" style="padding:18px;text-align:center;color:#888;">Cargando usuarios...</td></tr>
          </tbody>
        </table>
      </section>
      <section class="config-section" id="section-seguridad" style="display:none;">
        <h2>Configuración de Seguridad</h2>
        <div class="form-group">
          <label class="form-label">Autenticación de Dos Factores</label>
          <label class="switch"><input type="checkbox" checked><span class="slider"></span></label>
          <div class="info-text">Añade una capa extra de seguridad a tu cuenta</div>
        </div>
        <div class="form-group">
          <label class="form-label">Sesiones Múltiples</label>
          <label class="switch"><input type="checkbox"><span class="slider"></span></label>
          <div class="info-text">Permitir múltiples sesiones activas por usuario</div>
        </div>
        <div class="form-group">
          <label class="form-label">Bloqueo Automático</label>
          <select class="form-select">
            <option>15 minutos</option>
            <option>30 minutos</option>
            <option>1 hora</option>
          </select>
          <div class="info-text">Bloquear sesión después de inactividad</div>
        </div>
        <h3 style="margin-top:32px;">Políticas de Contraseña</h3>
        <div class="form-group">
          <label class="form-label">Longitud Mínima</label>
          <input class="form-input" type="number" min="6" value="8" />
        </div>
        <div class="form-check"><input type="checkbox" checked> Requerir mayúsculas</div>
        <div class="form-check"><input type="checkbox" checked> Requerir números</div>
        <div class="form-check"><input type="checkbox" checked> Requerir caracteres especiales</div>
      </section>
      <section class="config-section" id="section-notificaciones" style="display:none;">
        <h2>Configuración de Notificaciones</h2>
        <div class="form-group">
          <b>Alertas de Inventario</b><br>
          <div class="form-check"><input type="checkbox" checked> Stock bajo</div>
          <div class="form-check"><input type="checkbox" checked> Equipos en mantenimiento</div>
        </div>
        <div class="form-group">
          <b>Contratos y Facturación</b><br>
          <div class="form-check"><input type="checkbox" checked> Contratos próximos a vencer</div>
          <div class="form-check"><input type="checkbox" checked> Pagos vencidos</div>
        </div>
        <div class="form-group">
          <b>Métodos de Entrega</b><br>
          <div class="form-check"><input type="checkbox" checked> Notificaciones por email</div>
          <div class="form-check"><input type="checkbox"> Notificaciones SMS</div>
        </div>
      </section>
      <section class="config-section" id="section-inventario" style="display:none;">
        <h2>Configuración de Inventario</h2>
        <div class="info-text">Opciones de inventario próximamente.</div>
      </section>
      <section class="config-section" id="section-facturacion" style="display:none;">
        <h2>Configuración de Facturación</h2>
        <div class="info-text">Opciones de facturación próximamente.</div>
      </section>
      <section class="config-section" id="section-reportes" style="display:none;">
        <h2>Configuración de Reportes</h2>
        <div class="info-text">Opciones de reportes próximamente.</div>
      </section>
      <section class="config-section" id="section-sistema" style="display:none;">
        <h2>Configuración del Sistema</h2>
        <div class="form-group">
          <b>Respaldo de Datos</b><br>
          <div class="form-check"><input type="checkbox" checked> Respaldo automático</div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Frecuencia de respaldo</label>
              <select class="form-select">
                <option>Diario</option>
                <option>Semanal</option>
                <option>Mensual</option>
              </select>
            </div>
            <div class="form-group" style="display:flex;align-items:end;gap:8px;">
              <button class="upload-btn"><i class="fa fa-download"></i> Descargar Respaldo</button>
              <button class="upload-btn"><i class="fa fa-upload"></i> Restaurar Respaldo</button>
            </div>
          </div>
        </div>
        <div class="form-group">
          <b>Mantenimiento del Sistema</b><br>
          <div class="form-check"><input type="checkbox"> Modo mantenimiento</div>
          <div class="form-check"><input type="checkbox" checked> Actualizaciones automáticas</div>
        </div>
        <div class="form-group">
          <b>Información del Sistema</b><br>
          <div class="info-text">Versión: v2.1.0<br>Última actualización: 15 Enero 2024<br>Base de datos: PostgreSQL 14.2<br>Espacio usado: 2.4 GB / 10 GB</div>
        </div>
      </section>
      <section class="config-section" id="section-apariencia" style="display:none;">
        <h2>Configuración de Apariencia</h2>
        <div class="form-group">
          <label class="form-label">Tema</label>
          <select class="form-select" id="theme-select">
            <option value="light">Claro</option>
            <option value="dark">Oscuro</option>
            <option value="system">Sistema</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Color Primario</label>
          <input type="color" id="primary-color-picker" value="#2979ff" style="width:48px;height:36px;border:none;background:none;cursor:pointer;" />
        </div>
        <div class="info-text">Elige el tema y color principal de la aplicación. Se aplicará en tiempo real.</div>
      </section>
    </div>
    <!-- Modal Agregar Usuario -->
    <div id="modalAgregarUsuario" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:200;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:32px 28px 22px 28px;border-radius:16px;min-width:350px;max-width:98vw;max-height:92vh;overflow-y:auto;box-shadow:0 2px 16px rgba(41,121,255,0.13);position:relative;">
        <span id="closeAgregarUsuario" style="position:absolute;top:12px;right:18px;font-size:1.5rem;cursor:pointer;color:#888;">&times;</span>
        <h2 style="margin-top:0;margin-bottom:18px;font-size:1.3rem;font-weight:700;">Agregar Usuario</h2>
        <form id="formAgregarUsuario">
          <div style="margin-bottom:12px;"><label>Nombre</label><input id="add-nombre" type="text" required style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #e3e8ef;" /></div>
          <div style="margin-bottom:12px;"><label>Correo</label><input id="add-correo" type="email" required style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #e3e8ef;" /></div>
          <div style="margin-bottom:12px;"><label>Contraseña</label><input id="add-password" type="password" required style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #e3e8ef;" /></div>
          <div style="margin-bottom:12px;"><label>Confirmar Contraseña</label><input id="add-password2" type="password" required style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #e3e8ef;" /></div>
          <div style="margin-bottom:12px;"><label>Rol</label><select id="add-rol" required style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #e3e8ef;">
            <option>Rentas</option><option>Admin</option><option>Operador</option><option>Ventas</option><option>Recepción</option><option>Contabilidad</option><option>Director General</option><option>Ingeniero en Sistemas</option><option>Ingeniero en Calidad</option><option>Ingeniero en Proyectos</option>
          </select></div>
          <div style="margin-bottom:12px;">
            <label>Foto de perfil</label>
            <input id="add-foto-file" type="file" accept="image/*" style="display:block;margin-bottom:6px;">
            <input id="add-foto" type="hidden">
            <img id="add-foto-preview" src="img/default-user.png" style="width:48px;height:48px;border-radius:50%;object-fit:cover;display:none;">
          </div>
          <div style="margin-bottom:18px;"><label>Estado</label><select id="add-estado" required style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #e3e8ef;">
            <option>Activo</option><option>Inactivo</option>
          </select></div>
          <button type="submit" style="background:#2979ff;color:#fff;border:none;border-radius:8px;padding:12px 0;font-size:1.1rem;font-weight:600;width:100%;">Crear Usuario</button>
        </form>
      </div>
    </div>
    
    <!-- Modal Editar Usuario -->
    <div id="modalEditarUsuario" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);z-index:200;align-items:center;justify-content:center;">
      <div style="background:#fff;padding:32px 28px 22px 28px;border-radius:16px;min-width:350px;max-width:98vw;max-height:92vh;overflow-y:auto;box-shadow:0 2px 16px rgba(41,121,255,0.13);position:relative;">
        <span id="closeEditarUsuario" style="position:absolute;top:12px;right:18px;font-size:1.5rem;cursor:pointer;color:#888;">&times;</span>
        <h2 style="margin-top:0;margin-bottom:18px;font-size:1.3rem;font-weight:700;">Editar Usuario</h2>
        <form id="formEditarUsuario">
          <div style="margin-bottom:12px;"><label>Nombre</label><input id="edit-nombre" type="text" required style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #e3e8ef;" /></div>
          <div style="margin-bottom:12px;"><label>Correo</label><input id="edit-correo" type="email" required style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #e3e8ef;" /></div>
          <div style="margin-bottom:12px;"><label>Rol</label><select id="edit-rol" required style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #e3e8ef;">
            <option>Rentas</option><option>Admin</option><option>Operador</option><option>Ventas</option><option>Recepción</option><option>Contabilidad</option><option>Director General</option><option>Ingeniero en Sistemas</option><option>Ingeniero en Calidad</option><option>Ingeniero en Proyectos</option>
          </select></div>
          <div style="margin-bottom:12px;">
            <label>Foto de perfil</label>
            <input id="edit-foto-file" type="file" accept="image/*" style="display:block;margin-bottom:6px;">
            <input id="edit-foto" type="hidden">
            <img id="edit-foto-preview" src="img/default-user.png" style="width:48px;height:48px;border-radius:50%;object-fit:cover;display:none;">
          </div>
          <div style="margin-bottom:18px;"><label>Estado</label><select id="edit-estado" required style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid #e3e8ef;">
            <option>Activo</option><option>Inactivo</option>
          </select></div>
          <button type="submit" style="background:#2979ff;color:#fff;border:none;border-radius:8px;padding:12px 0;font-size:1.1rem;font-weight:600;width:100%;">Guardar</button>
        </form>
      </div>
    </div>
  </div>
  <script>
    // Cambiar de sección en configuración
    const navBtns = document.querySelectorAll('.config-nav-btn');
    const sections = [
      'section-general',
      'section-empresa',
      'section-usuarios',
      'section-seguridad',
      'section-notificaciones',
      'section-inventario',
      'section-facturacion',
      'section-reportes',
      'section-sistema',
      'section-apariencia'
    ];

    function resizeImage(base64Str, maxWidth = 128, maxHeight = 128) {
      return new Promise((resolve, reject) => { // Usar reject para manejar errores
        let img = new Image();
        img.src = base64Str;
        img.onload = () => {
          let canvas = document.createElement('canvas');
          let width = img.width;
          let height = img.height;
 
          if (width > height) {
            if (width > maxWidth) {
              height *= maxWidth / width;
              width = maxWidth;
            }
          } else {
            if (height > maxHeight) {
              width *= maxHeight / height;
              height = maxHeight;
            }
          }
          canvas.width = width;
          canvas.height = height;
          let ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          resolve(canvas.toDataURL('image/jpeg', 0.8)); // Usar JPEG para mejor compresión
        };
        img.onerror = (err) => {
          console.error("Error al cargar la imagen para redimensionar:", err);
          reject(new Error("No se pudo procesar la imagen. Intenta con otra o una más pequeña."));
        };
      });
    }

    navBtns.forEach((btn, idx) => {
      btn.onclick = () => {
        navBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        sections.forEach((id, i) => {
          document.getElementById(id).style.display = (i === idx) ? '' : 'none';
        });
      };
    });
    // Gestión de usuarios - código limpio
    // Modal Agregar Usuario
    const modalAgregar = document.getElementById('modalAgregarUsuario');
    const closeAgregar = document.getElementById('closeAgregarUsuario');
    const formAgregar = document.getElementById('formAgregarUsuario');
    
    document.getElementById('btnAgregarUsuario').onclick = function() {
      formAgregar.reset();
      modalAgregar.style.display = 'flex';
    };
    
    closeAgregar.onclick = () => { modalAgregar.style.display = 'none'; };
    
    // JS para preview y base64 en agregar usuario
    document.getElementById('add-foto-file').onchange = function(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.type.match('image.*')) {
        alert('Solo se permiten imágenes');
        return;
      }
      const reader = new FileReader();
      reader.onload = async function(evt) {
        try {
          const resizedDataUrl = await resizeImage(evt.target.result);
          document.getElementById('add-foto').value = resizedDataUrl;
          document.getElementById('add-foto-preview').src = resizedDataUrl;
          document.getElementById('add-foto-preview').style.display = 'inline-block';
        } catch (resizeError) {
          alert(resizeError.message);
          e.target.value = ''; // Limpiar el input de archivo
          document.getElementById('add-foto').value = '';
          document.getElementById('add-foto-preview').style.display = 'none';
        }
      };
      reader.readAsDataURL(file);
    };

    formAgregar.onsubmit = async function(e) {
      e.preventDefault();
      const nombre = document.getElementById('add-nombre').value.trim();
      const correo = document.getElementById('add-correo').value.trim();
      const password = document.getElementById('add-password').value;
      const password2 = document.getElementById('add-password2').value;
      const rol = document.getElementById('add-rol').value;
      const estado = document.getElementById('add-estado').value;
      const foto = document.getElementById('add-foto').value;
      
      if(password !== password2) {
        alert('Las contraseñas no coinciden');
        return;
      }
      
      try {
        const res = await fetch('http://localhost:3001/api/usuarios', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${getToken()}` },
          body: JSON.stringify({ nombre, correo, password, rol, estado, foto })
        });
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({ error: `Error del servidor: ${res.status}` }));
          throw new Error(errorData.error || 'Ocurrió un error desconocido.');
        }
        
        modalAgregar.style.display = 'none';
        await cargarUsuarios();
        alert('Usuario creado correctamente.');
      } catch (err) {
        alert(err.message); // Muestra el error específico del servidor (ej: "El correo ya está en uso.")
      }
    };

    // --- Configuración persistente ---
    const defaultConfig = {
      general: {
        nombreSistema: 'ScaffoldPro',
        zonaHoraria: 'America/Mexico_City',
        idioma: 'Español',
        moneda: 'MXN - Peso Mexicano',
      },
      empresa: {
        nombre: 'Alquileres de Andamios Pro S.A. de C.V.',
        rfc: 'AAP123456789',
        telefono: '+52 55 1234-5678',
        direccion: 'Av. Industrial 123, Col. Centro, Ciudad de México, CP 01000',
        email: 'contacto@scaffoldpro.com',
        web: 'https://www.scaffoldpro.com',
        logo: 'logo-demo.jpg',
      },
      apariencia: {
        tema: 'light',
        colorPrimario: '#2979ff',
      }
      // Puedes agregar más secciones aquí si lo deseas
    };
    function saveConfig(config) {
      localStorage.setItem('scaffoldpro_config', JSON.stringify(config));
    }
    function loadConfig() {
      const c = localStorage.getItem('scaffoldpro_config');
      return c ? JSON.parse(c) : JSON.parse(JSON.stringify(defaultConfig));
    }
    function resetConfig() {
      saveConfig(defaultConfig);
      location.reload();
    }
    let config = loadConfig();
    // --- Aplicar tema y color primario ---
    function applyAppearance() {
      const tema = config.apariencia.tema;
      const color = config.apariencia.colorPrimario;
      document.documentElement.style.setProperty('--primary-color', color);
      if (tema === 'dark' || (tema === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.body.classList.add('dark-theme');
      } else {
        document.body.classList.remove('dark-theme');
      }
    }
    // --- Guardar cambios ---
    document.querySelector('.save-btn').onclick = function() {
      // General
      config.general.nombreSistema = document.querySelector('#section-general input[type="text"]').value;
      config.general.zonaHoraria = document.querySelector('#section-general select').value;
      config.general.idioma = document.querySelectorAll('#section-general select')[1].value;
      config.general.moneda = document.querySelectorAll('#section-general select')[2].value;
      // Empresa
      config.empresa.nombre = document.getElementById('empresa-nombre').value;
      config.empresa.rfc = document.querySelectorAll('#section-empresa input[type="text"]')[1].value;
      config.empresa.telefono = document.querySelectorAll('#section-empresa input[type="text"]')[2].value;
      config.empresa.direccion = document.querySelector('#section-empresa textarea').value;
      config.empresa.email = document.querySelector('#section-empresa input[type="email"]').value;
      config.empresa.web = document.querySelector('#section-empresa input[type="url"]').value;
      // Apariencia
      config.apariencia.tema = document.getElementById('theme-select').value;
      config.apariencia.colorPrimario = document.getElementById('primary-color-picker').value;
      saveConfig(config);
      applyAppearance();
      showToast('¡Configuración guardada!');
    };
    // --- Restablecer ---
    document.querySelector('.reset-btn').onclick = function() {
      if(confirm('¿Restablecer configuración a valores por defecto?')) resetConfig();
    };
    // --- Cargar valores al iniciar ---
    function loadValues() {
      // General
      document.querySelector('#section-general input[type="text"]').value = config.general.nombreSistema;
      document.querySelector('#section-general select').value = config.general.zonaHoraria;
      document.querySelectorAll('#section-general select')[1].value = config.general.idioma;
      document.querySelectorAll('#section-general select')[2].value = config.general.moneda;
      // Empresa
      document.getElementById('empresa-nombre').value = config.empresa.nombre;
      document.querySelectorAll('#section-empresa input[type="text"]')[1].value = config.empresa.rfc;
      document.querySelectorAll('#section-empresa input[type="text"]')[2].value = config.empresa.telefono;
      document.querySelector('#section-empresa textarea').value = config.empresa.direccion;
      document.querySelector('#section-empresa input[type="email"]').value = config.empresa.email;
      document.querySelector('#section-empresa input[type="url"]').value = config.empresa.web;
      // Logo
      const logoPreview = document.getElementById('logo-preview');
      if (config.empresa.logo && config.empresa.logo.startsWith('data:image')) {
        logoPreview.src = config.empresa.logo;
      } else {
        logoPreview.src = 'img/logo-demo.jpg';
      }
      // Apariencia
      document.getElementById('theme-select').value = config.apariencia.tema;
      document.getElementById('primary-color-picker').value = config.apariencia.colorPrimario;
      applyAppearance();
    }
    loadValues();
    // --- Apariencia en tiempo real ---
    document.getElementById('theme-select').onchange = function() {
      config.apariencia.tema = this.value;
      applyAppearance();
    };
    document.getElementById('primary-color-picker').oninput = function() {
      config.apariencia.colorPrimario = this.value;
      applyAppearance();
    };
    // --- Toast feedback ---
    function showToast(msg) {
      let toast = document.createElement('div');
      toast.innerText = msg;
      toast.style.position = 'fixed';
      toast.style.bottom = '32px';
      toast.style.right = '32px';
      toast.style.background = '#2979ff';
      toast.style.color = '#fff';
      toast.style.padding = '14px 28px';
      toast.style.borderRadius = '10px';
      toast.style.fontWeight = '600';
      toast.style.boxShadow = '0 2px 8px rgba(41,121,255,0.13)';
      toast.style.zIndex = 9999;
      document.body.appendChild(toast);
      setTimeout(()=>toast.remove(), 2200);
    }
    // --- Tema oscuro CSS ---
    const darkThemeStyles = document.createElement('style');
    darkThemeStyles.innerHTML = `
      body.dark-theme { background: #181c22; color: #e3e8ef; }
      body.dark-theme .sidebar { background: #23272f; color: #e3e8ef; }
      body.dark-theme .sidebar a { color: #8a97ad; }
      body.dark-theme .sidebar a.active, body.dark-theme .sidebar a:hover { background: #223355; color: var(--primary-color, #22c8fa); font-weight: 600; }
      body.dark-theme .main-content { background: #181c22; }
      body.dark-theme .config-section { background: #23272f; color: #e3e8ef; }
      body.dark-theme .config-nav { background: #23272f; }
      body.dark-theme .form-input, body.dark-theme .form-select, body.dark-theme textarea { background: #23272f; color: #e3e8ef; border: 1px solid #3a3f4b; }
      body.dark-theme .form-label { color: #b0b8c1; }
      body.dark-theme .upload-btn, body.dark-theme .reset-btn { background: #23272f; color: #e3e8ef; border: 1px solid #3a3f4b; }
      body.dark-theme .reset-btn { background: #2d323c; color: #e3e8ef; border: 1px solid #4a5060; }
      body.dark-theme .reset-btn:hover { background: #3a4252; color: #22c8fa; border: 1px solid #22c8fa; }
      body.dark-theme .save-btn { background: #22c8fa; color: #fff; }
      body.dark-theme .save-btn:hover { background: #38b6ff; }
      body.dark-theme .logo-preview { border: 1px solid #3a3f4b; }
      body.dark-theme .info-text { color: #b0b8c1; }
      body.dark-theme table { background: #23272f; color: #e3e8ef; }
      body.dark-theme th, body.dark-theme td { border-color: #3a3f4b; }
    `;
    document.head.appendChild(darkThemeStyles);
    // --- Color primario CSS ---
    document.documentElement.style.setProperty('--primary-color', config.apariencia.colorPrimario);
    // Logo upload logic
    document.getElementById('logo-upload-btn').onclick = function() {
      document.getElementById('logo-input').click();
    };
    document.getElementById('logo-input').onchange = function(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.type.match('image.*')) { alert('Solo se permiten imágenes JPG o PNG'); return; }
      if (file.size > 2 * 1024 * 1024) { alert('El archivo debe ser menor a 2MB'); return; }
      const reader = new FileReader();
      reader.onload = function(evt) {
        document.getElementById('logo-preview').src = evt.target.result;
        config.empresa.logo = evt.target.result;
        saveConfig(config);
      };
      reader.readAsDataURL(file);
    };

function getToken() {
  return localStorage.getItem('token') || '';
}
function estadoColor(estado) {
  if (!estado) return '';
  return estado.trim().toLowerCase() === 'activo'
    ? '<span style="color:#43a047;font-weight:600;">Activo</span>'
    : '<span style="color:#f44336;font-weight:600;">Inactivo</span>';
}
function renderAcciones(id) {
  return `
    <button class="btn-editar" data-id="${id}" title="Editar" style="background:#e3f2fd;border:none;border-radius:6px;padding:6px 8px;margin-right:4px;cursor:pointer;"><i class="fa fa-pen" style="color:#2979ff;"></i></button>
    <button class="btn-reset" data-id="${id}" title="Cambiar contraseña" style="background:#fffde7;border:none;border-radius:6px;padding:6px 8px;margin-right:4px;cursor:pointer;"><i class="fa fa-key" style="color:#ffd600;"></i></button>
    <button class="btn-eliminar" data-id="${id}" title="Eliminar" style="background:#ffebee;border:none;border-radius:6px;padding:6px 8px;cursor:pointer;"><i class="fa fa-trash" style="color:#f44336;"></i></button>
  `;
}
let usuariosCache = [];
async function cargarUsuarios() {
  const tbody = document.getElementById('usuarios-tbody');
  tbody.innerHTML = '<tr><td colspan="5" style="padding:18px;text-align:center;color:#888;">Cargando usuarios...</td></tr>';
  
  const token = getToken();
  if (!token) {
    tbody.innerHTML = '<tr><td colspan="5" style="padding:18px;text-align:center;color:#f44336;">No hay token de autenticación. <a href="login.html" style="color:#2979ff;">Iniciar sesión</a></td></tr>';
    return;
  }
  
  try {
    const res = await fetch('http://localhost:3001/api/usuarios', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (res.status === 401) {
      tbody.innerHTML = '<tr><td colspan="5" style="padding:18px;text-align:center;color:#f44336;">Token inválido. <a href="login.html" style="color:#2979ff;">Reiniciar sesión</a></td></tr>';
      return;
    }
    
    if (!res.ok) {
      throw new Error(`Error ${res.status}: ${res.statusText}`);
    }
    
    const usuarios = await res.json();
    usuariosCache = usuarios;
    
    if (!usuarios.length) {
      tbody.innerHTML = '<tr><td colspan="5" style="padding:18px;text-align:center;color:#888;">No hay usuarios registrados.</td></tr>';
      return;
    }
    
    tbody.innerHTML = usuarios.map(u =>
      `<tr>
        <td style="padding:12px 8px;"><img src="${u.foto || 'img/default-user.png'}" alt="foto" style="width:36px;height:36px;border-radius:50%;object-fit:cover;"></td>
        <td style="padding:12px 8px;">${u.nombre}</td>
        <td style="padding:12px 8px;">${u.correo}</td>
        <td style="padding:12px 8px;">${u.rol}</td>
        <td style="padding:12px 8px;">${estadoColor(u.estado)}</td>
        <td style="padding:12px 8px;">${renderAcciones(u.id_usuario)}</td>
      </tr>`
    ).join('');
    
    // Asigna eventos a los botones
    document.querySelectorAll('.btn-editar').forEach(btn => btn.onclick = abrirModalEditar);
    document.querySelectorAll('.btn-reset').forEach(btn => btn.onclick = resetearPassword);
    document.querySelectorAll('.btn-eliminar').forEach(btn => btn.onclick = eliminarUsuario);
    
  } catch (e) {
    console.error('Error cargando usuarios:', e);
    tbody.innerHTML = `<tr><td colspan="5" style="padding:18px;text-align:center;color:#f44336;">
      Error al cargar usuarios: ${e.message}<br>
      <button onclick="cargarUsuarios()" style="background:#2979ff;color:#fff;border:none;border-radius:6px;padding:8px 16px;margin-top:8px;cursor:pointer;">Reintentar</button>
    </td></tr>`;
  }
}
// Modal Editar Usuario
const modalEditar = document.getElementById('modalEditarUsuario');
const closeEditar = document.getElementById('closeEditarUsuario');
const formEditar = document.getElementById('formEditarUsuario');
let usuarioEditando = null;
function abrirModalEditar(e) {
  const id = this.dataset.id;
  usuarioEditando = usuariosCache.find(u => u.id_usuario == id);
  if (!usuarioEditando) return;
  document.getElementById('edit-nombre').value = usuarioEditando.nombre;
  document.getElementById('edit-correo').value = usuarioEditando.correo;
  document.getElementById('edit-rol').value = usuarioEditando.rol;
  document.getElementById('edit-estado').value = usuarioEditando.estado;
  document.getElementById('edit-foto').value = usuarioEditando.foto || '';
  const preview = document.getElementById('edit-foto-preview');
  if (usuarioEditando.foto) {
    preview.src = usuarioEditando.foto;
    preview.style.display = 'inline-block';
  } else {
    preview.style.display = 'none';
  }
  // Limpia el input file para evitar que se quede el archivo anterior
  document.getElementById('edit-foto-file').value = '';
  modalEditar.style.display = 'flex';
}
closeEditar.onclick = () => { modalEditar.style.display = 'none'; };
formEditar.onsubmit = async function(e) {
  e.preventDefault();
  if (!usuarioEditando) return;
  const nombre = document.getElementById('edit-nombre').value.trim();
  const correo = document.getElementById('edit-correo').value.trim();
  const rol = document.getElementById('edit-rol').value;
  const estado = document.getElementById('edit-estado').value;
  const foto = document.getElementById('edit-foto').value;
  try {
    console.log({ nombre, correo, rol, estado, foto });
    const res = await fetch(`http://localhost:3001/api/usuarios/${usuarioEditando.id_usuario}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${getToken()}` },
      body: JSON.stringify({ nombre, correo, rol, estado, foto })
    });
    if (!res.ok) throw new Error('Error al actualizar usuario');
    modalEditar.style.display = 'none';
    await cargarUsuarios();
    alert('Usuario actualizado correctamente');
  } catch (err) {
    alert('Error al actualizar usuario');
  }
};
window.onclick = function(e) {
  if (e.target === modalEditar) modalEditar.style.display = 'none';
  if (e.target === modalAgregar) modalAgregar.style.display = 'none';
};
// Resetear contraseña
async function resetearPassword() {
  const id = this.dataset.id;
  const usuario = usuariosCache.find(u => u.id_usuario == id);
  if (!usuario) return;
  // Aquí podrías hacer una petición real para resetear la contraseña
  alert(`Se ha enviado un correo para resetear la contraseña de ${usuario.nombre}`);
}
// Eliminar usuario
async function eliminarUsuario() {
  const id = this.dataset.id;
  const usuario = usuariosCache.find(u => u.id_usuario == id);
  if (!usuario) return;
  if (!confirm('¿Eliminar usuario?')) return;
  try {
    const res = await fetch(`http://localhost:3001/api/usuarios/${usuario.id_usuario}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${getToken()}` }
    });
    if (!res.ok) throw new Error('Error al eliminar usuario');
    await cargarUsuarios();
    alert('Usuario eliminado correctamente');
  } catch (err) {
    alert('Error al eliminar usuario');
  }
}
document.addEventListener('DOMContentLoaded', cargarUsuarios);
document.addEventListener('DOMContentLoaded', function() {
  // Asigna el evento onchange al input file de editar usuario
  var editFotoFile = document.getElementById('edit-foto-file');
  if (editFotoFile) {
    editFotoFile.onchange = function(e) {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.type.match('image.*')) {
        alert('Solo se permiten imágenes');
        return;
      }
      const reader = new FileReader();
      reader.onload = async function(evt) {
        try {
          const resizedDataUrl = await resizeImage(evt.target.result);
          document.getElementById('edit-foto').value = resizedDataUrl;
          document.getElementById('edit-foto-preview').src = resizedDataUrl;
          document.getElementById('edit-foto-preview').style.display = 'inline-block';
        } catch (resizeError) {
          alert(resizeError.message);
          e.target.value = ''; // Limpiar el input de archivo
          // Revertir al valor original si la nueva imagen falla
          document.getElementById('edit-foto').value = usuarioEditando.foto || '';
          document.getElementById('edit-foto-preview').src = usuarioEditando.foto || 'img/default-user.png';
        }
      };
      reader.readAsDataURL(file);
    };
  }
});
  </script>
</body>
</html>